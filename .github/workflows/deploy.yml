name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (all for all services)'
        required: false
        default: 'all'
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.services.outputs.list }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub (if configured)
        if: ${{ secrets.DOCKERHUB_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Determine services to build
        id: services
        run: |
          if [ "${{ github.event.inputs.service }}" = "all" ] || [ -z "${{ github.event.inputs.service }}" ]; then
            echo "list=dashboard,discord-bot,stream-bot" >> $GITHUB_OUTPUT
          else
            echo "list=${{ github.event.inputs.service }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Build Dashboard
        if: contains(steps.services.outputs.list, 'dashboard') || contains(steps.services.outputs.list, 'all')
        uses: docker/build-push-action@v5
        with:
          context: ./services/dashboard
          file: ./services/dashboard/Dockerfile
          tags: homelab-dashboard:${{ github.sha }},homelab-dashboard:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: false
          load: true
      
      - name: Build Discord Bot
        if: contains(steps.services.outputs.list, 'discord-bot') || contains(steps.services.outputs.list, 'all')
        uses: docker/build-push-action@v5
        with:
          context: ./services/discord-bot
          file: ./services/discord-bot/server/docker/Dockerfile
          tags: discord-bot:${{ github.sha }},discord-bot:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: false
          load: true
      
      - name: Build Stream Bot
        if: contains(steps.services.outputs.list, 'stream-bot') || contains(steps.services.outputs.list, 'all')
        uses: docker/build-push-action@v5
        with:
          context: ./services/stream-bot
          file: ./services/stream-bot/Dockerfile
          tags: stream-bot:${{ github.sha }},stream-bot:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: false
          load: true
      
      - name: Save built images
        run: |
          mkdir -p /tmp/images
          docker save homelab-dashboard:${{ github.sha }} > /tmp/images/dashboard.tar || true
          docker save discord-bot:${{ github.sha }} > /tmp/images/discord-bot.tar || true
          docker save stream-bot:${{ github.sha }} > /tmp/images/stream-bot.tar || true
      
      - name: Upload images as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images-${{ github.sha }}
          path: /tmp/images/
          retention-days: 1
  
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    if: false  # Disabled for MVP - enable when tests are added
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images-${{ github.sha }}
          path: /tmp/images
      
      - name: Load images
        run: |
          docker load < /tmp/images/dashboard.tar || true
          docker load < /tmp/images/discord-bot.tar || true
          docker load < /tmp/images/stream-bot.tar || true
      
      - name: Run tests
        run: |
          # Add test commands here when tests are available
          echo "Tests would run here"
  
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.environment == 'staging' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment:
      name: staging
      url: https://staging.evindrake.net
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images-${{ github.sha }}
          path: /tmp/images
      
      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /home/evin/contain/HomeLabHub-staging
            git pull origin main
            ./scripts/deploy.sh ${{ github.event.inputs.service || 'all' }}
      
      - name: Run health checks
        run: |
          echo "Health checks would run against staging environment"
          # Add health check commands here
  
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://evindrake.net
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download images
        uses: actions/download-artifact@v4
        with:
          name: docker-images-${{ github.sha }}
          path: /tmp/images
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Create pre-deployment backup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /home/evin/contain/HomeLabHub
            ./scripts/backup-config.sh "github-actions-$(date +%Y%m%d-%H%M%S)"
      
      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /home/evin/contain/HomeLabHub
            git pull origin main
            ./scripts/deploy.sh ${{ github.event.inputs.service || 'all' }}
          command_timeout: 20m
      
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /home/evin/contain/HomeLabHub
            ./scripts/health-check.sh ${{ github.event.inputs.service || '' }}
      
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /home/evin/contain/HomeLabHub
            echo "Deployment failed - triggering automatic rollback"
            # Rollback is handled automatically by deploy.sh when health checks fail
      
      - name: Notify on success
        if: success()
        run: |
          echo "✅ Deployment to production completed successfully"
          # Add notification webhook here (Discord, Slack, etc.)
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment to production failed and was rolled back"
          # Add notification webhook here
  
  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always()
    
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v2
        with:
          name: docker-images-${{ github.sha }}
