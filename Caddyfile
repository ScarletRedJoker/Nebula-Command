# Homelab Caddyfile - Auto SSL with Let's Encrypt
# DNS Records Required: See DNS_SETUP_GUIDE.md for details
# Last Updated: 2025-11-19

{
        email evin@evindrake.net
}

# ============================================
# Discord Ticket Bot
# ============================================
bot.rig-city.com {
    reverse_proxy discord-bot:4000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }
}

# ============================================
# Stream Bot (SnappleBotAI)
# ============================================
stream.rig-city.com {
    reverse_proxy stream-bot:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }
}

# ============================================
# Rig City Community Website
# ============================================
rig-city.com {
    reverse_proxy rig-city-site:80
}

www.rig-city.com {
    redir https://rig-city.com{uri} permanent
}

# ============================================
# Plex Media Server (Docker)
# ============================================
plex.evindrake.net {
    reverse_proxy plex-server:32400 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        
        # WebSocket support for Plex Companion/remote features
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }
}

# ============================================
# n8n Automation Platform - ADMIN SERVICE
# ============================================
n8n.evindrake.net {
    # NOTE: Rate limiting requires Caddy plugin (github.com/mholt/caddy-ratelimit)
    # To enable, rebuild Caddy with: xcaddy build --with github.com/mholt/caddy-ratelimit
    # Then uncomment the following:
    # rate_limit {
    #     zone n8n {
    #         key {remote_host}
    #         events 30
    #         window 1m
    #     }
    # }
    
    reverse_proxy n8n:5678
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

# ============================================
# Homelab Dashboard (Main Control Panel) - ADMIN SERVICE
# ============================================
host.evindrake.net, dashboard.evindrake.net {
    # NOTE: Rate limiting requires Caddy plugin (github.com/mholt/caddy-ratelimit)
    # To enable, rebuild Caddy with: xcaddy build --with github.com/mholt/caddy-ratelimit
    # Then uncomment the following:
    # @login {
    #     path /login /api/auth/*
    # }
    # rate_limit @login {
    #     zone dashboard_auth {
    #         key {remote_host}
    #         events 10
    #         window 5m
    #     }
    # }
    # rate_limit {
    #     zone dashboard {
    #         key {remote_host}
    #         events 100
    #         window 1m
    #     }
    # }
    
    reverse_proxy homelab-dashboard:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        
        # CRITICAL: Disable all caching for dashboard routes
        header_down Cache-Control "no-cache, no-store, must-revalidate, private"
        header_down Pragma "no-cache"
        header_down Expires "0"
    }
    
    # Enhanced security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

# ============================================
# VNC Remote Desktop - HOST-BASED (Not Docker Container)
# ============================================
# Uses TigerVNC + noVNC running directly on the Ubuntu host
# Much faster and provides access to the real desktop environment
vnc.evindrake.net {
    # SECURITY: VNC is protected by:
    # - VNC password (set via vncpasswd)
    # - Ubuntu host Fail2Ban
    # - Optional: Uncomment VPN block below for IP restriction
    
    # @vpn_only {
    #     remote_ip 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 100.64.0.0/10
    # }
    # handle @vpn_only {
    #     reverse_proxy 172.17.0.1:6080 { ... }
    # }
    # handle {
    #     respond "â›” VPN Access Required" 403
    # }
    
    # Route to host noVNC (172.17.0.1 = Docker bridge gateway = host)
    reverse_proxy 172.17.0.1:6080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        
        # WebSocket support for noVNC - CRITICAL for VNC connection
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "no-referrer"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

# ============================================
# Code Server (VS Code in Browser) - VPN ONLY ACCESS
# ============================================
code.evindrake.net {
    # Proxy to nginx sidecar which handles X-Frame-Options header removal
    # Chain: Caddy -> nginx (proxy) -> code-server
    reverse_proxy http://code-server-proxy:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }
    
    # Additional security headers (nginx handles X-Frame-Options)
    header {
        X-Content-Type-Options "nosniff"
        Referrer-Policy "same-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

# ============================================
# Game Streaming Connection Page
# ============================================
game.evindrake.net {
    handle / {
        redir /game-connect permanent
    }
    reverse_proxy homelab-dashboard:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        
        # Disable caching for game connection page
        header_down Cache-Control "no-cache, no-store, must-revalidate"
        header_down Pragma "no-cache"
        header_down Expires "0"
    }
}

# ============================================
# Scarlet Red Joker Personal Website
# ============================================
scarletredjoker.com {
    reverse_proxy scarletredjoker-web:80
}

www.scarletredjoker.com {
    redir https://scarletredjoker.com{uri} permanent
}

# ============================================
# Home Assistant - Smart Home Hub
# ============================================
home.evindrake.net {
    reverse_proxy homeassistant:8123 {
        # WebSocket support for Home Assistant
        header_up Upgrade {>Upgrade}
        header_up Connection {>Connection}
        
        # Preserve original request info for Home Assistant
        header_up X-Forwarded-Host {host}
        
        # Increase timeout for long-polling connections
        transport http {
            read_timeout 90s
            write_timeout 90s
        }
    }
}
