# Homelab Caddyfile - Auto SSL with Let's Encrypt
# DNS Records Required: See DNS_SETUP_GUIDE.md for details
# Last Updated: 2025-11-15

{
    email evin@evindrake.net
    
    # Explicit automation policy to force certificate generation for all domains
    acme_ca https://acme-v02.api.letsencrypt.org/directory
    
    on_demand_tls {
        ask https://host.evindrake.net/api/caddy/allow
        interval 2m
        burst 5
    }
}

# ============================================
# Discord Ticket Bot
# ============================================
bot.rig-city.com {
    reverse_proxy discord-bot:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
    }
}

# ============================================
# Stream Bot (SnappleBotAI)
# ============================================
stream.rig-city.com {
    reverse_proxy stream-bot:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
    }
}

# ============================================
# Rig City Community Website
# ============================================
rig-city.com {
    reverse_proxy rig-city-site:80
}

www.rig-city.com {
    redir https://rig-city.com{uri} permanent
}

# ============================================
# Plex Media Server
# ============================================
plex.evindrake.net {
    reverse_proxy plex-server:32400
}

# ============================================
# n8n Automation Platform
# ============================================
n8n.evindrake.net {
    reverse_proxy n8n:5678
}

# ============================================
# Homelab Dashboard (Main Control Panel)
# ============================================
host.evindrake.net {
    reverse_proxy homelab-dashboard:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # CRITICAL: Disable all caching for dashboard routes
        header_down Cache-Control "no-cache, no-store, must-revalidate, private"
        header_down Pragma "no-cache"
        header_down Expires "0"
    }
}

# ============================================
# VNC Remote Desktop
# ============================================
vnc.evindrake.net {
    reverse_proxy vnc-desktop:80
}

# ============================================
# Code Server (VS Code in Browser)
# ============================================
code.evindrake.net {
    reverse_proxy code-server:8080 {
        # Standard proxy headers
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Port {server_port}
        
        # WebSocket support - CRITICAL for code-server
        header_up Upgrade {>Upgrade}
        header_up Connection {>Connection}
        
        # Timeouts for long-running connections
        transport http {
            read_timeout 3600s
            write_timeout 3600s
            dial_timeout 30s
        }
        
        # Flush responses immediately for real-time updates
        flush_interval -1
    }
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Disable caching for dynamic content
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
    }
    
    # Enable detailed logging for troubleshooting
    log {
        output file /var/log/caddy/code-server-access.log
        format json
    }
}

# ============================================
# Game Streaming Connection Page
# ============================================
game.evindrake.net {
    handle / {
        redir /game-connect permanent
    }
    reverse_proxy homelab-dashboard:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # Disable caching for game connection page
        header_down Cache-Control "no-cache, no-store, must-revalidate"
        header_down Pragma "no-cache"
        header_down Expires "0"
    }
}

# ============================================
# Scarlet Red Joker Personal Website
# ============================================
scarletredjoker.com {
    reverse_proxy scarletredjoker-web:80
}

www.scarletredjoker.com {
    redir https://scarletredjoker.com{uri} permanent
}

# ============================================
# Home Assistant - Smart Home Hub
# ============================================
home.evindrake.net {
    reverse_proxy homeassistant:8123 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # WebSocket support for Home Assistant
        header_up Upgrade {>Upgrade}
        header_up Connection {>Connection}
    }
}
