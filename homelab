#!/bin/bash

# ╔════════════════════════════════════════════════════════════════╗
# ║              HOMELAB UNIFIED CONTROL - FINAL FIX              ║
# ║                   NO ENV RESET - JUST WORKS                   ║
# ╚════════════════════════════════════════════════════════════════╝

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

# Configuration
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Service list
ALL_SERVICES=(
    "homelab-postgres" "homelab-redis" "homelab-minio"
    "homelab-dashboard" "homelab-celery-worker"
    "discord-bot" "stream-bot"
    "caddy" "vnc-desktop" "code-server"
    "plex-server" "n8n" "homeassistant"
    "rig-city-site" "scarletredjoker-web"
)

# ============================================
# CORE FUNCTIONS
# ============================================
is_service_running() {
    docker ps --format "{{.Names}}" 2>/dev/null | grep -q "^$1$"
}

get_running_count() {
    local count=0
    for service in "${ALL_SERVICES[@]}"; do
        is_service_running "$service" && ((count++))
    done
    echo $count
}

# ============================================
# FIX COMMAND - THE REAL SOLUTION
# ============================================
fix_all_issues() {
    echo -e "${CYAN}╔════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║     FIXING WITHOUT TOUCHING .ENV      ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════╝${NC}"
    echo ""
    
    # Check if .env exists
    if [ ! -f .env ]; then
        echo -e "${RED}No .env file found!${NC}"
        echo "Run: ./homelab env"
        exit 1
    fi
    
    echo -e "${CYAN}[1/3] Force recreating services to load environment...${NC}"
    # THE KEY FIX: Force recreate containers to load the .env file
    docker compose --env-file .env up -d --force-recreate
    
    echo -e "${CYAN}[2/3] Waiting for services to stabilize...${NC}"
    sleep 10
    
    echo -e "${CYAN}[3/3] Checking databases...${NC}"
    if docker exec homelab-postgres pg_isready -U postgres &>/dev/null; then
        # Create databases if missing (using correct syntax)
        for db in ticketbot streambot homelab_jarvis; do
            if ! docker exec homelab-postgres psql -U postgres -lqt 2>/dev/null | cut -d \| -f 1 | grep -qw "$db"; then
                echo "  Creating database $db..."
                docker exec homelab-postgres psql -U postgres -c "CREATE DATABASE $db;" 2>/dev/null || true
            fi
        done
        echo -e "${GREEN}✓ Databases ready${NC}"
    fi
    
    # Clean dangling images
    local dangling=$(docker images -f "dangling=true" -q 2>/dev/null | wc -l)
    if [ "$dangling" -gt 0 ]; then
        docker rmi $(docker images -f "dangling=true" -q) 2>/dev/null || true
        echo -e "${GREEN}✓ Cleaned $dangling dangling images${NC}"
    fi
    
    # Final status
    local count=$(get_running_count)
    echo ""
    if [ $count -eq 15 ]; then
        echo -e "${GREEN}✅ SUCCESS! All 15/15 services running!${NC}"
    else
        echo -e "${YELLOW}⚠ $count/15 services running${NC}"
        echo "Check logs: ./homelab logs [service]"
    fi
}

# ============================================
# SMART ENV SETUP (only prompts for missing)
# ============================================
setup_env() {
    echo -e "${CYAN}Checking environment...${NC}"
    
    # If .env exists, check what's missing
    if [ -f .env ]; then
        # Source it to check variables
        source .env
        
        # Only check truly critical variables
        local missing=()
        [ -z "${OPENAI_API_KEY:-}" ] && missing+=("OPENAI_API_KEY")
        [ -z "${POSTGRES_PASSWORD:-}" ] && [ -z "${DATABASE_URL:-}" ] && missing+=("POSTGRES_PASSWORD")
        [ -z "${WEB_USERNAME:-}" ] && missing+=("WEB_USERNAME") 
        [ -z "${WEB_PASSWORD:-}" ] && missing+=("WEB_PASSWORD")
        
        if [ ${#missing[@]} -eq 0 ]; then
            echo -e "${GREEN}✓ All required variables present${NC}"
            return 0
        fi
        
        echo -e "${YELLOW}Missing: ${missing[*]}${NC}"
        echo "Adding only missing variables..."
        
        # Add only what's missing
        for var in "${missing[@]}"; do
            case "$var" in
                POSTGRES_PASSWORD)
                    local pass=$(openssl rand -base64 32 2>/dev/null || echo "homelab-$(date +%s)")
                    echo "POSTGRES_PASSWORD=$pass" >> .env
                    echo "DATABASE_URL=postgresql://postgres:$pass@homelab-postgres:5432/homelab" >> .env
                    echo -e "${GREEN}✓ Generated database credentials${NC}"
                    ;;
                WEB_USERNAME)
                    echo -e "Enter dashboard username: "
                    read -r username
                    echo "WEB_USERNAME=$username" >> .env
                    ;;
                WEB_PASSWORD)
                    echo -e "Enter dashboard password: "
                    read -r password
                    echo "WEB_PASSWORD=$password" >> .env
                    ;;
                OPENAI_API_KEY)
                    echo -e "Enter OpenAI API key: "
                    read -r key
                    echo "OPENAI_API_KEY=$key" >> .env
                    ;;
            esac
        done
    else
        # No .env - create minimal required
        echo -e "${YELLOW}Creating new .env with essentials...${NC}"
        
        # Copy example if available
        [ -f .env.example ] && cp .env.example .env || touch .env
        
        # Get OpenAI key
        echo -n "Enter OpenAI API key: "
        read -r openai_key
        echo "OPENAI_API_KEY=$openai_key" >> .env
        
        # Generate database
        local pass=$(openssl rand -base64 32 2>/dev/null || echo "homelab-$(date +%s)")
        echo "POSTGRES_PASSWORD=$pass" >> .env
        echo "DATABASE_URL=postgresql://postgres:$pass@homelab-postgres:5432/homelab" >> .env
        
        # Dashboard login
        echo -n "Enter dashboard username: "
        read -r username
        echo "WEB_USERNAME=$username" >> .env
        
        echo -n "Enter dashboard password: "
        read -r password  
        echo "WEB_PASSWORD=$password" >> .env
        
        echo -e "${GREEN}✓ Environment created${NC}"
    fi
}

# ============================================
# STATUS DISPLAY  
# ============================================
show_status() {
    echo -e "\n${CYAN}═══ Service Status ═══${NC}\n"
    
    local running=0
    local stopped=0
    
    for service in "${ALL_SERVICES[@]}"; do
        if is_service_running "$service"; then
            printf "%-25s ${GREEN}● Running${NC}\n" "$service"
            ((running++))
        else
            printf "%-25s ${RED}○ Stopped${NC}\n" "$service"
            ((stopped++))
        fi
    done
    
    echo -e "\n${BOLD}Summary:${NC}"
    if [ $running -eq 15 ]; then
        echo -e "  ${GREEN}✅ All 15/15 services running!${NC}"
    else
        echo -e "  ${YELLOW}⚠ Only $running/15 services running${NC}"
        [ $stopped -gt 0 ] && echo -e "  ${RED}   $stopped services stopped${NC}"
    fi
    
    # Check for issues
    local dangling=$(docker images -f "dangling=true" -q 2>/dev/null | wc -l)
    [ "$dangling" -gt 0 ] && echo -e "  ${YELLOW}⚠ $dangling dangling images${NC}"
}

# ============================================
# DEPLOY WITH FORCE RECREATE
# ============================================
deploy_all() {
    echo -e "${CYAN}Deploying all services...${NC}"
    
    # Ensure env exists
    setup_env
    
    # Build if requested
    if [ "${1:-}" == "--build" ]; then
        docker compose build
    fi
    
    # THE KEY: Force recreate to load environment
    docker compose --env-file .env up -d --force-recreate
    
    sleep 10
    show_status
}

# ============================================
# MAIN HANDLER
# ============================================
main() {
    # Check Docker
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}Docker not installed!${NC}"
        exit 1
    fi
    
    case "${1:-help}" in
        fix)
            fix_all_issues
            ;;
        status)
            show_status
            ;;
        start|deploy)
            deploy_all --build
            ;;
        env)
            setup_env
            ;;
        logs)
            shift
            docker compose logs -f --tail=100 "$@"
            ;;
        restart)
            # Force recreate to reload environment
            shift
            if [ $# -eq 0 ]; then
                docker compose --env-file .env up -d --force-recreate
            else
                docker compose --env-file .env up -d --force-recreate "$@"
            fi
            ;;
        stop)
            docker compose down
            ;;
        help|*)
            cat << EOF
${CYAN}HomeLabHub Control${NC}

Usage: $0 [command]

Commands:
  ${GREEN}fix${NC}      - Fix everything (force reload env)
  ${GREEN}status${NC}   - Show what's running  
  ${GREEN}start${NC}    - Deploy all services
  ${GREEN}env${NC}      - Setup environment (only missing vars)
  ${GREEN}logs${NC}     - View logs
  ${GREEN}restart${NC}  - Restart with env reload
  ${GREEN}stop${NC}     - Stop everything

THE FIX: Your .env is perfect but Docker cached old empty environment.
Run: $0 fix

This forces Docker to recreate containers with your existing .env values.
EOF
            ;;
    esac
}

main "$@"