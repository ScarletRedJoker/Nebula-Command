#!/bin/bash
# ╔════════════════════════════════════════════════════════════════╗
# ║              HOMELAB - SIMPLE & WORKING                       ║
# ╚════════════════════════════════════════════════════════════════╝

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Auto-detect project root
if [ -d "/home/evin/contain/HomeLabHub" ]; then
    # On Ubuntu server
    PROJECT_ROOT="/home/evin/contain/HomeLabHub"
else
    # In development/Replit
    PROJECT_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
fi

ENV_FILE="$PROJECT_ROOT/.env"
COMPOSE_FILE="$PROJECT_ROOT/docker-compose.yml"

echo -e "${CYAN}Project Root: $PROJECT_ROOT${NC}"

# Verify files exist
if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}ERROR: .env file not found at $ENV_FILE${NC}"
    echo "Run this script from your Ubuntu server at /home/evin/contain/HomeLabHub"
    exit 1
fi

if [ ! -f "$COMPOSE_FILE" ]; then
    echo -e "${RED}ERROR: docker-compose.yml not found at $COMPOSE_FILE${NC}"
    exit 1
fi

# Docker Compose command with ABSOLUTE PATHS
compose() {
    docker compose \
        --project-directory "$PROJECT_ROOT" \
        --env-file "$ENV_FILE" \
        -f "$COMPOSE_FILE" \
        "$@"
}

# Service list
ALL_SERVICES=(
    "homelab-postgres" "homelab-redis" "homelab-minio"
    "homelab-dashboard" "homelab-celery-worker"
    "discord-bot" "stream-bot"
    "caddy" "vnc-desktop" "code-server"
    "plex-server" "n8n" "homeassistant"
    "rig-city-site" "scarletredjoker-web"
)

# Check if service is running
is_running() {
    docker ps --format "{{.Names}}" | grep -q "^$1$"
}

# Count running services
count_running() {
    local count=0
    for service in "${ALL_SERVICES[@]}"; do
        is_running "$service" && ((count++))
    done
    echo $count
}

# ============================================
# FIX COMMAND - Simple and Effective
# ============================================
fix() {
    echo -e "${CYAN}═══ FIXING HOMELAB ═══${NC}\n"
    
    echo "Project: $PROJECT_ROOT"
    echo "Env File: $ENV_FILE"
    echo ""
    
    # Force recreate ALL containers with correct environment
    echo -e "${CYAN}[1/3] Force recreating all services with environment...${NC}"
    compose up -d --force-recreate
    
    echo -e "${CYAN}[2/3] Waiting for stability...${NC}"
    sleep 10
    
    # Create databases if PostgreSQL is ready
    echo -e "${CYAN}[3/3] Setting up databases...${NC}"
    if docker exec homelab-postgres pg_isready -U postgres &>/dev/null; then
        for db in ticketbot streambot homelab_jarvis; do
            if ! docker exec homelab-postgres psql -U postgres -lqt 2>/dev/null | cut -d \| -f 1 | grep -qw "$db"; then
                echo "  Creating database: $db"
                docker exec homelab-postgres psql -U postgres -c "CREATE DATABASE $db;" 2>/dev/null || true
            fi
        done
        echo -e "${GREEN}✓ Databases ready${NC}"
    fi
    
    # Status
    local running=$(count_running)
    echo ""
    if [ $running -eq 15 ]; then
        echo -e "${GREEN}✅ SUCCESS! All 15/15 services running!${NC}"
    else
        echo -e "${YELLOW}⚠ $running/15 services running${NC}"
        echo "Check logs: ./homelab logs"
    fi
}

# ============================================
# STATUS COMMAND
# ============================================
status() {
    echo -e "\n${CYAN}═══ Service Status ═══${NC}\n"
    
    local running=0
    for service in "${ALL_SERVICES[@]}"; do
        if is_running "$service"; then
            echo -e "$service: ${GREEN}● Running${NC}"
            ((running++))
        else
            echo -e "$service: ${RED}○ Stopped${NC}"
        fi
    done
    
    echo ""
    if [ $running -eq 15 ]; then
        echo -e "${GREEN}✅ All 15/15 services running${NC}"
    else
        echo -e "${YELLOW}⚠ $running/15 services running${NC}"
    fi
}

# ============================================
# LOGS COMMAND with Auto-Save
# ============================================
logs() {
    mkdir -p "$PROJECT_ROOT/logs"
    local timestamp=$(date +%Y%m%d-%H%M%S)
    
    if [ $# -eq 0 ]; then
        # All services
        echo -e "${CYAN}Showing logs for all services...${NC}"
        compose logs --tail=100 -f | tee "$PROJECT_ROOT/logs/all-services-$timestamp.log"
    else
        # Specific service
        echo -e "${CYAN}Showing logs for $1...${NC}"
        compose logs --tail=100 -f "$1" | tee "$PROJECT_ROOT/logs/$1-$timestamp.log"
    fi
}

# ============================================
# DEBUG COMMAND - Show What Docker Sees
# ============================================
debug() {
    echo -e "${CYAN}═══ Debug Information ═══${NC}\n"
    
    echo "Project Root: $PROJECT_ROOT"
    echo "Current Dir: $(pwd)"
    echo ""
    
    echo -e "${CYAN}Checking .env file:${NC}"
    if [ -f "$ENV_FILE" ]; then
        echo -e "${GREEN}✓ .env exists${NC}"
        echo "  Variables loaded:"
        grep -c "=" "$ENV_FILE" | xargs echo "  "
        echo ""
        echo "  Checking critical variables:"
        grep "^WEB_USERNAME=" "$ENV_FILE" || echo -e "  ${RED}✗ WEB_USERNAME missing${NC}"
        grep "^WEB_PASSWORD=" "$ENV_FILE" || echo -e "  ${RED}✗ WEB_PASSWORD missing${NC}"
        grep "^POSTGRES_PASSWORD=" "$ENV_FILE" || echo -e "  ${RED}✗ POSTGRES_PASSWORD missing${NC}"
    else
        echo -e "${RED}✗ .env NOT FOUND${NC}"
    fi
    
    echo ""
    echo -e "${CYAN}Checking homelab-dashboard container environment:${NC}"
    if is_running "homelab-dashboard"; then
        echo "  WEB_USERNAME in container:"
        docker exec homelab-dashboard env | grep "WEB_USERNAME" || echo -e "  ${RED}✗ NOT SET${NC}"
        echo "  POSTGRES_PASSWORD in container:"
        docker exec homelab-dashboard env | grep "POSTGRES_PASSWORD" || echo -e "  ${RED}✗ NOT SET${NC}"
    else
        echo -e "${YELLOW}  Dashboard not running${NC}"
    fi
    
    echo ""
    echo -e "${CYAN}Service Status:${NC}"
    status
}

# ============================================
# MAIN
# ============================================
case "${1:-help}" in
    fix|start)
        fix
        ;;
    status)
        status
        ;;
    logs)
        shift
        logs "$@"
        ;;
    debug)
        debug
        ;;
    restart)
        echo "Restarting all services..."
        compose restart
        ;;
    stop)
        compose down
        echo -e "${GREEN}✓ All services stopped${NC}"
        ;;
    help|*)
        cat << 'EOF'
╔════════════════════════════════════════════════════════╗
║           HOMELAB - Simple Management                  ║
╚════════════════════════════════════════════════════════╝

Usage: ./homelab [command]

Commands:
  fix      - Fix everything and start all services
  status   - Show which services are running  
  logs     - View logs (add service name for specific)
  debug    - Show detailed debugging info
  restart  - Restart all services
  stop     - Stop everything

Examples:
  ./homelab fix                    # Fix all issues
  ./homelab status                 # Check what's running
  ./homelab logs homelab-dashboard # View dashboard logs
  ./homelab debug                  # Debug environment issues

The key: This script uses ABSOLUTE PATHS so Docker finds
your .env file and configurations correctly.

Run on your Ubuntu server at: /home/evin/contain/HomeLabHub
EOF
        ;;
esac