#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘         HOMELAB UNIFIED MANAGEMENT SYSTEM v2.0                â•‘
# â•‘     Single tool for setup, management, diagnostics & dev      â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Configuration
SCRIPT_VERSION="2.0.0"
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_NAME="HomeLabHub"
LOG_DIR="/tmp/homelab-logs"
BACKUP_DIR="/tmp/homelab-backups"

# Ensure we're in the right directory
cd "$SCRIPT_DIR"

# Load environment if exists
if [ -f .env ]; then
    set -a
    source .env
    set +a
fi

# ============================================
# Helper Functions
# ============================================

print_header() {
    echo -e "\n${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC} ${BOLD}$1${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

print_section() {
    echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
}

print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

print_error() {
    echo -e "${RED}âœ— $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš  $1${NC}"
}

print_info() {
    echo -e "${CYAN}â„¹ $1${NC}"
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        print_error "Docker is not installed!"
        exit 1
    fi
    if ! docker compose version &> /dev/null; then
        print_error "Docker Compose is not installed!"
        exit 1
    fi
}

check_requirements() {
    local missing_deps=()
    
    for cmd in git curl jq; do
        if ! command -v $cmd &> /dev/null; then
            missing_deps+=($cmd)
        fi
    done
    
    if [ ${#missing_deps[@]} -gt 0 ]; then
        print_warning "Missing dependencies: ${missing_deps[*]}"
        echo "Install with: apt-get install -y ${missing_deps[*]}"
        return 1
    fi
    return 0
}

# ============================================
# Deployment Functions
# ============================================

deploy_fresh() {
    print_section "Fresh Deployment"
    
    # Cleanup
    docker compose down --remove-orphans 2>/dev/null || true
    docker volume prune -f 2>/dev/null || true
    docker network prune -f 2>/dev/null || true
    
    # Build all services
    print_info "Building all services..."
    docker compose build --no-cache
    
    # Deploy in order
    deploy_services_ordered
}

deploy_quick() {
    print_section "Quick Deployment (with cache)"
    
    docker compose down
    docker compose build
    deploy_services_ordered
}

deploy_services_ordered() {
    print_info "Starting core infrastructure..."
    docker compose up -d homelab-postgres homelab-redis homelab-minio
    
    wait_for_service "homelab-postgres" "pg_isready -U postgres"
    wait_for_service "homelab-redis" "redis-cli ping"
    
    print_info "Starting application services..."
    docker compose up -d homelab-dashboard homelab-celery-worker
    
    print_info "Starting all remaining services..."
    docker compose up -d
    
    print_success "Deployment complete!"
}

# ============================================
# Service Management
# ============================================

start_services() {
    print_section "Starting Services"
    docker compose up -d
    print_success "All services started"
}

stop_services() {
    print_section "Stopping Services"
    docker compose down
    print_success "All services stopped"
}

restart_service() {
    local service=$1
    if [ -z "$service" ]; then
        echo "Available services:"
        docker compose ps --services
        echo -n "Enter service name: "
        read service
    fi
    
    print_info "Restarting $service..."
    docker compose restart $service
    print_success "$service restarted"
}

view_logs() {
    local service=$1
    if [ -z "$service" ]; then
        echo "Available services:"
        docker compose ps --services
        echo -n "Enter service name (or 'all'): "
        read service
    fi
    
    if [ "$service" = "all" ]; then
        docker compose logs -f
    else
        docker compose logs -f $service
    fi
}

# ============================================
# Diagnostics
# ============================================

health_check() {
    print_section "Health Check"
    
    local failed=0
    
    # Check each service
    for service in $(docker compose ps --services); do
        if docker ps --format "{{.Names}}" | grep -q "^${service}$"; then
            local status=$(docker inspect --format='{{.State.Running}}' $service 2>/dev/null)
            if [ "$status" = "true" ]; then
                print_success "$service: Running"
            else
                print_error "$service: Not Running"
                ((failed++))
            fi
        else
            print_error "$service: Not Found"
            ((failed++))
        fi
    done
    
    # Test specific services
    echo ""
    test_jarvis_ai
    test_database
    test_redis
    
    if [ $failed -eq 0 ]; then
        print_success "All services healthy!"
    else
        print_warning "$failed service(s) need attention"
    fi
}

test_jarvis_ai() {
    echo -n "Testing Jarvis AI: "
    if docker exec homelab-dashboard python -c "
import os, requests
api_key = os.environ.get('OPENAI_API_KEY', '')
if api_key:
    resp = requests.post('https://api.openai.com/v1/chat/completions',
        headers={'Authorization': f'Bearer {api_key}', 'Content-Type': 'application/json'},
        json={'model': 'gpt-3.5-turbo', 'messages': [{'role': 'user', 'content': 'test'}], 'max_tokens': 5},
        timeout=5)
    exit(0 if resp.status_code == 200 else 1)
else:
    exit(1)
" 2>/dev/null; then
        print_success "Working"
    else
        print_error "Failed (check API key)"
    fi
}

test_database() {
    echo -n "Testing Database: "
    if docker exec homelab-postgres pg_isready -U postgres >/dev/null 2>&1; then
        print_success "Connected"
    else
        print_error "Not responding"
    fi
}

test_redis() {
    echo -n "Testing Redis: "
    if docker exec homelab-redis redis-cli ping 2>/dev/null | grep -q PONG; then
        print_success "Responding"
    else
        print_error "Not responding"
    fi
}

diagnose_issues() {
    print_section "Running Diagnostics"
    
    # Check for common issues
    echo "Checking for common issues..."
    
    # Check disk space
    echo -n "Disk space: "
    local disk_usage=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $disk_usage -gt 90 ]; then
        print_error "Critical! ${disk_usage}% used"
    elif [ $disk_usage -gt 80 ]; then
        print_warning "${disk_usage}% used"
    else
        print_success "${disk_usage}% used"
    fi
    
    # Check memory
    echo -n "Memory: "
    local mem_usage=$(free | grep Mem | awk '{print int($3/$2 * 100)}')
    if [ $mem_usage -gt 90 ]; then
        print_error "Critical! ${mem_usage}% used"
    elif [ $mem_usage -gt 80 ]; then
        print_warning "${mem_usage}% used"
    else
        print_success "${mem_usage}% used"
    fi
    
    # Check for restart loops
    echo ""
    echo "Checking for restart loops..."
    for service in $(docker compose ps --services); do
        local restarts=$(docker inspect --format='{{.RestartCount}}' $service 2>/dev/null || echo "0")
        if [ "$restarts" -gt "5" ]; then
            print_warning "$service has restarted $restarts times"
        fi
    done
    
    # Recent errors
    echo ""
    echo "Recent errors (last 10 minutes):"
    docker compose logs --since 10m 2>&1 | grep -i "error\|fatal\|critical" | tail -10 || echo "No recent errors found"
}

# ============================================
# Development Functions
# ============================================

dev_setup() {
    print_section "Development Setup"
    
    # Check for required files
    if [ ! -f .env ]; then
        print_warning ".env file not found, creating from template..."
        if [ -f .env.example ]; then
            cp .env.example .env
            print_info "Please edit .env with your configuration"
        else
            print_error "No .env.example found!"
        fi
    fi
    
    # Install git hooks if available
    if [ -d .git/hooks ]; then
        print_info "Installing git hooks..."
        # Add pre-commit hooks here if needed
    fi
    
    print_success "Development environment ready"
}

sync_from_remote() {
    print_section "Syncing from Remote"
    
    git fetch origin
    local behind=$(git rev-list --count HEAD..origin/main)
    
    if [ "$behind" -gt 0 ]; then
        print_info "You are $behind commits behind origin/main"
        echo -n "Pull changes? (y/n): "
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            git pull origin main
            print_success "Code synced"
            echo -n "Rebuild services? (y/n): "
            read -r rebuild
            if [[ "$rebuild" =~ ^[Yy]$ ]]; then
                deploy_quick
            fi
        fi
    else
        print_success "Already up to date"
    fi
}

# ============================================
# Fix Functions
# ============================================

fix_jarvis() {
    print_section "Fixing Jarvis AI"
    
    # Test current status
    echo -n "Current status: "
    test_jarvis_ai
    
    # Apply fixes
    print_info "Applying fixes..."
    
    # Ensure correct model is used
    docker exec homelab-dashboard sed -i "s/'gpt-5'/'gpt-3.5-turbo'/g" /app/services/ai_service.py 2>/dev/null || true
    
    # Restart service
    docker compose restart homelab-dashboard
    
    sleep 5
    echo -n "New status: "
    test_jarvis_ai
}

fix_permissions() {
    print_section "Fixing Permissions"
    
    # Fix common permission issues
    print_info "Fixing Docker socket permissions..."
    sudo chmod 666 /var/run/docker.sock 2>/dev/null || true
    
    print_info "Fixing volume permissions..."
    for volume in $(docker volume ls -q | grep homelab); do
        docker run --rm -v $volume:/data alpine chown -R 1000:1000 /data 2>/dev/null || true
    done
    
    print_success "Permissions fixed"
}

# ============================================
# Backup & Restore
# ============================================

backup_data() {
    print_section "Creating Backup"
    
    mkdir -p "$BACKUP_DIR"
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="$BACKUP_DIR/homelab_backup_$timestamp.tar.gz"
    
    print_info "Backing up volumes..."
    docker compose down
    
    # Backup volumes
    for volume in $(docker volume ls -q | grep homelab); do
        docker run --rm -v $volume:/data -v $BACKUP_DIR:/backup alpine \
            tar czf /backup/${volume}_$timestamp.tar.gz /data 2>/dev/null
    done
    
    # Backup .env
    cp .env "$BACKUP_DIR/.env_$timestamp" 2>/dev/null || true
    
    print_success "Backup created in $BACKUP_DIR"
    docker compose up -d
}

# ============================================
# Utility Functions
# ============================================

wait_for_service() {
    local service=$1
    local check_cmd=$2
    local max_wait=60
    local waited=0
    
    echo -n "Waiting for $service"
    while [ $waited -lt $max_wait ]; do
        if docker exec $service sh -c "$check_cmd" >/dev/null 2>&1; then
            echo -e " ${GREEN}âœ“${NC}"
            return 0
        fi
        echo -n "."
        sleep 2
        waited=$((waited + 2))
    done
    echo -e " ${RED}âœ—${NC}"
    return 1
}

show_urls() {
    print_section "Service URLs"
    
    echo "  ðŸŒ Dashboard: https://host.evindrake.net"
    echo "  ðŸ¤– Discord Bot: https://bot.rig-city.com"
    echo "  ðŸ“º Stream Bot: https://stream.rig-city.com"
    echo "  ðŸ–¥ï¸  VNC Desktop: https://vnc.evindrake.net"
    echo "  ðŸ’» Code Server: https://code.evindrake.net"
    echo "  ðŸŽ¬ Plex: https://plex.evindrake.net"
    echo "  ðŸ”„ N8N: https://n8n.evindrake.net"
    echo "  ðŸ  Home Assistant: https://home.evindrake.net"
}

show_help() {
    print_header "HOMELAB MANAGEMENT v${SCRIPT_VERSION}"
    
    echo "Usage: $0 [command] [options]"
    echo ""
    echo "${BOLD}DEPLOYMENT:${NC}"
    echo "  deploy       - Smart deployment with auto-detection"
    echo "  fresh        - Fresh deployment (no cache)"
    echo "  quick        - Quick deployment (with cache)"
    echo ""
    echo "${BOLD}MANAGEMENT:${NC}"
    echo "  start        - Start all services"
    echo "  stop         - Stop all services"
    echo "  restart      - Restart a specific service"
    echo "  logs         - View service logs"
    echo "  status       - Show service status"
    echo ""
    echo "${BOLD}DIAGNOSTICS:${NC}"
    echo "  health       - Run health check"
    echo "  diagnose     - Run full diagnostics"
    echo "  test         - Test specific components"
    echo ""
    echo "${BOLD}FIXES:${NC}"
    echo "  fix          - Auto-fix detected issues"
    echo "  fix-jarvis   - Fix Jarvis AI issues"
    echo "  fix-perms    - Fix permission issues"
    echo ""
    echo "${BOLD}DEVELOPMENT:${NC}"
    echo "  dev          - Setup development environment"
    echo "  sync         - Sync from git remote"
    echo "  build        - Rebuild specific service"
    echo ""
    echo "${BOLD}UTILITIES:${NC}"
    echo "  backup       - Create backup"
    echo "  urls         - Show service URLs"
    echo "  info         - Show system information"
    echo "  help         - Show this help"
    echo ""
    echo "${BOLD}QUICK START:${NC}"
    echo "  $0              - Interactive mode"
    echo "  $0 deploy       - Deploy everything"
    echo "  $0 health       - Check health"
    echo "  $0 logs all     - View all logs"
}

# ============================================
# Interactive Menu
# ============================================

interactive_menu() {
    while true; do
        print_header "HOMELAB MANAGEMENT SYSTEM"
        
        echo "${BOLD}Main Menu:${NC}"
        echo ""
        echo "  ${CYAN}[1]${NC} ðŸš€ Deployment"
        echo "  ${CYAN}[2]${NC} ðŸŽ›ï¸  Service Management"
        echo "  ${CYAN}[3]${NC} ðŸ” Diagnostics & Health"
        echo "  ${CYAN}[4]${NC} ðŸ”§ Fixes & Troubleshooting"
        echo "  ${CYAN}[5]${NC} ðŸ’» Development"
        echo "  ${CYAN}[6]${NC} ðŸ’¾ Backup & Restore"
        echo "  ${CYAN}[7]${NC} ðŸ“Š System Information"
        echo "  ${CYAN}[8]${NC} ðŸŒ Show URLs"
        echo "  ${CYAN}[0]${NC} ðŸšª Exit"
        echo ""
        echo -n "Select option: "
        read -r choice
        
        case $choice in
            1) deployment_menu ;;
            2) management_menu ;;
            3) diagnostics_menu ;;
            4) fixes_menu ;;
            5) development_menu ;;
            6) backup_menu ;;
            7) system_info ;;
            8) show_urls ;;
            0) exit 0 ;;
            *) print_error "Invalid option" ;;
        esac
        
        echo ""
        echo -n "Press Enter to continue..."
        read
    done
}

deployment_menu() {
    clear
    print_section "Deployment Options"
    
    echo "  [1] Fresh deployment (clean build)"
    echo "  [2] Quick deployment (cached)"
    echo "  [3] Update from Git & Deploy"
    echo "  [4] Back"
    echo ""
    echo -n "Select: "
    read -r choice
    
    case $choice in
        1) deploy_fresh ;;
        2) deploy_quick ;;
        3) sync_from_remote ;;
        4) return ;;
    esac
}

management_menu() {
    clear
    print_section "Service Management"
    
    echo "  [1] Start all services"
    echo "  [2] Stop all services"
    echo "  [3] Restart specific service"
    echo "  [4] View logs"
    echo "  [5] Service status"
    echo "  [6] Back"
    echo ""
    echo -n "Select: "
    read -r choice
    
    case $choice in
        1) start_services ;;
        2) stop_services ;;
        3) restart_service ;;
        4) view_logs ;;
        5) docker compose ps ;;
        6) return ;;
    esac
}

diagnostics_menu() {
    clear
    print_section "Diagnostics"
    
    echo "  [1] Quick health check"
    echo "  [2] Full diagnostics"
    echo "  [3] Test Jarvis AI"
    echo "  [4] Test Database"
    echo "  [5] View recent errors"
    echo "  [6] Back"
    echo ""
    echo -n "Select: "
    read -r choice
    
    case $choice in
        1) health_check ;;
        2) diagnose_issues ;;
        3) test_jarvis_ai ;;
        4) test_database ;;
        5) docker compose logs --tail=50 | grep -i error ;;
        6) return ;;
    esac
}

fixes_menu() {
    clear
    print_section "Fixes & Troubleshooting"
    
    echo "  [1] Auto-fix detected issues"
    echo "  [2] Fix Jarvis AI"
    echo "  [3] Fix permissions"
    echo "  [4] Reset service"
    echo "  [5] Clean Docker resources"
    echo "  [6] Back"
    echo ""
    echo -n "Select: "
    read -r choice
    
    case $choice in
        1) auto_fix ;;
        2) fix_jarvis ;;
        3) fix_permissions ;;
        4) restart_service ;;
        5) docker system prune -f ;;
        6) return ;;
    esac
}

development_menu() {
    clear
    print_section "Development"
    
    echo "  [1] Setup dev environment"
    echo "  [2] Sync from Git"
    echo "  [3] Build specific service"
    echo "  [4] Run tests"
    echo "  [5] Back"
    echo ""
    echo -n "Select: "
    read -r choice
    
    case $choice in
        1) dev_setup ;;
        2) sync_from_remote ;;
        3) 
            echo -n "Service name: "
            read service
            docker compose build $service
            ;;
        4) echo "No tests configured yet" ;;
        5) return ;;
    esac
}

backup_menu() {
    clear
    print_section "Backup & Restore"
    
    echo "  [1] Create backup"
    echo "  [2] List backups"
    echo "  [3] Back"
    echo ""
    echo -n "Select: "
    read -r choice
    
    case $choice in
        1) backup_data ;;
        2) ls -la "$BACKUP_DIR" 2>/dev/null || echo "No backups found" ;;
        3) return ;;
    esac
}

system_info() {
    clear
    print_section "System Information"
    
    echo "Homelab Version: $SCRIPT_VERSION"
    echo "Docker Version: $(docker --version)"
    echo "Compose Version: $(docker compose version)"
    echo ""
    echo "Disk Usage:"
    df -h / | grep -E "Filesystem|/"
    echo ""
    echo "Memory Usage:"
    free -h
    echo ""
    echo "Running Containers:"
    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | head -20
}

auto_fix() {
    print_section "Auto-Fix"
    
    # Run diagnostics first
    diagnose_issues
    
    # Apply common fixes
    print_info "Applying fixes..."
    
    # Restart unhealthy services
    for service in $(docker compose ps --services); do
        if ! docker ps --format "{{.Names}}" | grep -q "^${service}$"; then
            print_info "Restarting $service..."
            docker compose up -d $service
        fi
    done
    
    # Fix Jarvis if needed
    if ! test_jarvis_ai >/dev/null 2>&1; then
        fix_jarvis
    fi
    
    print_success "Auto-fix complete"
}

# ============================================
# Main Execution
# ============================================

main() {
    # Check requirements
    check_docker
    
    # Parse command line arguments
    case "${1:-}" in
        # Deployment
        deploy|deployment)
            shift
            case "${1:-}" in
                fresh) deploy_fresh ;;
                quick) deploy_quick ;;
                *) deploy_quick ;;
            esac
            ;;
        fresh) deploy_fresh ;;
        quick) deploy_quick ;;
        
        # Management
        start) start_services ;;
        stop) stop_services ;;
        restart) restart_service "$2" ;;
        logs) view_logs "$2" ;;
        status) docker compose ps ;;
        
        # Diagnostics
        health|check) health_check ;;
        diagnose|diag) diagnose_issues ;;
        test) 
            case "${2:-all}" in
                jarvis) test_jarvis_ai ;;
                db|database) test_database ;;
                redis) test_redis ;;
                *) health_check ;;
            esac
            ;;
        
        # Fixes
        fix)
            case "${2:-auto}" in
                jarvis) fix_jarvis ;;
                perms|permissions) fix_permissions ;;
                *) auto_fix ;;
            esac
            ;;
        fix-jarvis) fix_jarvis ;;
        fix-perms) fix_permissions ;;
        
        # Development
        dev) dev_setup ;;
        sync) sync_from_remote ;;
        build) docker compose build "$2" ;;
        
        # Utilities
        backup) backup_data ;;
        urls) show_urls ;;
        info) system_info ;;
        help|--help|-h) show_help ;;
        
        # Interactive mode
        "") interactive_menu ;;
        
        # Unknown command
        *) 
            print_error "Unknown command: $1"
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"