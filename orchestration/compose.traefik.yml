# ============================================
# TRAEFIK API GATEWAY
# Phase 3: Service Discovery & Networking
# Phase 7: API Gateway & Authentication
# ============================================
# Dynamic reverse proxy and API gateway with:
# - Docker provider (auto-discovers services via labels)
# - Consul provider (watches Consul catalog)
# - Let's Encrypt automatic HTTPS
# - Cloudflare DNS challenge for wildcard certs
# - JWT authentication middleware
# - Rate limiting
# - CORS handling
# - Service-to-service authentication

volumes:
  traefik_data:

services:
  # ============================================
  # Traefik - API Gateway & Reverse Proxy
  # ============================================
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "8080:8080"   # Dashboard (should be secured)
    env_file:
      - ${DEPLOYMENT_PATH:-.}/.env
      - ${DEPLOYMENT_PATH:-.}/.env.traefik
    command:
      # Global configuration
      - "--global.checkNewVersion=true"
      - "--global.sendAnonymousUsage=false"
      
      # API and Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"  # Dashboard secured via router
      
      # Entry points
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.traefik.address=:8080"
      
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      
      # Docker provider (watches Docker labels)
      - "--providers.docker=true"
      - "--providers.docker.network=homelab"
      - "--providers.docker.exposedByDefault=false"
      - "--providers.docker.watch=true"
      
      # Consul provider (watches Consul catalog)
      - "--providers.consulcatalog=true"
      - "--providers.consulcatalog.endpoint.address=consul-server:8500"
      - "--providers.consulcatalog.exposedByDefault=false"
      - "--providers.consulcatalog.prefix=traefik"
      - "--providers.consulcatalog.watch=true"
      
      # Let's Encrypt with Cloudflare DNS challenge
      - "--certificatesresolvers.cloudflare.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.cloudflare.acme.storage=/data/acme.json"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge=true"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"
      
      # Logging (JSON format for better parsing)
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--accesslog.filepath=/data/access.log"
      - "--accesslog.format=json"
      - "--accesslog.bufferingsize=100"
      - "--accesslog.fields.headers.defaultmode=keep"
    
    environment:
      - CF_API_EMAIL=${CLOUDFLARE_EMAIL}
      - CF_DNS_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}
      - CF_ZONE_API_TOKEN=${CLOUDFLARE_ZONE_API_TOKEN}
    
    labels:
      # Enable Traefik for its own dashboard
      - "traefik.enable=true"
      
      # ============================================
      # Phase 7: Global Middlewares (API Gateway)
      # ============================================
      
      # JWT Authentication Middleware (ForwardAuth)
      - "traefik.http.middlewares.auth-jwt.forwardauth.address=http://homelab-auth-service:8000/api/v1/auth/validate"
      - "traefik.http.middlewares.auth-jwt.forwardauth.authResponseHeaders=X-User-Id,X-User-Roles,X-Token-Type"
      - "traefik.http.middlewares.auth-jwt.forwardauth.trustForwardHeader=true"
      
      # Service Token Authentication Middleware
      - "traefik.http.middlewares.auth-service.forwardauth.address=http://homelab-auth-service:8000/api/v1/auth/service-token/validate"
      - "traefik.http.middlewares.auth-service.forwardauth.authResponseHeaders=X-Service-Name,X-Token-Type"
      - "traefik.http.middlewares.auth-service.forwardauth.trustForwardHeader=true"
      
      # Rate Limiting Middleware (100 requests/minute default)
      - "traefik.http.middlewares.rate-limit.ratelimit.average=100"
      - "traefik.http.middlewares.rate-limit.ratelimit.burst=50"
      - "traefik.http.middlewares.rate-limit.ratelimit.period=1m"
      
      # Aggressive Rate Limiting (for public endpoints)
      - "traefik.http.middlewares.rate-limit-strict.ratelimit.average=20"
      - "traefik.http.middlewares.rate-limit-strict.ratelimit.burst=10"
      - "traefik.http.middlewares.rate-limit-strict.ratelimit.period=1m"
      
      # CORS Middleware (permissive - configure per service)
      - "traefik.http.middlewares.cors.headers.accessControlAllowOriginList=*"
      - "traefik.http.middlewares.cors.headers.accessControlAllowMethods=GET,POST,PUT,DELETE,OPTIONS,PATCH"
      - "traefik.http.middlewares.cors.headers.accessControlAllowHeaders=*"
      - "traefik.http.middlewares.cors.headers.accessControlAllowCredentials=true"
      - "traefik.http.middlewares.cors.headers.accessControlMaxAge=100"
      
      # Security Headers Middleware
      - "traefik.http.middlewares.security-headers.headers.sslRedirect=true"
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      
      # Request Logging Middleware (adds custom headers for tracing)
      - "traefik.http.middlewares.request-trace.headers.customRequestHeaders.X-Request-ID=auto"
      
      # ============================================
      # Traefik Dashboard Router
      # ============================================
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.evindrake.net`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=cloudflare"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      
      # Basic auth for dashboard (generate with: htpasswd -nb user password)
      - "traefik.http.routers.traefik-dashboard.middlewares=dashboard-auth,rate-limit"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_data:/data
    
    depends_on:
      - consul-server
    
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # Whoami - Test Service for Traefik
  # ============================================
  # Simple test service to verify Traefik routing
  whoami:
    image: traefik/whoami:latest
    container_name: whoami
    restart: unless-stopped
    networks:
      - homelab
    env_file:
      - ${DEPLOYMENT_PATH:-.}/.env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`whoami.evindrake.net`)"
      - "traefik.http.routers.whoami.entrypoints=websecure"
      - "traefik.http.routers.whoami.tls=true"
      - "traefik.http.routers.whoami.tls.certresolver=cloudflare"
      - "traefik.http.services.whoami.loadbalancer.server.port=80"
