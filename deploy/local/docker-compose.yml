networks:
  homelab:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
  minio_data:
  homeassistant_config:
  plex_config:
  novnc_data:
  plex_cache_data:
  smartctl_data:
  dashboard_postgres_data:
  dashboard_redis_data:

services:
  # ============================================================================
  # DASHBOARD INFRASTRUCTURE (Auto-provisioned - No manual config required)
  # ============================================================================
  dashboard-db:
    image: postgres:16-alpine
    container_name: dashboard-postgres
    restart: unless-stopped
    networks:
      - homelab
    environment:
      - POSTGRES_DB=homelab_dashboard
      - POSTGRES_USER=dashboard
      - POSTGRES_PASSWORD=dashboard_secure_2024
    volumes:
      - dashboard_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dashboard -d homelab_dashboard"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  dashboard-redis:
    image: redis:7-alpine
    container_name: dashboard-redis
    restart: unless-stopped
    networks:
      - homelab
    command: redis-server --appendonly yes
    volumes:
      - dashboard_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    network_mode: host
    # Uses config file with ingress rules - mount user's .cloudflared at same path
    command: tunnel --no-autoupdate --config /etc/cloudflared/config.yml run plex-tunnel
    volumes:
      # Mount user's cloudflared directory to /etc/cloudflared
      - /home/evin/.cloudflared:/etc/cloudflared:ro
    healthcheck:
      test: ["CMD-SHELL", "pgrep cloudflared || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  caddy:
    image: caddy:2-alpine
    container_name: caddy-local
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3

  minio:
    image: minio/minio:latest
    container_name: homelab-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    networks:
      - homelab
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    network_mode: host
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
    volumes:
      - plex_config:/config
      # NAS media shares - mounted via CIFS at /srv/media/*
      - /srv/media/video:/media/video:rw
      - /srv/media/music:/media/music:rw
      - /srv/media/photo:/media/photo:ro
      # Local storage for Plex optimized versions (faster than NAS)
      - /opt/plex-optimized:/optimized:rw
    tmpfs:
      - /transcode:size=4G
    devices:
      - /dev/dri:/dev/dri
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:32400/identity || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    privileged: true
    networks:
      - homelab
    environment:
      - TZ=${TZ:-America/New_York}
    volumes:
      - homeassistant_config:/config
      - ./config/homeassistant:/config-templates:ro
      - /run/dbus:/run/dbus:ro
    devices:
      - /dev/bus/usb:/dev/bus/usb
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
    ports:
      - "8123:8123"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  smartctl-exporter:
    image: prometheuscommunity/smartctl-exporter:latest
    container_name: smartctl-exporter
    restart: unless-stopped
    privileged: true
    profiles:
      - monitoring
    networks:
      - homelab
    ports:
      - "9633:9633"
    volumes:
      - /dev:/dev:ro
      - smartctl_data:/data
    command:
      - '--smartctl.path=/usr/sbin/smartctl'
      - '--smartctl.interval=60s'
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9633/metrics || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3

  storage-monitor:
    build:
      context: ./services/storage-monitor
      dockerfile: Dockerfile
    container_name: storage-monitor
    restart: unless-stopped
    privileged: true
    profiles:
      - monitoring
    networks:
      - homelab
    environment:
      - TZ=${TZ:-America/New_York}
      - DISCORD_WEBHOOK_URL=${STORAGE_ALERT_DISCORD_WEBHOOK:-}
      - EMAIL_ALERTS=${STORAGE_ALERT_EMAIL:-}
      - CHECK_INTERVAL=${STORAGE_CHECK_INTERVAL:-3600}
      - SMART_THRESHOLD_REALLOCATED=${SMART_THRESHOLD_REALLOCATED:-5}
      - SMART_THRESHOLD_PENDING=${SMART_THRESHOLD_PENDING:-1}
      - ZFS_ENABLED=${ZFS_ENABLED:-false}
    volumes:
      - /dev:/dev:ro
      - /sys:/sys:ro
      - /run/udev:/run/udev:ro
    ports:
      - "9634:9634"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9634/health || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3

  # NOTE: For Ubuntu host desktop access, use setup-host-vnc.sh instead
  # This creates x11vnc + noVNC systemd services on the host
  # The Docker container below is kept for isolated virtual desktop use only
  novnc:
    image: theasp/novnc:latest
    container_name: novnc
    restart: unless-stopped
    profiles:
      - vnc-sandbox  # Changed profile - use for sandboxed desktop only
    networks:
      - homelab
    environment:
      - DISPLAY_WIDTH=1920
      - DISPLAY_HEIGHT=1080
      - RUN_XTERM=yes
      - VNC_PASSWORD=${VNC_PASSWORD:-}
    ports:
      - "${NOVNC_PORT:-6080}:8080"
    volumes:
      - novnc_data:/home/user
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  dashboard:
    build:
      context: ../../services/dashboard
      dockerfile: Dockerfile
    container_name: homelab-dashboard
    restart: unless-stopped
    networks:
      - homelab
    depends_on:
      dashboard-db:
        condition: service_healthy
      dashboard-redis:
        condition: service_healthy
    environment:
      - FLASK_ENV=production
      # Auto-configured database (no manual setup required!)
      - JARVIS_DATABASE_URL=postgresql://dashboard:dashboard_secure_2024@dashboard-db:5432/homelab_dashboard
      - DATABASE_URL=postgresql://dashboard:dashboard_secure_2024@dashboard-db:5432/homelab_dashboard
      - REDIS_URL=redis://dashboard-redis:6379/0
      # Optional user settings (can override via .env)
      - WEB_USERNAME=${WEB_USERNAME:-evin}
      - WEB_PASSWORD=${WEB_PASSWORD:-nebula2024}
      - DASHBOARD_API_KEY=${DASHBOARD_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
      - TZ=${TZ:-America/New_York}
      # Fleet Manager SSH settings
      - TAILSCALE_LOCAL_HOST=${TAILSCALE_LOCAL_HOST:-192.168.0.177}
      - TAILSCALE_LINODE_HOST=${TAILSCALE_LINODE_HOST:-}
      - SSH_USER=${SSH_USER:-evin}
      - SSH_KEY_PATH=/app/ssh/id_rsa
      # NAS settings
      - NAS_IP=${NAS_IP:-192.168.0.176}
    volumes:
      - ~/.ssh:/app/ssh:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "5000:5000"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  gamestream:
    image: lscr.io/linuxserver/sunshine:latest
    container_name: sunshine
    restart: unless-stopped
    profiles:
      - gamestream
    network_mode: host
    privileged: true
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/sunshine:/config
    devices:
      - /dev/dri:/dev/dri
      - /dev/uinput:/dev/uinput
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
