networks:
  homelab:
    driver: bridge
  media:
    driver: bridge
  auth:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
  authelia_data:
  minio_data:
  homeassistant_config:
  plex_config:
  jellyfin_config:
  jellyfin_cache:
  qbittorrent_config:
  novnc_data:
  smartctl_data:
  dashboard_postgres_data:
  dashboard_redis_data:
  sunshine_config:

services:
  # ============================================================================
  # AUTHENTICATION LAYER (Authelia + Redis)
  # ============================================================================
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    networks:
      - homelab
      - auth
    expose:
      - 9091
    environment:
      - TZ=${TZ:-America/New_York}
      - DOMAIN=${DOMAIN:-example.com}
      - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET:-changeme_jwt_secret_32chars_min}
      - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET:-changeme_session_secret_32chars}
      - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_KEY:-changeme_storage_key_32chars_min}
    volumes:
      - ./services/authelia:/config
      - authelia_data:/data
    depends_on:
      - authelia-redis
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9091/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  authelia-redis:
    image: redis:7-alpine
    container_name: authelia-redis
    restart: unless-stopped
    networks:
      - auth
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # DASHBOARD INFRASTRUCTURE
  # ============================================================================
  dashboard-db:
    image: postgres:16-alpine
    container_name: dashboard-postgres
    restart: unless-stopped
    networks:
      - homelab
    environment:
      - POSTGRES_DB=homelab_dashboard
      - POSTGRES_USER=dashboard
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-dashboard_secure_2024}
    volumes:
      - dashboard_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dashboard -d homelab_dashboard"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  dashboard-redis:
    image: redis:7-alpine
    container_name: dashboard-redis
    restart: unless-stopped
    networks:
      - homelab
    command: redis-server --appendonly yes
    volumes:
      - dashboard_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # REVERSE PROXY (Caddy with Cloudflare DNS)
  # ============================================================================
  caddy:
    build:
      context: ./services/caddy
      dockerfile: Dockerfile
    container_name: caddy-local
    restart: unless-stopped
    networks:
      - homelab
      - auth
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    environment:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - DOMAIN=${DOMAIN:-example.com}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
    volumes:
      - ./services/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - authelia
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # MEDIA SERVERS
  # ============================================================================
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    network_mode: host
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
    volumes:
      - plex_config:/config
      - /srv/media:/media:rw
      - /opt/plex-optimized:/optimized:rw
    tmpfs:
      - /transcode:size=4G
    devices:
      - /dev/dri:/dev/dri
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:32400/identity || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    user: 1000:1000
    networks:
      - homelab
      - media
    expose:
      - 8096
    environment:
      - JELLYFIN_PublishedServerUrl=https://jellyfin.${DOMAIN:-example.com}
    volumes:
      - jellyfin_config:/config
      - jellyfin_cache:/cache
      - /srv/media:/media:ro
      - /srv/media/community:/media/community
    devices:
      - /dev/dri:/dev/dri
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # TORRENTS (VPN Protected via Gluetun) - Optional: docker compose --profile torrents up
  # ============================================================================
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    profiles:
      - torrents
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      - media
      - homelab
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_PROVIDER:-mullvad}
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${MULLVAD_PRIVATE_KEY:-}
      - WIREGUARD_ADDRESSES=${MULLVAD_ADDRESS:-10.0.0.1/32}
      - SERVER_COUNTRIES=${VPN_COUNTRY:-Switzerland}
      - FIREWALL_VPN_INPUT_PORTS=6881
      - FIREWALL_INPUT_PORTS=8080
    expose:
      - 8080  # qBittorrent Web UI - internal only, accessed via Caddy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider https://am.i.mullvad.net/connected || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    profiles:
      - torrents
    network_mode: "service:gluetun"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
      - WEBUI_PORT=8080
    volumes:
      - qbittorrent_config:/config
      - /srv/media/downloads:/downloads
    depends_on:
      gluetun:
        condition: service_healthy

  # ============================================================================
  # HOME AUTOMATION
  # ============================================================================
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    privileged: true
    network_mode: host
    environment:
      - TZ=${TZ:-America/New_York}
    volumes:
      - homeassistant_config:/config
      - /run/dbus:/run/dbus:ro
      - /var/run/dbus:/var/run/dbus:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # REMOTE ACCESS - VNC (noVNC web client connecting to host x11vnc)
  # ============================================================================
  novnc:
    image: theasp/novnc:latest
    container_name: novnc
    restart: unless-stopped
    networks:
      - homelab
    environment:
      - DISPLAY_WIDTH=1920
      - DISPLAY_HEIGHT=1080
      - RUN_XTERM=no
      - VNC_HOST=host.docker.internal
      - VNC_PORT=${VNC_PORT:-5900}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    expose:
      - 8080
    volumes:
      - novnc_data:/home/user
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # REMOTE ACCESS - Web SSH (ttyd)
  # ============================================================================
  ttyd:
    image: tsl0922/ttyd:latest
    container_name: ttyd
    restart: unless-stopped
    networks:
      - homelab
    command: ttyd -W bash
    expose:
      - 7681
    volumes:
      - /home/${LOCAL_USER:-evin}:/home/user:rw
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:7681/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # REMOTE ACCESS - Sunshine Game Streaming (optional - use: docker compose --profile gamestream up)
  # ============================================================================
  sunshine:
    image: lizardbyte/sunshine:latest
    container_name: sunshine
    restart: unless-stopped
    network_mode: host
    privileged: true
    profiles:
      - gamestream
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
    volumes:
      - sunshine_config:/config
      - /dev/dri:/dev/dri
      - /dev/uinput:/dev/uinput
    devices:
      - /dev/dri:/dev/dri
      - /dev/uinput:/dev/uinput

  # ============================================================================
  # STORAGE - MinIO Object Storage
  # ============================================================================
  minio:
    image: minio/minio:latest
    container_name: homelab-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    networks:
      - homelab
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-changeme123}
    volumes:
      - minio_data:/data
    expose:
      - 9000
      - 9001
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ============================================================================
  # DASHBOARD
  # ============================================================================
  dashboard:
    build:
      context: ../../services/dashboard-next
      dockerfile: Dockerfile
    container_name: homelab-dashboard
    restart: unless-stopped
    networks:
      - homelab
    depends_on:
      dashboard-db:
        condition: service_healthy
      dashboard-redis:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - ADMIN_USERNAME=${WEB_USERNAME:-evin}
      - ADMIN_PASSWORD=${WEB_PASSWORD:-nebula2024}
      - SESSION_SECRET=${SESSION_SECRET:-NebulaCommandLocalDash2024SecureKey32chars}
      - DATABASE_URL=postgresql://dashboard:${POSTGRES_PASSWORD:-dashboard_secure_2024}@dashboard-db:5432/homelab_dashboard
      - REDIS_URL=redis://dashboard-redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
      - TZ=${TZ:-America/New_York}
      - HOME_SSH_HOST=${TAILSCALE_LOCAL_HOST:-192.168.0.177}
      - HOME_SSH_USER=${SSH_USER:-evin}
      - LINODE_SSH_HOST=${TAILSCALE_LINODE_HOST:-}
      - LINODE_SSH_USER=root
    volumes:
      - ~/.ssh:/root/.ssh:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    expose:
      - 5000
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # COMMUNITY SYNC SERVICE
  # ============================================================================
  media-sync:
    build:
      context: ./jellyfin/sync-service
      dockerfile: Dockerfile
    container_name: media-sync
    restart: unless-stopped
    networks:
      - media
    environment:
      - NODE_NAME=${NODE_NAME:-LocalServer}
      - DASHBOARD_URL=${DASHBOARD_URL:-}
      - SYNC_API_KEY=${SYNC_API_KEY:-}
      - MEDIA_PATH=/media
    volumes:
      - /srv/media:/media:ro
    depends_on:
      - jellyfin

  # ============================================================================
  # MONITORING (Optional - use: docker compose --profile monitoring up)
  # ============================================================================
  smartctl-exporter:
    image: prometheuscommunity/smartctl-exporter:latest
    container_name: smartctl-exporter
    restart: unless-stopped
    privileged: true
    profiles:
      - monitoring
    networks:
      - homelab
    ports:
      - "9633:9633"
    volumes:
      - /dev:/dev:ro
      - smartctl_data:/data
    command:
      - '--smartctl.path=/usr/sbin/smartctl'
      - '--smartctl.interval=60s'
