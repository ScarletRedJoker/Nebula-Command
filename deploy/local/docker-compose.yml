networks:
  homelab:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
  minio_data:
  homeassistant_config:
  plex_config:
  novnc_data:
  plex_cache_data:

services:
  caddy:
    image: caddy:2-alpine
    container_name: caddy-local
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3

  minio:
    image: minio/minio:latest
    container_name: homelab-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    networks:
      - homelab
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    network_mode: host
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
    volumes:
      - plex_config:/config
      # MergerFS unified paths (cache + NAS merged, cache takes priority)
      # This serves cached content from SSD first, falls back to NAS
      - /opt/plex-media/movies:/media/movies:ro
      - /opt/plex-media/shows:/media/shows:ro
      - /opt/plex-media/music:/media/music:ro
      # Additional NAS content (photos, games - not cached)
      - /mnt/nas/networkshare/photo:/media/photo:ro
      - /mnt/nas/networkshare/games:/media/games:ro
    tmpfs:
      - /transcode:size=4G
    devices:
      - /dev/dri:/dev/dri
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:32400/identity || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    privileged: true
    networks:
      - homelab
    environment:
      - TZ=${TZ:-America/New_York}
    volumes:
      - homeassistant_config:/config
      - ./config/homeassistant:/config-templates:ro
      - /run/dbus:/run/dbus:ro
    devices:
      - /dev/bus/usb:/dev/bus/usb
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
    ports:
      - "8123:8123"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  plex-auto-cache:
    build:
      context: ./services/plex-auto-cache
      dockerfile: Dockerfile
    container_name: plex-auto-cache
    restart: unless-stopped
    network_mode: host
    environment:
      - CACHE_BASE=/opt/plex-cache
      - NAS_BASE=/mnt/nas/networkshare
      - CACHE_MAX_SIZE_GB=${PLEX_CACHE_MAX_GB:-100}
      - CACHE_BUFFER_GB=${PLEX_CACHE_BUFFER_GB:-10}
      - SESSION_PROTECT_MINUTES=${PLEX_SESSION_PROTECT_MINUTES:-60}
      - DB_PATH=/data/cache_metadata.db
      - PORT=5055
      - TZ=${TZ:-America/New_York}
    volumes:
      - /opt/plex-cache:/opt/plex-cache
      - /mnt/nas/networkshare:/mnt/nas/networkshare:ro
      - plex_cache_data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5055/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  novnc:
    image: theasp/novnc:latest
    container_name: novnc
    restart: unless-stopped
    profiles:
      - vnc
    networks:
      - homelab
    environment:
      - DISPLAY_WIDTH=1920
      - DISPLAY_HEIGHT=1080
      - RUN_XTERM=yes
      - VNC_PASSWORD=${VNC_PASSWORD:-}
    ports:
      - "${NOVNC_PORT:-6080}:8080"
    volumes:
      - novnc_data:/home/user
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
