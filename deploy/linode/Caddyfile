{
    email evin@evindrake.net
}

# Default health endpoint for Docker healthchecks
:80 {
    respond /health 200
    respond 404
}

bot.evindrake.net {
    reverse_proxy discord-bot:4000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

stream.evindrake.net {
    reverse_proxy stream-bot:5001 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # WebSocket support for OBS overlays - separate matcher
    @websockets {
        header Upgrade websocket
    }
    reverse_proxy @websockets stream-bot:5001
}

discord.evindrake.net {
    reverse_proxy discord-bot:4000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }
}

n8n.evindrake.net {
    reverse_proxy n8n:5678
    
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

host.evindrake.net, dashboard.evindrake.net {
    reverse_proxy dockerhost:5000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_down Cache-Control "no-cache, no-store, must-revalidate, private"
        header_down Pragma "no-cache"
        header_down Expires "0"
    }
    
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

code.evindrake.net {
    reverse_proxy http://code-server-proxy:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }
    
    header {
        X-Content-Type-Options "nosniff"
        Referrer-Policy "same-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

scarletredjoker.com {
    reverse_proxy scarletredjoker-web:80
}

www.scarletredjoker.com {
    redir https://scarletredjoker.com{uri} permanent
}

plex.evindrake.net {
    # Proxy through WireGuard tunnel to home Plex server
    # Home server WireGuard IP: 10.200.0.2
    # 
    # CRITICAL for Plex auth: 
    # - Caddy automatically passes X-Forwarded-For and X-Forwarded-Proto
    # - Plex binds auth tokens to client IPs - these headers are needed for token validation
    # - Do NOT set X-Plex-* headers manually - let them pass through naturally
    reverse_proxy 10.200.0.2:32400 {
        # Pass real client IP for Plex token/IP binding
        header_up X-Real-IP {remote_host}
        
        # Timeouts for large media files
        transport http {
            read_timeout 300s
            write_timeout 300s
        }
        
        # Flush immediately for streaming - no buffering
        flush_interval -1
    }
}

home.evindrake.net {
    reverse_proxy 10.200.0.2:8123 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }
}

game.evindrake.net {
    handle /connect {
        redir https://dashboard.evindrake.net/game-connect permanent
    }
    
    handle {
        reverse_proxy 10.200.0.2:47990 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }
}

grafana.evindrake.net {
    reverse_proxy homelab-grafana:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }
    
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

dns.evindrake.net {
    reverse_proxy dns-manager:8001 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }
    
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

dash.evindrake.net {
    reverse_proxy dockerhost:5000
}

mail.evindrake.net {
    reverse_proxy localhost:8025 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}

webmail.evindrake.net {
    reverse_proxy localhost:8025 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}
