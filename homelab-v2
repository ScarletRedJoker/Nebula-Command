#!/bin/bash

# ╔════════════════════════════════════════════════════════════════╗
# ║          HOMELAB UNIFIED CONTROL - PRODUCTION READY           ║
# ║                    Robust Management System                    ║
# ╚════════════════════════════════════════════════════════════════╝

set -euo pipefail

# Colors and formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m'
BOLD='\033[1m'

# Configuration
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Files and paths
ENV_FILE=".env"
ENV_EXAMPLE=".env.example"
COMPOSE_FILE="docker-compose.yml"
COMPOSE_PROFILES="docker-compose.profiles.yml"
LOG_DIR="./logs"
STATE_FILE="./var/state/homelab.state"

# Profiles
declare -A PROFILES=(
    ["core"]="Core services (Caddy, PostgreSQL, Redis, Dashboard)"
    ["bots"]="Discord and Stream bots"
    ["media"]="Plex Media Server"
    ["dev"]="Development tools (VNC, Code-Server)"
    ["automation"]="Automation (n8n, Home Assistant)"
    ["storage"]="Storage services (MinIO)"
    ["web"]="Static websites"
    ["all"]="All services"
)

# Service health checks
declare -A SERVICE_HEALTH=(
    ["caddy"]="http://localhost:80"
    ["homelab-dashboard"]="http://localhost:5000/health"
    ["discord-bot"]="http://localhost:4000/health"
    ["stream-bot"]="http://localhost:5000/health"
    ["homelab-postgres"]="pg_isready -U postgres"
    ["homelab-redis"]="redis-cli ping"
    ["minio"]="http://localhost:9000/minio/health/live"
    ["homeassistant"]="http://localhost:8123/"
    ["code-server"]="https://localhost:8443/healthz"
)

# ============================================
# Helper Functions
# ============================================
log() {
    echo -e "${CYAN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $*"
}

error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $*"
}

# Create required directories
init_directories() {
    mkdir -p "$LOG_DIR"
    mkdir -p "$(dirname "$STATE_FILE")"
    mkdir -p "./var/backups"
}

# ============================================
# Environment Management
# ============================================
validate_environment() {
    log "Validating environment configuration..."
    
    if [ ! -f "$ENV_FILE" ]; then
        error "No .env file found!"
        if [ -f "$ENV_EXAMPLE" ]; then
            warning "Found .env.example - copying as template"
            cp "$ENV_EXAMPLE" "$ENV_FILE"
            warning "Please edit .env with your actual values"
            return 1
        else
            error "No .env.example found either"
            info "Run: $0 env init"
            return 1
        fi
    fi
    
    # Run Python validator if available
    if command -v python3 &> /dev/null && [ -f "scripts/validate-environment.py" ]; then
        if python3 scripts/validate-environment.py --validate; then
            success "Environment validation passed"
            return 0
        else
            warning "Environment validation found issues"
            info "Run: $0 env fix"
            return 1
        fi
    fi
    
    # Basic validation fallback
    local required_vars=("POSTGRES_PASSWORD" "WEB_USERNAME" "WEB_PASSWORD")
    local missing=()
    
    source "$ENV_FILE"
    for var in "${required_vars[@]}"; do
        if [ -z "${!var:-}" ]; then
            missing+=("$var")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        error "Missing required variables: ${missing[*]}"
        return 1
    fi
    
    success "Basic environment validation passed"
    return 0
}

# ============================================
# Docker Commands with Error Handling
# ============================================
docker_compose() {
    local compose_cmd="docker compose"
    
    # Always use env file if it exists
    if [ -f "$ENV_FILE" ]; then
        compose_cmd="$compose_cmd --env-file $ENV_FILE"
    fi
    
    # Use appropriate compose file
    if [ -f "$COMPOSE_PROFILES" ] && [ "${USE_PROFILES:-false}" = "true" ]; then
        compose_cmd="$compose_cmd -f $COMPOSE_PROFILES"
    else
        compose_cmd="$compose_cmd -f $COMPOSE_FILE"
    fi
    
    # Execute with error handling
    if ! $compose_cmd "$@" 2>&1 | tee -a "$LOG_DIR/docker-compose.log"; then
        error "Docker compose command failed: $*"
        return 1
    fi
}

# ============================================
# Service Health Monitoring
# ============================================
check_service_health() {
    local service=$1
    local check="${SERVICE_HEALTH[$service]:-}"
    
    if [ -z "$check" ]; then
        # Default: check if container is running
        if docker ps --format "{{.Names}}" | grep -q "^$service$"; then
            return 0
        else
            return 1
        fi
    fi
    
    # HTTP health check
    if [[ "$check" =~ ^https?:// ]]; then
        if curl -sf "$check" > /dev/null 2>&1; then
            return 0
        else
            return 1
        fi
    fi
    
    # Database check
    if [[ "$check" =~ pg_isready ]]; then
        if docker exec "$service" $check &>/dev/null; then
            return 0
        else
            return 1
        fi
    fi
    
    # Redis check
    if [[ "$check" =~ redis-cli ]]; then
        if docker exec "$service" $check &>/dev/null; then
            return 0
        else
            return 1
        fi
    fi
    
    return 1
}

wait_for_service() {
    local service=$1
    local max_wait=${2:-60}
    local elapsed=0
    
    log "Waiting for $service to be healthy..."
    
    while [ $elapsed -lt $max_wait ]; do
        if check_service_health "$service"; then
            success "$service is healthy"
            return 0
        fi
        sleep 2
        elapsed=$((elapsed + 2))
        echo -n "."
    done
    
    echo
    error "$service failed to become healthy after ${max_wait}s"
    return 1
}

# ============================================
# Main Commands
# ============================================
cmd_up() {
    local profile="${1:-all}"
    
    log "Starting HomeLabHub services (profile: $profile)"
    
    # Validate environment first
    if ! validate_environment; then
        error "Environment validation failed"
        return 1
    fi
    
    # Start services
    if [ "$profile" = "all" ] || [ -z "$profile" ]; then
        docker_compose up -d
    else
        USE_PROFILES=true docker_compose --profile="$profile" up -d
    fi
    
    # Wait for core services
    if [ "$profile" = "all" ] || [ "$profile" = "core" ]; then
        wait_for_service "homelab-postgres" 30
        wait_for_service "homelab-redis" 20
        wait_for_service "homelab-dashboard" 60
    fi
    
    success "Services started successfully"
    cmd_status
}

cmd_down() {
    log "Stopping HomeLabHub services"
    docker_compose down
    success "Services stopped"
}

cmd_restart() {
    local service="${1:-}"
    
    if [ -n "$service" ]; then
        log "Restarting $service"
        docker_compose restart "$service"
    else
        log "Restarting all services"
        cmd_down
        sleep 2
        cmd_up
    fi
}

cmd_status() {
    echo
    echo -e "${CYAN}╔════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║         Service Status Report          ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════╝${NC}"
    echo
    
    local running=0
    local stopped=0
    local unhealthy=0
    
    # Get all services
    local services=$(docker compose ps --format "{{.Service}}" 2>/dev/null || echo "")
    
    if [ -z "$services" ]; then
        warning "No services found. Run: $0 up"
        return
    fi
    
    for service in $services; do
        local status=$(docker compose ps --format "table {{.Service}}\t{{.Status}}" | grep "^$service" | awk '{print $2}')
        
        if [[ "$status" =~ Up ]]; then
            if check_service_health "$service"; then
                printf "%-25s ${GREEN}● Running (Healthy)${NC}\n" "$service"
                ((running++))
            else
                printf "%-25s ${YELLOW}● Running (Unhealthy)${NC}\n" "$service"
                ((unhealthy++))
            fi
        else
            printf "%-25s ${RED}○ Stopped${NC}\n" "$service"
            ((stopped++))
        fi
    done
    
    echo
    echo -e "${BOLD}Summary:${NC}"
    echo -e "  ${GREEN}Running:${NC} $running"
    echo -e "  ${YELLOW}Unhealthy:${NC} $unhealthy"
    echo -e "  ${RED}Stopped:${NC} $stopped"
    
    # Show URLs if services are running
    if [ $running -gt 0 ]; then
        echo
        echo -e "${BOLD}Access URLs:${NC}"
        [ $running -gt 0 ] && echo -e "  Dashboard: ${CYAN}https://host.evindrake.net${NC}"
        check_service_health "discord-bot" && echo -e "  Discord Bot: ${CYAN}https://bot.rig-city.com${NC}"
        check_service_health "stream-bot" && echo -e "  Stream Bot: ${CYAN}https://stream.rig-city.com${NC}"
    fi
}

cmd_logs() {
    local service="${1:-}"
    local lines="${2:-100}"
    
    if [ -n "$service" ]; then
        docker_compose logs --tail="$lines" -f "$service"
    else
        docker_compose logs --tail="$lines" -f
    fi
}

cmd_env() {
    local action="${1:-show}"
    
    case "$action" in
        init)
            log "Initializing environment configuration"
            if [ -f "scripts/validate-environment.py" ]; then
                python3 scripts/validate-environment.py --fix
            else
                error "Environment validator not found"
                return 1
            fi
            ;;
        
        validate)
            if [ -f "scripts/validate-environment.py" ]; then
                python3 scripts/validate-environment.py --validate
            else
                validate_environment
            fi
            ;;
        
        fix)
            log "Fixing environment issues"
            if [ -f "scripts/validate-environment.py" ]; then
                python3 scripts/validate-environment.py --generate
                success "Environment fixed"
            else
                error "Environment validator not found"
                return 1
            fi
            ;;
        
        backup)
            local backup_file="./var/backups/.env.$(date +%Y%m%d_%H%M%S)"
            if [ -f "$ENV_FILE" ]; then
                cp "$ENV_FILE" "$backup_file"
                success "Environment backed up to $backup_file"
            else
                error "No .env file to backup"
            fi
            ;;
        
        show)
            if [ -f "$ENV_FILE" ]; then
                info "Current environment (secrets hidden):"
                grep -E "^[A-Z]" "$ENV_FILE" | sed 's/=.*/=***/' | sort
            else
                error "No .env file found"
            fi
            ;;
        
        *)
            error "Unknown env action: $action"
            echo "Available: init, validate, fix, backup, show"
            return 1
            ;;
    esac
}

cmd_health() {
    echo
    echo -e "${CYAN}╔════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║         Health Check Report            ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════╝${NC}"
    echo
    
    for service in "${!SERVICE_HEALTH[@]}"; do
        if docker ps --format "{{.Names}}" | grep -q "^$service$"; then
            if check_service_health "$service"; then
                echo -e "$service: ${GREEN}✓ Healthy${NC}"
            else
                echo -e "$service: ${YELLOW}⚠ Unhealthy${NC}"
                
                # Show recent logs for unhealthy services
                echo -e "${YELLOW}  Recent logs:${NC}"
                docker logs --tail=5 "$service" 2>&1 | sed 's/^/    /'
            fi
        else
            echo -e "$service: ${RED}✗ Not running${NC}"
        fi
    done
}

cmd_backup() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_dir="./var/backups/$timestamp"
    
    log "Creating backup in $backup_dir"
    mkdir -p "$backup_dir"
    
    # Backup environment
    [ -f "$ENV_FILE" ] && cp "$ENV_FILE" "$backup_dir/.env"
    
    # Backup configs
    [ -f "Caddyfile" ] && cp "Caddyfile" "$backup_dir/"
    [ -f "$COMPOSE_FILE" ] && cp "$COMPOSE_FILE" "$backup_dir/"
    
    # Backup database
    if check_service_health "homelab-postgres"; then
        log "Backing up PostgreSQL databases..."
        docker exec homelab-postgres pg_dumpall -U postgres > "$backup_dir/postgres_backup.sql"
    fi
    
    success "Backup completed: $backup_dir"
}

cmd_profiles() {
    echo
    echo -e "${CYAN}Available Service Profiles:${NC}"
    echo
    
    for profile in "${!PROFILES[@]}"; do
        echo -e "  ${BOLD}$profile${NC}: ${PROFILES[$profile]}"
    done
    
    echo
    echo -e "${CYAN}Usage:${NC}"
    echo "  $0 up <profile>     # Start services for profile"
    echo "  $0 up all           # Start all services"
    echo "  $0 up core          # Start only core services"
}

cmd_fix() {
    log "Running automatic fixes..."
    
    # Fix environment
    cmd_env fix
    
    # Fix permissions
    log "Fixing file permissions..."
    chmod 600 "$ENV_FILE" 2>/dev/null || true
    chmod +x homelab* 2>/dev/null || true
    chmod +x scripts/*.sh 2>/dev/null || true
    chmod +x scripts/*.py 2>/dev/null || true
    
    # Clean up Docker
    log "Cleaning up Docker resources..."
    docker system prune -f --volumes 2>/dev/null || true
    
    # Restart services
    log "Restarting services..."
    cmd_restart
    
    success "Fixes applied"
}

# ============================================
# Main Entry Point
# ============================================
show_help() {
    cat << EOF
${CYAN}╔════════════════════════════════════════════════════════════════╗${NC}
${CYAN}║              HomeLabHub Management System v2.0                 ║${NC}
${CYAN}╚════════════════════════════════════════════════════════════════╝${NC}

${BOLD}Usage:${NC} $0 <command> [options]

${BOLD}Core Commands:${NC}
  up [profile]      Start services (default: all)
  down              Stop all services
  restart [service] Restart service(s)
  status            Show service status
  logs [service]    View logs (live tail)
  
${BOLD}Management:${NC}
  health            Run health checks
  fix               Auto-fix common issues
  backup            Create full backup
  profiles          List available profiles
  
${BOLD}Environment:${NC}
  env init          Initialize environment
  env validate      Validate configuration
  env fix           Fix missing variables
  env backup        Backup .env file
  env show          Show current config
  
${BOLD}Examples:${NC}
  $0 up core        # Start core services only
  $0 up bots        # Start bot services
  $0 logs discord-bot  # View Discord bot logs
  $0 env fix        # Fix environment issues
  $0 health         # Check service health

${BOLD}Profiles:${NC}
  core       Core services (required)
  bots       Discord and Stream bots
  media      Plex Media Server
  dev        Development tools
  automation n8n and Home Assistant
  storage    MinIO object storage
  web        Static websites
  all        Everything

EOF
}

# Initialize
init_directories

# Parse command
CMD="${1:-help}"
shift || true

case "$CMD" in
    up)         cmd_up "$@" ;;
    down)       cmd_down "$@" ;;
    restart)    cmd_restart "$@" ;;
    status)     cmd_status "$@" ;;
    logs)       cmd_logs "$@" ;;
    health)     cmd_health "$@" ;;
    fix)        cmd_fix "$@" ;;
    backup)     cmd_backup "$@" ;;
    profiles)   cmd_profiles "$@" ;;
    env)        cmd_env "$@" ;;
    help|--help|-h) show_help ;;
    *)
        error "Unknown command: $CMD"
        show_help
        exit 1
        ;;
esac