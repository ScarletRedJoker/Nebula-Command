{% extends "base.html" %}

{% block title %}Analysis Result - Jarvis Platform{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-search"></i> Deployment Analysis Result
            </h2>
        </div>
    </div>

    <!-- Analysis Status Card -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-code"></i> {{ artifact.original_filename }}
                    </h5>
                    <span id="analysisStatusBadge" class="badge bg-light text-dark">
                        {% if artifact.analysis_status == 'complete' %}
                            <i class="bi bi-check-circle-fill text-success"></i> Complete
                        {% elif artifact.analysis_status == 'analyzing' %}
                            <i class="bi bi-hourglass-split text-warning"></i> Analyzing...
                        {% elif artifact.analysis_status == 'pending' %}
                            <i class="bi bi-clock text-info"></i> Pending
                        {% elif artifact.analysis_status == 'failed' %}
                            <i class="bi bi-x-circle-fill text-danger"></i> Failed
                        {% endif %}
                    </span>
                </div>
                <div class="card-body">
                    <div id="analysisContent">
                        {% if artifact.analysis_status == 'complete' and artifact.analysis_result %}
                            <!-- Project Type Detection -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h5><i class="bi bi-diagram-3"></i> Detected Project Type</h5>
                                    <div class="alert alert-success d-flex align-items-center">
                                        <div class="me-3" style="font-size: 3rem;">
                                            {% if artifact.analysis_result.project_type == 'nodejs' %}
                                                <i class="bi bi-code-square"></i>
                                            {% elif artifact.analysis_result.project_type == 'python' %}
                                                <i class="bi bi-code-slash"></i>
                                            {% elif artifact.analysis_result.project_type == 'static' %}
                                                <i class="bi bi-file-earmark-code"></i>
                                            {% elif artifact.analysis_result.project_type == 'docker' %}
                                                <i class="bi bi-box"></i>
                                            {% elif artifact.analysis_result.project_type == 'php' %}
                                                <i class="bi bi-code"></i>
                                            {% elif artifact.analysis_result.project_type == 'java' %}
                                                <i class="bi bi-cup-hot"></i>
                                            {% elif artifact.analysis_result.project_type == 'go' %}
                                                <i class="bi bi-code-square"></i>
                                            {% elif artifact.analysis_result.project_type == 'rust' %}
                                                <i class="bi bi-gear"></i>
                                            {% else %}
                                                <i class="bi bi-question-circle"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h4 class="mb-1">{{ artifact.analysis_result.project_type|upper }}</h4>
                                            {% if artifact.detected_framework %}
                                                <p class="mb-0"><strong>Framework:</strong> {{ artifact.detected_framework }}</p>
                                            {% endif %}
                                            <p class="mb-0"><strong>Confidence:</strong> 
                                                <span class="badge bg-primary">{{ (artifact.analysis_result.confidence * 100)|round|int }}%</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5><i class="bi bi-info-circle"></i> Artifact Information</h5>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <th width="40%">Filename:</th>
                                                <td>{{ artifact.original_filename }}</td>
                                            </tr>
                                            <tr>
                                                <th>File Size:</th>
                                                <td>{{ (artifact.file_size / 1024 / 1024)|round(2) }} MB</td>
                                            </tr>
                                            <tr>
                                                <th>Uploaded:</th>
                                                <td>{{ artifact.uploaded_at }}</td>
                                            </tr>
                                            <tr>
                                                <th>Uploaded By:</th>
                                                <td>{{ artifact.uploaded_by }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Deployment Configuration -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5><i class="bi bi-gear"></i> Deployment Configuration</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p><strong>Runtime Version:</strong> {{ artifact.analysis_result.runtime_version or 'N/A' }}</p>
                                                    <p><strong>Port:</strong> {{ artifact.analysis_result.port }}</p>
                                                    <p><strong>Dependencies File:</strong> {{ artifact.analysis_result.dependencies_file or 'N/A' }}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p><strong>Build Command:</strong> <code>{{ artifact.analysis_result.build_command or 'None required' }}</code></p>
                                                    <p><strong>Start Command:</strong> <code>{{ artifact.analysis_result.start_command }}</code></p>
                                                    <p><strong>Static Files Dir:</strong> {{ artifact.analysis_result.static_files_dir or 'N/A' }}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Database Requirements -->
                            {% if artifact.requires_database %}
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="alert alert-warning">
                                        <h5><i class="bi bi-database"></i> Database Required</h5>
                                        <p class="mb-0">This project requires a database: <strong>{{ artifact.analysis_result.database_type or 'Unknown' }}</strong></p>
                                        <p class="mb-0"><small>You'll need to configure database credentials before deployment.</small></p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Recommendations -->
                            {% if artifact.analysis_result.recommendations %}
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5><i class="bi bi-lightbulb"></i> Recommendations</h5>
                                    <div class="alert alert-info">
                                        <ul class="mb-0">
                                            {% for recommendation in artifact.analysis_result.recommendations %}
                                                <li>{{ recommendation }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Action Buttons -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <a href="/uploads" class="btn btn-secondary">
                                            <i class="bi bi-arrow-left"></i> Back to Uploads
                                        </a>
                                        <button class="btn btn-primary" onclick="deployArtifact('{{ artifact.id }}')">
                                            <i class="bi bi-rocket"></i> Deploy Now
                                        </button>
                                    </div>
                                </div>
                            </div>

                        {% elif artifact.analysis_status == 'analyzing' %}
                            <div class="alert alert-info text-center">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Analyzing...</span>
                                </div>
                                <h5>Analysis in Progress</h5>
                                <p class="mb-0">Please wait while we analyze your artifact...</p>
                            </div>
                        {% elif artifact.analysis_status == 'pending' %}
                            <div class="alert alert-warning text-center">
                                <h5>Analysis Pending</h5>
                                <p class="mb-3">Analysis has not started yet.</p>
                                <button class="btn btn-primary" onclick="triggerAnalysis('{{ artifact.id }}')">
                                    <i class="bi bi-play"></i> Start Analysis
                                </button>
                            </div>
                        {% elif artifact.analysis_status == 'failed' %}
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-exclamation-triangle"></i> Analysis Failed</h5>
                                <p class="mb-0">{{ artifact.analysis_result.error if artifact.analysis_result else 'Unknown error occurred' }}</p>
                                <button class="btn btn-warning mt-3" onclick="triggerAnalysis('{{ artifact.id }}')">
                                    <i class="bi bi-arrow-repeat"></i> Retry Analysis
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/analysis.js"></script>
<script>
    const artifactId = '{{ artifact.id }}';
    
    // Poll for updates if analysis is in progress
    {% if artifact.analysis_status == 'analyzing' or artifact.analysis_status == 'pending' %}
    setInterval(() => {
        checkAnalysisStatus(artifactId);
    }, 3000);
    {% endif %}
</script>
{% endblock %}
