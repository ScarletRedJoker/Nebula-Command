{% extends "base.html" %}

{% block title %}Domain Management - NebulaCommand Dashboard{% endblock %}

{% block content %}
<div class="container-fluid domain-management-page">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-globe"></i> Domain Management</h2>
                    <p class="text-muted mb-0">Manage DNS records, SSL certificates, and reverse proxy configuration</p>
                </div>
                <button class="btn btn-primary btn-lg" onclick="showAddDomainModal()" aria-label="Add new domain">
                    <i class="bi bi-plus-circle" aria-hidden="true"></i> Add New Domain
                </button>
            </div>
        </div>
    </div>

    <!-- Domain Automation Setup Banner -->
    {% if not domain_automation_enabled %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <h4 class="alert-heading"><i class="bi bi-info-circle-fill"></i> Domain Automation Not Configured</h4>
                <p>Automated domain provisioning and DNS management requires ZoneEdit credentials.</p>
                <p>You can still manually manage domains, but automatic DNS updates and SSL provisioning will be unavailable.</p>
                <hr>
                <p class="mb-0">
                    <a href="https://www.zoneedit.com" target="_blank" class="btn btn-primary btn-sm">
                        <i class="bi bi-link-45deg me-2"></i>Get ZoneEdit Account
                    </a>
                    <a href="https://docs.zoneedit.com" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-book me-2"></i>Documentation
                    </a>
                </p>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card glassmorphic-panel">
                <div class="stat-icon bg-primary">
                    <i class="bi bi-server"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-domains">0</h3>
                    <p>Total Domains</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card glassmorphic-panel">
                <div class="stat-icon bg-success">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3 id="active-domains">0</h3>
                    <p>Active</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card glassmorphic-panel">
                <div class="stat-icon bg-info">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stat-content">
                    <h3 id="provisioning-domains">0</h3>
                    <p>Provisioning</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card glassmorphic-panel">
                <div class="stat-icon bg-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3 id="error-domains">0</h3>
                    <p>Errors</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-7">
            <div class="glassmorphic-panel domain-list-panel">
                <div class="panel-header">
                    <h5><i class="bi bi-list-ul"></i> Domain List</h5>
                    <div class="panel-actions">
                        <input type="text" class="form-control search-input" id="domain-search" placeholder="Search domains..." aria-label="Search domains">
                        <select class="form-select filter-select" id="service-type-filter" aria-label="Filter by service type">
                            <option value="">All Service Types</option>
                            <option value="web">Web</option>
                            <option value="api">API</option>
                            <option value="media">Media</option>
                            <option value="automation">Automation</option>
                            <option value="static">Static</option>
                            <option value="proxy">Proxy</option>
                        </select>
                        <select class="form-select filter-select" id="status-filter" aria-label="Filter by status">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="provisioning">Provisioning</option>
                            <option value="error">Error</option>
                            <option value="pending">Pending</option>
                        </select>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshDomains()" aria-label="Refresh domain list">
                            <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table domain-table">
                        <thead>
                            <tr>
                                <th scope="col" onclick="sortTable('status')" role="button" tabindex="0" aria-label="Sort by status">Status <i class="bi bi-chevron-expand" aria-hidden="true"></i></th>
                                <th scope="col" onclick="sortTable('domain')" role="button" tabindex="0" aria-label="Sort by domain">Domain <i class="bi bi-chevron-expand" aria-hidden="true"></i></th>
                                <th scope="col" onclick="sortTable('service_type')" role="button" tabindex="0" aria-label="Sort by service type">Service Type <i class="bi bi-chevron-expand" aria-hidden="true"></i></th>
                                <th scope="col" onclick="sortTable('ip')" role="button" tabindex="0" aria-label="Sort by IP address">IP Address <i class="bi bi-chevron-expand" aria-hidden="true"></i></th>
                                <th scope="col" onclick="sortTable('ssl')" role="button" tabindex="0" aria-label="Sort by SSL status">SSL <i class="bi bi-chevron-expand" aria-hidden="true"></i></th>
                                <th scope="col" onclick="sortTable('last_checked')" role="button" tabindex="0" aria-label="Sort by last checked">Last Checked <i class="bi bi-chevron-expand" aria-hidden="true"></i></th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="domains-tbody">
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading domains...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination-controls">
                    <button class="btn btn-sm btn-outline-secondary" id="prev-page" onclick="changePage(-1)" disabled aria-label="Go to previous page">
                        <i class="bi bi-chevron-left" aria-hidden="true"></i> Previous
                    </button>
                    <span class="page-info" id="page-info" role="status" aria-live="polite">Page 1 of 1</span>
                    <button class="btn btn-sm btn-outline-secondary" id="next-page" onclick="changePage(1)" disabled aria-label="Go to next page">
                        Next <i class="bi bi-chevron-right" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="glassmorphic-panel domain-detail-panel" id="domain-detail-panel" style="display: none;">
                <div class="panel-header">
                    <h5><i class="bi bi-info-circle"></i> Domain Details</h5>
                    <button class="btn btn-sm btn-close-panel" onclick="closeDetailPanel()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                
                <ul class="nav nav-tabs detail-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview-tab">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dns-tab">DNS</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ssl-tab">SSL</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#health-tab">Health</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#events-tab">Events</button>
                    </li>
                </ul>

                <div class="tab-content detail-tab-content">
                    <div class="tab-pane fade show active" id="overview-tab">
                        <div class="detail-section">
                            <h6>General Information</h6>
                            <dl class="row">
                                <dt class="col-sm-4">Domain:</dt>
                                <dd class="col-sm-8" id="detail-domain">-</dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8" id="detail-status">-</dd>
                                
                                <dt class="col-sm-4">Service Type:</dt>
                                <dd class="col-sm-8" id="detail-service-type">-</dd>
                                
                                <dt class="col-sm-4">Public IP:</dt>
                                <dd class="col-sm-8" id="detail-ip">-</dd>
                                
                                <dt class="col-sm-4">Container:</dt>
                                <dd class="col-sm-8" id="detail-container">-</dd>
                                
                                <dt class="col-sm-4">Internal Port:</dt>
                                <dd class="col-sm-8" id="detail-port">-</dd>
                                
                                <dt class="col-sm-4">Created:</dt>
                                <dd class="col-sm-8" id="detail-created">-</dd>
                                
                                <dt class="col-sm-4">Last Updated:</dt>
                                <dd class="col-sm-8" id="detail-updated">-</dd>
                            </dl>
                        </div>
                        <div class="detail-actions">
                            <button class="btn btn-primary btn-sm" onclick="editDomain()" aria-label="Edit domain settings">
                                <i class="bi bi-pencil" aria-hidden="true"></i> Edit
                            </button>
                            <button class="btn btn-success btn-sm" onclick="runHealthCheck()" aria-label="Refresh domain health check">
                                <i class="bi bi-heart-pulse" aria-hidden="true"></i> Refresh Health
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDeleteDomain()" aria-label="Delete domain">
                                <i class="bi bi-trash" aria-hidden="true"></i> Delete
                            </button>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="dns-tab">
                        <div class="detail-section">
                            <h6>DNS Records</h6>
                            <p class="text-muted small">Provider: <span id="dns-provider">ZoneEdit</span></p>
                            <div id="dns-records-list">
                                <div class="text-center py-3">
                                    <i class="bi bi-hourglass-split"></i> Loading DNS records...
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary mt-3" onclick="verifyDNS()" aria-label="Verify DNS records">
                                <i class="bi bi-arrow-repeat" aria-hidden="true"></i> Verify DNS
                            </button>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="ssl-tab">
                        <div class="detail-section">
                            <h6>SSL Certificate</h6>
                            <dl class="row">
                                <dt class="col-sm-6">Certificate Issuer:</dt>
                                <dd class="col-sm-6" id="ssl-issuer">Let's Encrypt</dd>
                                
                                <dt class="col-sm-6">Expiration Date:</dt>
                                <dd class="col-sm-6" id="ssl-expiry">-</dd>
                                
                                <dt class="col-sm-6">Days Remaining:</dt>
                                <dd class="col-sm-6" id="ssl-days-remaining">-</dd>
                                
                                <dt class="col-sm-6">Status:</dt>
                                <dd class="col-sm-6" id="ssl-status">-</dd>
                            </dl>
                            <button class="btn btn-sm btn-warning mt-3" onclick="forceSSLRenewal()" aria-label="Force SSL certificate renewal">
                                <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> Force Renewal
                            </button>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="health-tab">
                        <div class="detail-section">
                            <h6>Health Status</h6>
                            <dl class="row">
                                <dt class="col-sm-6">HTTP Status:</dt>
                                <dd class="col-sm-6" id="health-http-status">-</dd>
                                
                                <dt class="col-sm-6">Response Time:</dt>
                                <dd class="col-sm-6" id="health-response-time">-</dd>
                                
                                <dt class="col-sm-6">DNS Resolution:</dt>
                                <dd class="col-sm-6" id="health-dns-status">-</dd>
                                
                                <dt class="col-sm-6">Last Check:</dt>
                                <dd class="col-sm-6" id="health-last-check">-</dd>
                            </dl>
                            <button class="btn btn-sm btn-success mt-3" onclick="runHealthCheck()" aria-label="Run health check">
                                <i class="bi bi-heart-pulse" aria-hidden="true"></i> Run Health Check
                            </button>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="events-tab">
                        <div class="detail-section">
                            <h6>Event Log</h6>
                            <div id="events-list" class="events-list">
                                <div class="text-center py-3">
                                    <i class="bi bi-hourglass-split"></i> Loading events...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addDomainModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glassmorphic-panel">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="bi bi-plus-circle"></i> Add New Domain
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="domainForm">
                    <input type="hidden" id="domain-id" value="">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="domain-base" class="form-label">Base Domain <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="domain-base" placeholder="rig-city.com" required>
                            <div class="form-text">The root domain (e.g., example.com)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="domain-subdomain" class="form-label">Subdomain <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="domain-subdomain" placeholder="api or @" required>
                            <div class="form-text">Use @ for root domain</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="service-name" class="form-label">Service Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="service-name" placeholder="API Server" required>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="service-type-input" class="form-label">Service Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="service-type-input" required>
                                <option value="">Select type...</option>
                                <option value="web">Web Application</option>
                                <option value="api">API Server</option>
                                <option value="media">Media Server</option>
                                <option value="automation">Automation</option>
                                <option value="static">Static Site</option>
                                <option value="proxy">Reverse Proxy</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="internal-port" class="form-label">Internal Port</label>
                            <input type="number" class="form-control" id="internal-port" placeholder="80" value="80">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="container-name" class="form-label">Container Name</label>
                        <input type="text" class="form-control" id="container-name" placeholder="api-server">
                        <div class="form-text">Optional: Docker container name for reverse proxy</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="ssl-enabled" checked>
                                <label class="form-check-label" for="ssl-enabled">Enable SSL (HTTPS)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto-provision" checked>
                                <label class="form-check-label" for="auto-provision">Auto-Provision DNS</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="custom-caddy-config" class="form-label">Custom Caddy Configuration</label>
                        <textarea class="form-control" id="custom-caddy-config" rows="4" placeholder="header X-Custom-Header value&#10;tls admin@example.com"></textarea>
                        <div class="form-text">Optional: Additional Caddyfile directives</div>
                    </div>

                    <div class="mb-3">
                        <label for="domain-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="domain-notes" rows="2" placeholder="Optional notes about this domain"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancel domain creation">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitDomainBtn" onclick="submitDomain()" aria-label="Submit new domain">
                    <span class="btn-text">Add Domain</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteDomainModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glassmorphic-panel">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Delete Domain
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                <p>You are about to delete: <strong id="delete-domain-name"></strong></p>
                <p>The following will be removed:</p>
                <ul>
                    <li>DNS records from ZoneEdit</li>
                    <li>Caddy reverse proxy configuration</li>
                    <li>SSL certificate</li>
                    <li>All domain events and history</li>
                </ul>
                <p class="mt-3">Type <strong>DELETE</strong> to confirm:</p>
                <input type="text" class="form-control" id="delete-confirmation" placeholder="DELETE">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancel domain deletion">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="deleteDomain()" disabled aria-label="Confirm domain deletion">
                    Delete Domain
                </button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast" role="alert">
        <div class="toast-header">
            <i class="bi me-2" id="toast-icon"></i>
            <strong class="me-auto" id="toast-title">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-body"></div>
    </div>
</div>

<style>
.domain-management-page {
    padding: 20px;
}

.glassmorphic-panel {
    background: linear-gradient(145deg, rgba(26, 35, 50, 0.9), rgba(17, 24, 39, 0.9));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(96, 165, 250, 0.2);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px !important;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    color: white;
}

.stat-content h3 {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
}

.stat-content p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
}

.panel-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.search-input, .filter-select {
    max-width: 200px;
}

.domain-table {
    color: var(--text-primary);
}

.domain-table thead th {
    background: rgba(96, 165, 250, 0.1);
    border-bottom: 2px solid rgba(96, 165, 250, 0.3);
    cursor: pointer;
    user-select: none;
}

.domain-table tbody tr {
    border-bottom: 1px solid rgba(96, 165, 250, 0.1);
    transition: background 0.2s;
}

.domain-table tbody tr:hover {
    background: rgba(96, 165, 250, 0.05);
    cursor: pointer;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-active { background: rgba(52, 211, 153, 0.2); color: #34d399; }
.status-provisioning { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
.status-error { background: rgba(248, 113, 113, 0.2); color: #f87171; }
.status-pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }

.ssl-valid { color: #34d399; }
.ssl-expiring { color: #fbbf24; }
.ssl-invalid { color: #f87171; }

.pagination-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(96, 165, 250, 0.2);
}

.detail-tabs {
    border-bottom: 1px solid rgba(96, 165, 250, 0.3);
    margin-bottom: 20px;
}

.detail-tabs .nav-link {
    color: var(--text-secondary);
    border: none;
    border-bottom: 2px solid transparent;
}

.detail-tabs .nav-link.active {
    color: #60a5fa;
    background: transparent;
    border-bottom-color: #60a5fa;
}

.detail-section {
    padding: 15px 0;
}

.detail-section h6 {
    color: #60a5fa;
    font-weight: 600;
    margin-bottom: 15px;
}

.detail-section dl {
    margin-bottom: 0;
}

.detail-section dt {
    font-weight: 500;
    color: var(--text-secondary);
}

.detail-section dd {
    color: var(--text-primary);
}

.detail-actions {
    display: flex;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid rgba(96, 165, 250, 0.2);
}

.events-list {
    max-height: 300px;
    overflow-y: auto;
}

.event-item {
    padding: 10px;
    border-left: 3px solid rgba(96, 165, 250, 0.5);
    margin-bottom: 10px;
    background: rgba(96, 165, 250, 0.05);
    border-radius: 4px;
}

.event-item-success { border-left-color: #34d399; }
.event-item-error { border-left-color: #f87171; }
.event-item-warning { border-left-color: #fbbf24; }

.modal-content.glassmorphic-panel {
    border: 1px solid rgba(96, 165, 250, 0.3);
}

.btn-close-panel {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 1.2rem;
}

.btn-close-panel:hover {
    color: var(--text-primary);
}
</style>

<script src="{{ url_for('static', filename='js/domain_management.js') }}"></script>
{% endblock %}
