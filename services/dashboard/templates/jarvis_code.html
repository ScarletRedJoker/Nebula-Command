{% extends "base.html" %}

{% block title %}Jarvis Code - Nebula Command{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/docker.min.js"></script>
<style>
    .jarvis-code-container {
        display: grid;
        grid-template-columns: 280px 1fr 320px;
        gap: 16px;
        height: calc(100vh - 120px);
        padding: 16px;
    }
    
    .panel {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .panel-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        background: rgba(0,0,0,0.2);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
    }
    
    .project-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .project-item {
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 4px;
        transition: all 0.2s;
    }
    
    .project-item:hover {
        background: var(--bg-tertiary);
    }
    
    .project-item.active {
        background: rgba(96, 165, 250, 0.15);
        border-left: 3px solid var(--accent-blue);
    }
    
    .project-icon {
        font-size: 1.2rem;
    }
    
    .project-icon.python { color: #3776AB; }
    .project-icon.nodejs { color: #68A063; }
    .project-icon.rust { color: #DEA584; }
    .project-icon.go { color: #00ADD8; }
    .project-icon.static { color: #E34F26; }
    
    .project-meta {
        font-size: 0.75rem;
        color: var(--text-secondary);
        display: flex;
        gap: 8px;
    }
    
    .code-editor {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 13px;
        line-height: 1.5;
        background: #0d1117;
        color: #c9d1d9;
        border: none;
        resize: none;
        width: 100%;
        height: 100%;
        padding: 16px;
    }
    
    .code-editor:focus {
        outline: none;
    }
    
    .editor-toolbar {
        padding: 8px 12px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        background: rgba(0,0,0,0.2);
    }
    
    .terminal-output {
        background: #0d1117;
        color: #58a6ff;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 12px;
        line-height: 1.6;
        padding: 12px;
        flex: 1;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
    }
    
    .terminal-output .error { color: #f85149; }
    .terminal-output .success { color: #3fb950; }
    .terminal-output .warning { color: #d29922; }
    .terminal-output .info { color: #58a6ff; }
    
    .chat-input-container {
        padding: 12px;
        border-top: 1px solid var(--border-color);
    }
    
    .chat-input {
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px 12px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 14px;
        resize: none;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: var(--accent-blue);
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    
    .deploy-form {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .form-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }
    
    .file-path {
        font-size: 0.85rem;
        color: var(--accent-blue);
        padding: 6px 10px;
        background: rgba(96, 165, 250, 0.1);
        border-radius: 4px;
        margin-bottom: 8px;
    }
    
    .ai-response {
        background: var(--bg-tertiary);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .ai-response h4 {
        font-size: 0.9rem;
        margin-bottom: 8px;
        color: var(--accent-purple);
    }
    
    .scaffold-wizard {
        padding: 16px;
    }
    
    .template-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .template-card {
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .template-card:hover {
        border-color: var(--accent-blue);
    }
    
    .template-card.selected {
        border-color: var(--accent-blue);
        background: rgba(96, 165, 250, 0.1);
    }
    
    .template-card h5 {
        margin: 0 0 4px;
        font-size: 0.9rem;
    }
    
    .template-card p {
        margin: 0;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        background: rgba(0,0,0,0.2);
    }
    
    .tab {
        padding: 10px 16px;
        cursor: pointer;
        color: var(--text-secondary);
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }
    
    .tab:hover {
        color: var(--text-primary);
        background: rgba(255,255,255,0.05);
    }
    
    .tab.active {
        color: var(--accent-blue);
        border-bottom-color: var(--accent-blue);
    }
    
    .tab-content {
        display: none;
        height: 100%;
    }
    
    .tab-content.active {
        display: flex;
        flex-direction: column;
    }
    
    @media (max-width: 1200px) {
        .jarvis-code-container {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .panel {
            min-height: 400px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="jarvis-code-container">
    <div class="panel" id="projectPanel">
        <div class="panel-header">
            <i class="bi bi-folder2-open"></i>
            Projects
            <button class="btn btn-sm btn-outline-primary ms-auto" onclick="showScaffoldModal()">
                <i class="bi bi-plus"></i>
            </button>
        </div>
        <div class="panel-body">
            <ul class="project-list" id="projectList">
                <li class="text-center text-muted py-4">
                    <span class="loading-spinner"></span>
                    <div class="mt-2">Loading projects...</div>
                </li>
            </ul>
        </div>
        <div class="p-2 border-top" style="border-color: var(--border-color) !important;">
            <button class="btn btn-sm btn-outline-secondary w-100" onclick="refreshProjects()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
    
    <div class="panel" id="editorPanel">
        <div class="tabs">
            <div class="tab active" data-tab="editor" onclick="switchTab('editor')">
                <i class="bi bi-code-slash"></i> Editor
            </div>
            <div class="tab" data-tab="generate" onclick="switchTab('generate')">
                <i class="bi bi-magic"></i> Generate
            </div>
            <div class="tab" data-tab="review" onclick="switchTab('review')">
                <i class="bi bi-search"></i> Review
            </div>
        </div>
        
        <div id="editorTab" class="tab-content active">
            <div class="editor-toolbar">
                <div class="file-path" id="currentFilePath">No file selected</div>
                <button class="btn btn-sm btn-outline-secondary" onclick="saveFile()" id="saveBtn" disabled>
                    <i class="bi bi-save"></i> Save
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="showEditInstructions()" id="aiEditBtn" disabled>
                    <i class="bi bi-robot"></i> AI Edit
                </button>
            </div>
            <textarea class="code-editor" id="codeEditor" placeholder="Select a file to edit..." disabled></textarea>
        </div>
        
        <div id="generateTab" class="tab-content">
            <div class="panel-body">
                <div id="generatedCode" class="mb-3"></div>
            </div>
            <div class="chat-input-container">
                <label class="form-label">Describe the code you want to generate:</label>
                <textarea class="chat-input" id="generatePrompt" rows="3" placeholder="Create a Python function that validates email addresses..."></textarea>
                <div class="d-flex gap-2 mt-2">
                    <select class="form-select form-select-sm" id="generateLanguage" style="width: auto;">
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="typescript">TypeScript</option>
                        <option value="go">Go</option>
                        <option value="rust">Rust</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="bash">Bash</option>
                    </select>
                    <button class="btn btn-primary btn-sm ms-auto" onclick="generateCode()">
                        <i class="bi bi-magic"></i> Generate
                    </button>
                </div>
            </div>
        </div>
        
        <div id="reviewTab" class="tab-content">
            <div class="panel-body">
                <div id="codeReview">
                    <p class="text-muted text-center py-4">
                        Select a file and click "Review" to get AI code review
                    </p>
                </div>
            </div>
            <div class="p-3 border-top" style="border-color: var(--border-color) !important;">
                <button class="btn btn-info w-100" onclick="reviewCurrentFile()" id="reviewBtn" disabled>
                    <i class="bi bi-search"></i> Review Current File
                </button>
            </div>
        </div>
    </div>
    
    <div class="panel" id="actionsPanel">
        <div class="tabs">
            <div class="tab active" data-tab="terminal" onclick="switchRightTab('terminal')">
                <i class="bi bi-terminal"></i> Terminal
            </div>
            <div class="tab" data-tab="deploy" onclick="switchRightTab('deploy')">
                <i class="bi bi-cloud-upload"></i> Deploy
            </div>
            <div class="tab" data-tab="analyze" onclick="switchRightTab('analyze')">
                <i class="bi bi-graph-up"></i> Analyze
            </div>
        </div>
        
        <div id="terminalTab" class="tab-content active">
            <div class="terminal-output" id="terminalOutput">
                <span class="info">Jarvis Code Terminal Ready</span>
                <br>Type commands below to execute in project sandbox.
            </div>
            <div class="chat-input-container">
                <div class="input-group">
                    <span class="input-group-text" style="background: var(--bg-tertiary); border-color: var(--border-color); color: var(--accent-green);">$</span>
                    <input type="text" class="form-control" id="terminalInput" placeholder="Enter command..." style="background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary);">
                    <button class="btn btn-success" onclick="executeCommand()">
                        <i class="bi bi-play-fill"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="deployTab" class="tab-content">
            <div class="panel-body">
                <div class="deploy-form">
                    <div>
                        <label class="form-label">Target Host</label>
                        <input type="text" class="form-control" id="deployHost" placeholder="user@host.example.com">
                    </div>
                    <div>
                        <label class="form-label">Deploy Method</label>
                        <select class="form-select" id="deployMethod">
                            <option value="git">Git Push</option>
                            <option value="rsync">Rsync</option>
                        </select>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-primary w-100" onclick="deployProject()" id="deployBtn" disabled>
                            <i class="bi bi-cloud-upload"></i> Deploy Project
                        </button>
                    </div>
                    <hr>
                    <div>
                        <label class="form-label">Quick Actions</label>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="runTests()">
                                <i class="bi bi-check2-square"></i> Run Tests
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="gitStatus()">
                                <i class="bi bi-git"></i> Git Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="analyzeTab" class="tab-content">
            <div class="panel-body">
                <div id="analysisResult">
                    <p class="text-muted text-center py-4">
                        Select a project to analyze
                    </p>
                </div>
            </div>
            <div class="p-3 border-top" style="border-color: var(--border-color) !important;">
                <button class="btn btn-info w-100" onclick="analyzeCurrentProject()" id="analyzeBtn" disabled>
                    <i class="bi bi-graph-up"></i> Analyze Project
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="scaffoldModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-magic"></i> Create New Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body scaffold-wizard">
                <div class="mb-3">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="scaffoldName" placeholder="my-awesome-project">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="scaffoldDescription" rows="2" placeholder="A brief description of your project..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tech Stack</label>
                    <div class="template-grid" id="templateGrid">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createProject()">
                    <i class="bi bi-plus-circle"></i> Create Project
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editInstructionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-robot"></i> AI Edit Instructions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Describe the changes you want:</label>
                <textarea class="form-control" id="editInstructions" rows="4" placeholder="Add error handling, refactor the main function, etc."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyAIEdit()">
                    <i class="bi bi-magic"></i> Apply Edit
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentProject = null;
let currentFile = null;
let templates = [];

const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

async function apiCall(endpoint, method = 'GET', data = null) {
    const options = {
        method,
        headers: {
            'Content-Type': 'application/json'
        }
    };
    
    if (csrfToken) {
        options.headers['X-CSRFToken'] = csrfToken;
    }
    
    if (data) {
        options.body = JSON.stringify(data);
    }
    
    const response = await fetch(endpoint, options);
    return response.json();
}

async function refreshProjects() {
    const list = document.getElementById('projectList');
    list.innerHTML = '<li class="text-center text-muted py-4"><span class="loading-spinner"></span><div class="mt-2">Loading...</div></li>';
    
    try {
        const result = await apiCall('/api/jarvis/code/projects');
        
        if (result.success) {
            if (result.projects.length === 0) {
                list.innerHTML = '<li class="text-center text-muted py-4">No projects found<br><small>Click + to create one</small></li>';
            } else {
                list.innerHTML = result.projects.map(p => `
                    <li class="project-item ${currentProject === p.name ? 'active' : ''}" onclick="selectProject('${p.name}')">
                        <i class="bi bi-folder project-icon ${p.type}"></i>
                        <div>
                            <div>${p.name}</div>
                            <div class="project-meta">
                                <span>${p.type}</span>
                                ${p.has_git ? '<span><i class="bi bi-git"></i></span>' : ''}
                                ${p.has_docker ? '<span><i class="bi bi-box"></i></span>' : ''}
                            </div>
                        </div>
                    </li>
                `).join('');
            }
        } else {
            list.innerHTML = `<li class="text-center text-danger py-4">${result.error}</li>`;
        }
    } catch (e) {
        list.innerHTML = `<li class="text-center text-danger py-4">Error: ${e.message}</li>`;
    }
}

async function loadTemplates() {
    try {
        const result = await apiCall('/api/jarvis/code/templates');
        if (result.success) {
            templates = result.templates;
            renderTemplates();
        }
    } catch (e) {
        console.error('Error loading templates:', e);
    }
}

function renderTemplates() {
    const grid = document.getElementById('templateGrid');
    grid.innerHTML = templates.map(t => `
        <div class="template-card" data-template="${t.id}" onclick="selectTemplate('${t.id}')">
            <h5>${t.name}</h5>
            <p>${t.description}</p>
        </div>
    `).join('');
}

let selectedTemplate = null;

function selectTemplate(id) {
    selectedTemplate = id;
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.template === id);
    });
}

async function selectProject(name) {
    currentProject = name;
    currentFile = null;
    
    document.querySelectorAll('.project-item').forEach(item => {
        item.classList.toggle('active', item.textContent.includes(name));
    });
    
    document.getElementById('currentFilePath').textContent = `${name}/`;
    document.getElementById('codeEditor').value = '';
    document.getElementById('codeEditor').disabled = true;
    document.getElementById('saveBtn').disabled = true;
    document.getElementById('aiEditBtn').disabled = true;
    document.getElementById('reviewBtn').disabled = true;
    document.getElementById('deployBtn').disabled = false;
    document.getElementById('analyzeBtn').disabled = false;
    
    logTerminal(`Selected project: ${name}`, 'info');
}

async function analyzeCurrentProject() {
    if (!currentProject) return;
    
    const resultDiv = document.getElementById('analysisResult');
    resultDiv.innerHTML = '<p class="text-center py-4"><span class="loading-spinner"></span><br>Analyzing project...</p>';
    
    try {
        const result = await apiCall('/api/jarvis/code/analyze', 'POST', {
            project_path: currentProject
        });
        
        if (result.success) {
            let html = `<div class="ai-response">`;
            html += `<h4><i class="bi bi-folder"></i> ${currentProject}</h4>`;
            html += `<p><strong>Tech Stack:</strong> ${result.tech_stack.join(', ') || 'Unknown'}</p>`;
            html += `<p><strong>Files:</strong> ${result.files.length}</p>`;
            html += `<p><strong>Git:</strong> ${result.has_git ? 'Yes' : 'No'} | <strong>Docker:</strong> ${result.has_docker ? 'Yes' : 'No'}</p>`;
            
            if (result.dependencies) {
                html += `<p><strong>Dependencies:</strong></p><ul>`;
                for (const [pkg, deps] of Object.entries(result.dependencies)) {
                    if (deps.length > 0) {
                        html += `<li>${pkg}: ${deps.slice(0, 5).join(', ')}${deps.length > 5 ? '...' : ''}</li>`;
                    }
                }
                html += `</ul>`;
            }
            
            if (result.ai_analysis) {
                html += `<hr><h5>AI Analysis</h5>`;
                html += DOMPurify.sanitize(marked.parse(result.ai_analysis));
            }
            
            html += `</div>`;
            
            html += `<h6 class="mt-3">Files (click to edit)</h6>`;
            html += `<div class="list-group">`;
            result.files.slice(0, 20).forEach(f => {
                html += `<a href="#" class="list-group-item list-group-item-action" style="background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color);" onclick="loadFile('${currentProject}/${f}')">${f}</a>`;
            });
            if (result.files.length > 20) {
                html += `<div class="list-group-item text-muted" style="background: var(--bg-tertiary); border-color: var(--border-color);">... and ${result.files.length - 20} more files</div>`;
            }
            html += `</div>`;
            
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<p class="text-danger">${result.error}</p>`;
        }
    } catch (e) {
        resultDiv.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`;
    }
}

async function loadFile(filepath) {
    try {
        const result = await apiCall(`/api/jarvis/code/file?path=${encodeURIComponent(filepath)}`);
        
        if (result.success) {
            currentFile = filepath;
            document.getElementById('currentFilePath').textContent = filepath;
            document.getElementById('codeEditor').value = result.content;
            document.getElementById('codeEditor').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('aiEditBtn').disabled = false;
            document.getElementById('reviewBtn').disabled = false;
            
            switchTab('editor');
            logTerminal(`Loaded file: ${filepath}`, 'success');
        } else {
            logTerminal(`Error loading file: ${result.error}`, 'error');
        }
    } catch (e) {
        logTerminal(`Error: ${e.message}`, 'error');
    }
}

async function saveFile() {
    logTerminal('Save functionality coming soon...', 'warning');
}

function showEditInstructions() {
    if (!currentFile) return;
    const modal = new bootstrap.Modal(document.getElementById('editInstructionsModal'));
    modal.show();
}

async function applyAIEdit() {
    if (!currentFile) return;
    
    const instructions = document.getElementById('editInstructions').value;
    if (!instructions) return;
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('editInstructionsModal'));
    modal.hide();
    
    logTerminal(`Applying AI edit to ${currentFile}...`, 'info');
    
    try {
        const result = await apiCall('/api/jarvis/code/edit', 'POST', {
            filepath: currentFile,
            instructions: instructions
        });
        
        if (result.success) {
            document.getElementById('codeEditor').value = result.new_content;
            logTerminal(`AI edit applied successfully. Lines changed: ${result.lines_changed}`, 'success');
        } else {
            logTerminal(`Error: ${result.error}`, 'error');
        }
    } catch (e) {
        logTerminal(`Error: ${e.message}`, 'error');
    }
}

async function generateCode() {
    const prompt = document.getElementById('generatePrompt').value;
    const language = document.getElementById('generateLanguage').value;
    
    if (!prompt) return;
    
    const resultDiv = document.getElementById('generatedCode');
    resultDiv.innerHTML = '<p class="text-center py-4"><span class="loading-spinner"></span><br>Generating code...</p>';
    
    try {
        const result = await apiCall('/api/jarvis/code/generate', 'POST', {
            prompt: prompt,
            language: language
        });
        
        if (result.success) {
            const escapedCode = result.code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            resultDiv.innerHTML = `
                <div class="ai-response">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Generated ${language} Code</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyGeneratedCode()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                    <pre><code class="language-${language}" id="generatedCodeContent">${escapedCode}</code></pre>
                </div>
            `;
            hljs.highlightAll();
        } else {
            resultDiv.innerHTML = `<p class="text-danger">${result.error}</p>`;
        }
    } catch (e) {
        resultDiv.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`;
    }
}

function copyGeneratedCode() {
    const code = document.getElementById('generatedCodeContent').textContent;
    navigator.clipboard.writeText(code).then(() => {
        logTerminal('Code copied to clipboard', 'success');
    });
}

async function reviewCurrentFile() {
    if (!currentFile) return;
    
    const resultDiv = document.getElementById('codeReview');
    resultDiv.innerHTML = '<p class="text-center py-4"><span class="loading-spinner"></span><br>Reviewing code...</p>';
    
    switchTab('review');
    
    try {
        const result = await apiCall('/api/jarvis/code/review', 'POST', {
            filepath: currentFile
        });
        
        if (result.success) {
            resultDiv.innerHTML = `
                <div class="ai-response">
                    <h5><i class="bi bi-file-code"></i> ${result.filepath}</h5>
                    <p class="text-muted">${result.lines_of_code} lines of code</p>
                    <hr>
                    ${DOMPurify.sanitize(marked.parse(result.review))}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<p class="text-danger">${result.error}</p>`;
        }
    } catch (e) {
        resultDiv.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`;
    }
}

async function executeCommand() {
    const input = document.getElementById('terminalInput');
    const command = input.value.trim();
    
    if (!command) return;
    
    logTerminal(`$ ${command}`, 'info');
    input.value = '';
    
    try {
        const result = await apiCall('/api/jarvis/code/execute', 'POST', {
            command: command,
            project_path: currentProject
        });
        
        if (result.stdout) {
            logTerminal(result.stdout, 'success');
        }
        if (result.stderr) {
            logTerminal(result.stderr, result.success ? 'warning' : 'error');
        }
        if (!result.success && !result.stderr) {
            logTerminal(`Command failed with exit code ${result.return_code}`, 'error');
        }
    } catch (e) {
        logTerminal(`Error: ${e.message}`, 'error');
    }
}

async function deployProject() {
    if (!currentProject) return;
    
    const host = document.getElementById('deployHost').value;
    const method = document.getElementById('deployMethod').value;
    
    if (!host) {
        logTerminal('Please enter a target host', 'error');
        return;
    }
    
    logTerminal(`Deploying ${currentProject} to ${host}...`, 'info');
    
    try {
        const result = await apiCall('/api/jarvis/code/deploy', 'POST', {
            project_path: currentProject,
            target_host: host,
            deploy_method: method
        });
        
        if (result.success) {
            logTerminal('Deployment successful!', 'success');
            if (result.steps) {
                result.steps.forEach(step => logTerminal(`  âœ“ ${step}`, 'success'));
            }
        } else {
            logTerminal(`Deployment failed: ${result.error || result.output}`, 'error');
        }
    } catch (e) {
        logTerminal(`Error: ${e.message}`, 'error');
    }
}

async function runTests() {
    if (!currentProject) return;
    
    logTerminal(`Running tests for ${currentProject}...`, 'info');
    
    try {
        const result = await apiCall('/api/jarvis/code/tests', 'POST', {
            project_path: currentProject
        });
        
        if (result.success) {
            logTerminal('Tests passed!', 'success');
        } else {
            logTerminal('Tests failed', 'error');
        }
        
        if (result.stdout) {
            logTerminal(result.stdout, result.success ? 'success' : 'error');
        }
        if (result.stderr) {
            logTerminal(result.stderr, 'warning');
        }
    } catch (e) {
        logTerminal(`Error: ${e.message}`, 'error');
    }
}

async function gitStatus() {
    if (!currentProject) return;
    
    try {
        const result = await apiCall('/api/jarvis/code/execute', 'POST', {
            command: 'git status',
            project_path: currentProject
        });
        
        if (result.stdout) {
            logTerminal(result.stdout, 'info');
        }
        if (result.stderr) {
            logTerminal(result.stderr, 'error');
        }
    } catch (e) {
        logTerminal(`Error: ${e.message}`, 'error');
    }
}

function showScaffoldModal() {
    const modal = new bootstrap.Modal(document.getElementById('scaffoldModal'));
    modal.show();
}

async function createProject() {
    const name = document.getElementById('scaffoldName').value.trim();
    const description = document.getElementById('scaffoldDescription').value.trim();
    
    if (!name) {
        alert('Please enter a project name');
        return;
    }
    
    if (!selectedTemplate) {
        alert('Please select a tech stack');
        return;
    }
    
    try {
        const result = await apiCall('/api/jarvis/code/scaffold', 'POST', {
            name: name,
            description: description,
            tech_stack: selectedTemplate
        });
        
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('scaffoldModal'));
            modal.hide();
            
            logTerminal(`Created project: ${name}`, 'success');
            result.created_files.forEach(f => logTerminal(`  + ${f}`, 'success'));
            
            await refreshProjects();
            selectProject(name);
        } else {
            alert(`Error: ${result.error}`);
        }
    } catch (e) {
        alert(`Error: ${e.message}`);
    }
}

function logTerminal(message, type = 'info') {
    const terminal = document.getElementById('terminalOutput');
    const span = document.createElement('span');
    span.className = type;
    span.textContent = message + '\n';
    terminal.appendChild(span);
    terminal.scrollTop = terminal.scrollHeight;
}

function switchTab(tabName) {
    document.querySelectorAll('#editorPanel .tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
    });
    document.querySelectorAll('#editorPanel .tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabName + 'Tab');
    });
}

function switchRightTab(tabName) {
    document.querySelectorAll('#actionsPanel .tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
    });
    document.querySelectorAll('#actionsPanel .tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabName + 'Tab');
    });
}

document.getElementById('terminalInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        executeCommand();
    }
});

document.getElementById('generatePrompt').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
        generateCode();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    refreshProjects();
    loadTemplates();
});
</script>
{% endblock %}
