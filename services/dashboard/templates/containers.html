{% extends "base.html" %}

{% block title %}Containers - Homelab Dashboard{% endblock %}
{% block page_title %}Docker Containers{% endblock %}

{% block extra_css %}
<style>
    #container-list {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    #container-list .table {
        min-width: 800px;
        white-space: nowrap;
    }
    
    #container-list .table td {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    #container-list .table td:first-child {
        min-width: 150px;
    }

    /* ========== MOBILE RESPONSIVENESS ========== */

    /* Touch-friendly buttons on mobile */
    @media (max-width: 768px) {
        #container-list .btn-sm {
            min-width: 44px;
            min-height: 44px;
            padding: 10px 14px;
            font-size: 0.875rem;
            margin: 2px;
        }

        #container-list .table {
            min-width: 700px;
            font-size: 14px;
        }

        #container-list .table th,
        #container-list .table td {
            padding: 12px 8px;
        }

        /* Make badges more visible on mobile */
        .badge {
            padding: 6px 10px;
            font-size: 0.8rem;
            min-width: 70px;
            text-align: center;
        }

        /* Ensure card is full width on mobile */
        .card {
            margin-left: -10px;
            margin-right: -10px;
            border-radius: 0;
        }

        .card-header {
            font-size: 1.1rem;
            padding: 14px 16px;
        }
    }

    /* Very small screens - reduce table complexity */
    @media (max-width: 480px) {
        #container-list .table {
            min-width: 600px;
            font-size: 13px;
        }

        #container-list .table th,
        #container-list .table td {
            padding: 10px 6px;
        }

        #container-list .btn-sm {
            padding: 8px 12px;
            font-size: 0.75rem;
        }

        #container-list .btn-sm i {
            font-size: 0.85rem;
        }

        /* Stack buttons vertically for very small screens */
        #container-list .table td:last-child {
            min-width: 100px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card cosmic cosmic-fade-in mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-box-seam"></i>
            <span>Container Management</span>
        </div>
        <button class="btn btn-sm btn-primary" onclick="loadContainers()" aria-label="Refresh container list">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
    <div id="container-list">
        <div class="loading" role="status" aria-live="polite">
            <div class="spinner-border" aria-hidden="true"></div>
            <p style="margin-top: 20px; color: var(--text-secondary);">Loading containers...</p>
        </div>
    </div>
    
    <!-- Empty State (hidden by default) -->
    <div id="empty-state" class="text-center py-5" style="display: none;">
        <i class="bi bi-inbox display-1 text-muted" aria-hidden="true"></i>
        <h3 class="mt-3">No Containers Found</h3>
        <p class="text-muted">Your Docker environment has no containers yet.</p>
        <p class="text-muted small">Deploy some services to see them listed here.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadContainers() {
    const containerList = document.getElementById('container-list');
    const emptyState = document.getElementById('empty-state');
    
    try {
        const response = await fetch('/api/containers', {
            credentials: 'include'
        });
        const result = await response.json();
        
        if (!result.success) {
            containerList.innerHTML = `<div class="alert alert-danger" role="alert">${result.message || 'Failed to load containers'}</div>`;
            emptyState.style.display = 'none';
            showToast(result.message || 'Failed to load containers', 'error');
            return;
        }
        
        const containers = result.data || [];
        
        if (!Array.isArray(containers) || containers.length === 0) {
            containerList.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        containerList.style.display = 'block';
        
        let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr>';
        html += '<th scope="col">Name</th>';
        html += '<th scope="col">Image</th>';
        html += '<th scope="col">Status</th>';
        html += '<th scope="col">Ports</th>';
        html += '<th scope="col">Actions</th>';
        html += '</tr></thead><tbody>';
        
        containers.forEach(container => {
            const status = (container.status || '').toLowerCase();
            const isRunning = status.includes('up') || status.includes('running');
            const isExited = status.includes('exited') || status.includes('stopped');
            const statusBadge = isRunning ? 'badge-success' : isExited ? 'badge-danger' : 'badge-warning';
            const containerId = container.id || '';
            const containerName = container.name || 'Unknown';
            
            html += '<tr>';
            html += `<td><strong>${containerName}</strong></td>`;
            html += `<td style="color: var(--text-secondary); font-size: 0.9rem;">${container.image || 'Unknown'}</td>`;
            html += `<td><span class="badge ${statusBadge}">${container.status || 'Unknown'}</span></td>`;
            html += `<td style="color: var(--text-secondary); font-size: 0.85rem;">${formatPorts(container.ports)}</td>`;
            html += '<td>';
            
            if (isRunning) {
                html += `<button class="btn btn-warning btn-sm" onclick="stopContainer('${containerId}', this)" aria-label="Stop ${containerName}"><i class="bi bi-stop-fill" aria-hidden="true"></i> Stop</button> `;
                html += `<button class="btn btn-warning btn-sm" onclick="restartContainer('${containerId}', this)" aria-label="Restart ${containerName}"><i class="bi bi-arrow-clockwise" aria-hidden="true"></i> Restart</button>`;
            } else {
                html += `<button class="btn btn-success btn-sm" onclick="startContainer('${containerId}', this)" aria-label="Start ${containerName}"><i class="bi bi-play-fill" aria-hidden="true"></i> Start</button>`;
            }
            
            html += ` <button class="btn btn-primary btn-sm" onclick="viewLogs('${containerName}')" aria-label="View logs for ${containerName}"><i class="bi bi-file-text" aria-hidden="true"></i> Logs</button>`;
            html += '</td>';
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        containerList.innerHTML = html;
        
    } catch (error) {
        console.error('Failed to load containers:', error);
        containerList.innerHTML = '<div class="alert alert-danger" role="alert">Failed to load containers. Check API connection.</div>';
        emptyState.style.display = 'none';
        showToast('Failed to load containers. Check API connection.', 'error');
    }
}

function formatPorts(ports) {
    if (!ports || ports.length === 0) return '-';
    return ports.map(p => `${p.host || ''}:${p.container || ''}`).join(', ');
}

async function startContainer(id, button) {
    if (!confirm('Start this container?')) return;
    
    setButtonLoading(button, true);
    
    try {
        const response = await fetch(`/api/containers/${id}/start`, { 
            method: 'POST',
            credentials: 'include'
        });
        const result = await response.json();
        
        if (result.error) {
            showToast('Error: ' + result.error, 'error');
        } else {
            showToast('Container started successfully', 'success');
            setTimeout(loadContainers, 1000);
        }
    } catch (error) {
        showToast('Failed to start container: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

async function stopContainer(id, button) {
    if (!confirm('Stop this container?')) return;
    
    setButtonLoading(button, true);
    
    try {
        const response = await fetch(`/api/containers/${id}/stop`, { 
            method: 'POST',
            credentials: 'include'
        });
        const result = await response.json();
        
        if (result.error) {
            showToast('Error: ' + result.error, 'error');
        } else {
            showToast('Container stopped successfully', 'success');
            setTimeout(loadContainers, 1000);
        }
    } catch (error) {
        showToast('Failed to stop container: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

async function restartContainer(id, button) {
    if (!confirm('Restart this container?')) return;
    
    setButtonLoading(button, true);
    
    try {
        const response = await fetch(`/api/containers/${id}/restart`, { 
            method: 'POST',
            credentials: 'include'
        });
        const result = await response.json();
        
        if (result.error) {
            showToast('Error: ' + result.error, 'error');
        } else {
            showToast('Container restarted successfully', 'success');
            setTimeout(loadContainers, 1000);
        }
    } catch (error) {
        showToast('Failed to restart container: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

function viewLogs(name) {
    window.location.href = `/logs?container=${name}`;
}

document.addEventListener('DOMContentLoaded', function() {
    loadContainers();
    setInterval(loadContainers, 15000);
});
</script>
{% endblock %}
