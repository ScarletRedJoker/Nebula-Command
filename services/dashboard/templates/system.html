{% extends "base.html" %}

{% block title %}System Diagnostics - NebulaCommand Dashboard{% endblock %}
{% block page_title %}<i class="bi bi-cpu"></i> System Diagnostics{% endblock %}

{% block content %}
<div class="led-panel mb-4">
    <div class="led-group">
        <div class="led-label">CPU</div>
        <span class="status-led online" id="cpu-led"></span>
    </div>
    <div class="led-group">
        <div class="led-label">MEMORY</div>
        <span class="status-led warning" id="mem-led"></span>
    </div>
    <div class="led-group">
        <div class="led-label">DISK</div>
        <span class="status-led online" id="disk-led"></span>
    </div>
    <div class="led-group">
        <div class="led-label">NETWORK</div>
        <span class="status-led active blink" id="net-led"></span>
    </div>
    <div class="led-group">
        <div class="led-label">I/O</div>
        <span class="hex-led" id="io-led"></span>
    </div>
    <div class="led-group">
        <div class="led-label">TEMP</div>
        <span class="hex-led" id="temp-led"></span>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="metric-display glow-border">
            <span class="status-led active blink"></span>
            <div style="flex: 1; text-align: center;">
                <div class="metric-label">HOSTNAME</div>
                <div class="data-readout" id="hostname" style="font-size: 0.9rem;">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="metric-display glow-border">
            <span class="status-led online"></span>
            <div style="flex: 1; text-align: center;">
                <div class="metric-label">UPTIME</div>
                <div class="data-readout" id="uptime" style="font-size: 0.9rem;">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="metric-display glow-border">
            <span class="hex-led"></span>
            <div style="flex: 1; text-align: center;">
                <div class="metric-label">SYSTEM</div>
                <div class="data-readout" id="os" style="font-size: 0.9rem;">UBUNTU 25.10</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="metric-display glow-border">
            <span class="status-led online blink"></span>
            <div style="flex: 1; text-align: center;">
                <div class="metric-label">CPU CORES</div>
                <div class="data-readout" id="cpu-cores" style="font-size: 0.9rem;">-</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="diagnostic-panel">
            <div class="diagnostic-header">
                <span class="status-led online"></span>
                <h5 style="margin: 0; font-weight: 600;">CPU MONITORING</h5>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">CURRENT USAGE</div>
                        <div class="data-readout" id="cpu-usage">-</div>
                    </div>
                    <span class="status-led online blink"></span>
                </div>
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">PHYSICAL CORES</div>
                        <div class="data-readout" id="cpu-physical">-</div>
                    </div>
                    <span class="hex-led"></span>
                </div>
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">LOGICAL CORES</div>
                        <div class="data-readout" id="cpu-logical">-</div>
                    </div>
                    <span class="hex-led"></span>
                </div>
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">LOAD AVERAGE</div>
                        <div class="data-readout" id="cpu-load">- - -</div>
                    </div>
                    <span class="status-led active"></span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="diagnostic-panel">
            <div class="diagnostic-header">
                <span class="status-led warning"></span>
                <h5 style="margin: 0; font-weight: 600;">MEMORY STATUS</h5>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">TOTAL RAM</div>
                        <div class="data-readout" id="mem-total">-</div>
                    </div>
                    <span class="hex-led"></span>
                </div>
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">USED</div>
                        <div class="data-readout" id="mem-used">-</div>
                    </div>
                    <span class="status-led warning"></span>
                </div>
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">AVAILABLE</div>
                        <div class="data-readout" id="mem-available">-</div>
                    </div>
                    <span class="status-led online"></span>
                </div>
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">USAGE PERCENTAGE</div>
                        <div class="data-readout" id="mem-percent">-</div>
                        <div class="progress-led" style="margin-top: 8px;">
                            <div class="progress-led-fill" id="mem-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <span class="status-led warning blink"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="diagnostic-panel">
            <div class="diagnostic-header">
                <span class="hex-led"></span>
                <h5 style="margin: 0; font-weight: 600;">DISK STORAGE</h5>
            </div>
            <div id="disk-details">
                <div class="loading">
                    <div class="spinner-border"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="diagnostic-panel">
            <div class="diagnostic-header">
                <span class="status-led active blink"></span>
                <h5 style="margin: 0; font-weight: 600;">NETWORK TRAFFIC</h5>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">DATA SENT</div>
                        <div class="data-readout" id="net-sent">-</div>
                    </div>
                    <span class="status-led active"></span>
                </div>
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">DATA RECEIVED</div>
                        <div class="data-readout" id="net-recv">-</div>
                    </div>
                    <span class="status-led active"></span>
                </div>
                <div class="metric-display">
                    <div style="flex: 1;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">TOTAL TRAFFIC</div>
                        <div class="data-readout" id="net-total">-</div>
                    </div>
                    <span class="status-led active blink"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="control-panel-card">
            <div class="diagnostic-header">
                <span class="hex-led"></span>
                <h5 style="margin: 0; font-weight: 600;">PROCESS MONITORING</h5>
                <div style="margin-left: auto;">
                    <div class="activity-indicator">
                        <span class="activity-dot"></span>
                        <span>COMING SOON</span>
                    </div>
                </div>
            </div>
            <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                <p>Advanced process monitoring and management will be available in the next update.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function updateSystemInfo() {
    try {
        const response = await fetch('/api/system/stats', {
            credentials: 'include'
        });
        const result = await response.json();
        
        if (!result.success || !result.data) {
            console.error('Error loading system info');
            return;
        }
        
        const data = result.data;
        
        document.getElementById('hostname').textContent = (data.hostname || '-').toUpperCase();
        document.getElementById('uptime').textContent = formatUptime(data.uptime || 0);
        document.getElementById('cpu-cores').textContent = data.cpu_count || '-';
        
        document.getElementById('cpu-usage').textContent = data.cpu_percent.toFixed(1) + '%';
        document.getElementById('cpu-physical').textContent = data.cpu_count || '-';
        document.getElementById('cpu-logical').textContent = data.cpu_count || '-';
        
        const cpuLed = document.getElementById('cpu-led');
        if (data.cpu_percent > 80) {
            cpuLed.className = 'status-led offline blink';
        } else if (data.cpu_percent > 60) {
            cpuLed.className = 'status-led warning';
        } else {
            cpuLed.className = 'status-led online';
        }
        
        const memTotalGB = (data.memory_total / (1024**3)).toFixed(2);
        const memUsedGB = (data.memory_used / (1024**3)).toFixed(2);
        const memAvailableGB = (data.memory_available / (1024**3)).toFixed(2);
        
        document.getElementById('mem-total').textContent = memTotalGB + ' GB';
        document.getElementById('mem-used').textContent = memUsedGB + ' GB';
        document.getElementById('mem-available').textContent = memAvailableGB + ' GB';
        document.getElementById('mem-percent').textContent = data.memory_percent.toFixed(1) + '%';
        document.getElementById('mem-bar').style.width = data.memory_percent + '%';
        
        const memLed = document.getElementById('mem-led');
        if (data.memory_percent > 80) {
            memLed.className = 'status-led offline blink';
        } else if (data.memory_percent > 60) {
            memLed.className = 'status-led warning';
        } else {
            memLed.className = 'status-led online';
        }
        
        document.getElementById('net-sent').textContent = data.network_sent_mb.toFixed(2) + ' MB';
        document.getElementById('net-recv').textContent = data.network_recv_mb.toFixed(2) + ' MB';
        const totalNet = data.network_sent_mb + data.network_recv_mb;
        document.getElementById('net-total').textContent = totalNet.toFixed(2) + ' MB';
        
    } catch (error) {
        console.error('Failed to update system info:', error);
    }
}

async function loadDiskInfo() {
    try {
        const response = await fetch('/api/system/disk', {
            credentials: 'include'
        });
        const result = await response.json();
        
        if (!result.success) {
            console.error('Error loading disks');
            return;
        }
        
        const disks = result.data || [];
        let html = '';
        
        if (Array.isArray(disks) && disks.length > 0) {
            disks.forEach(disk => {
                const percent = disk.percent || 0;
                let ledClass = 'status-led online';
                if (percent > 80) ledClass = 'status-led offline';
                else if (percent > 60) ledClass = 'status-led warning';
                
                html += `
                    <div class="metric-display" style="margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">${disk.mountpoint}</div>
                            <div class="data-readout" style="font-size: 0.85rem;">${disk.used_gb}GB / ${disk.total_gb}GB (${percent.toFixed(1)}%)</div>
                            <div class="progress-led" style="margin-top: 8px;">
                                <div class="progress-led-fill" style="width: ${percent}%;"></div>
                            </div>
                        </div>
                        <span class="${ledClass}"></span>
                    </div>
                `;
            });
            
            const avgPercent = disks.reduce((sum, d) => sum + d.percent, 0) / disks.length;
            const diskLed = document.getElementById('disk-led');
            if (avgPercent > 80) {
                diskLed.className = 'status-led offline blink';
            } else if (avgPercent > 60) {
                diskLed.className = 'status-led warning';
            } else {
                diskLed.className = 'status-led online';
            }
        } else {
            html = '<p style="color: var(--text-secondary); padding: 20px;">No disk information available</p>';
        }
        
        document.getElementById('disk-details').innerHTML = html;
        
    } catch (error) {
        console.error('Failed to load disk info:', error);
    }
}

function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (days > 0) {
        return `${days}D ${hours}H ${minutes}M`;
    } else if (hours > 0) {
        return `${hours}H ${minutes}M`;
    } else {
        return `${minutes}M`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updateSystemInfo();
    loadDiskInfo();
    
    setInterval(updateSystemInfo, 5000);
    setInterval(loadDiskInfo, 30000);
});
</script>
{% endblock %}
