{% extends "base.html" %}

{% block title %}Game Streaming - Nebula Command{% endblock %}

{% block extra_css %}
<style>
    .streaming-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid #28a745;
    }
    
    .streaming-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .platform-badge {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
        margin: 0.2rem;
        display: inline-block;
    }
    
    .connection-code {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }
    
    .latency-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .latency-good { background-color: #28a745; }
    .latency-fair { background-color: #ffc107; }
    .latency-poor { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-controller"></i> Game Streaming</h1>
        <div>
            <button class="btn btn-success me-2" onclick="showSetupWizard()">
                <i class="bi bi-magic"></i> Setup Sunshine
            </button>
            <button class="btn btn-primary" onclick="loadHosts()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <a href="/static/MOONLIGHT_SETUP.md" target="_blank" class="btn btn-outline-primary">
                <i class="bi bi-book"></i> Setup Guide
            </a>
        </div>
    </div>

    <!-- Auto-Discovery Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-search"></i> Auto-Discovery</h5>
                    <button class="btn btn-sm btn-success" onclick="discoverHosts()">
                        <i class="bi bi-radar"></i> Scan Network
                    </button>
                </div>
                <div class="card-body">
                    <div id="discovery-status" class="alert alert-info" style="display:none;">
                        <i class="bi bi-hourglass-split"></i> Scanning network for Sunshine hosts...
                    </div>
                    <p class="text-muted">Automatically discover Sunshine hosts on your local network. This will scan for devices running Sunshine on standard ports.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Host Management Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-pc-display"></i> Configured Hosts</h5>
                    <button class="btn btn-sm btn-primary" onclick="showAddHostModal()">
                        <i class="bi bi-plus-circle"></i> Add Host
                    </button>
                </div>
                <div class="card-body">
                    <div id="hosts-table-container">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Host Name</th>
                                    <th>IP Address</th>
                                    <th>GPU</th>
                                    <th>Status</th>
                                    <th>Paired</th>
                                    <th>Last Online</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="hosts-table-body">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="bi bi-inbox"></i> No hosts configured. Click "Add Host" or "Scan Network" to get started.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Diagnostics Panel -->
    <div class="row mb-4" id="diagnostics-panel" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-shield-check"></i> Diagnostics Results</h5>
                </div>
                <div class="card-body">
                    <div id="diagnostics-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- App & Game Management -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-controller"></i> App & Game Management</h5>
                    <div>
                        <select class="form-select form-select-sm d-inline-block me-2" style="width: auto;" id="app-host-selector">
                            <option value="">-- Select Host --</option>
                        </select>
                        <button class="btn btn-sm btn-success" onclick="GameStreaming.showAddAppModal()" id="add-app-btn" disabled>
                            <i class="bi bi-plus-circle"></i> Add App
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="GameStreaming.loadApps()" id="refresh-apps-btn" disabled>
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="apps-loading" class="text-center py-4" style="display:none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading apps...</p>
                    </div>
                    
                    <div id="apps-container">
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> Select a Sunshine host above to view and manage apps/games
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Streaming Sessions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-broadcast"></i> Active Streaming Sessions</h5>
                    <button class="btn btn-sm btn-primary" onclick="GameStreaming.refreshActiveSessions()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="active-sessions-container">
                        <div class="alert alert-secondary mb-0">
                            <i class="bi bi-info-circle"></i> No active streaming sessions
                        </div>
                    </div>
                    
                    <!-- Detailed Session Telemetry -->
                    <div id="session-telemetry-container" class="mt-3">
                        <!-- Populated by loadDetailedTelemetry() -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Streaming Session Management -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-controller"></i> Streaming Session Management</h5>
                </div>
                <div class="card-body">
                    <!-- Session Control Panel -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="session-host-selector" class="form-label">
                                <i class="bi bi-pc-display"></i> Select Host
                            </label>
                            <select class="form-select" id="session-host-selector" onchange="SessionManagement.onHostSelected()">
                                <option value="">-- Select a host --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="session-app-selector" class="form-label">
                                <i class="bi bi-app"></i> Select App/Game
                            </label>
                            <select class="form-select" id="session-app-selector" disabled>
                                <option value="">-- Select host first --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="session-device-name" class="form-label">
                                <i class="bi bi-phone"></i> Client Device Name
                            </label>
                            <input type="text" class="form-control" id="session-device-name" placeholder="e.g., Living Room Shield TV">
                        </div>
                        <div class="col-md-6">
                            <label for="session-resolution" class="form-label">
                                <i class="bi bi-aspect-ratio"></i> Resolution
                            </label>
                            <select class="form-select" id="session-resolution">
                                <option value="3840x2160">4K (3840x2160)</option>
                                <option value="2560x1440">1440p (2560x1440)</option>
                                <option value="1920x1080" selected>1080p (1920x1080)</option>
                                <option value="1280x720">720p (1280x720)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Session Action Buttons -->
                    <div class="mb-3">
                        <button class="btn btn-success me-2" id="start-session-btn" onclick="SessionManagement.startSession()" disabled>
                            <i class="bi bi-play-circle"></i> Start Session
                        </button>
                        <button class="btn btn-danger" id="stop-session-btn" onclick="SessionManagement.stopSession()" style="display:none;">
                            <i class="bi bi-stop-circle"></i> Stop Session
                        </button>
                    </div>
                    
                    <!-- Current Session Card -->
                    <div id="current-session-card" style="display:none;">
                        <div class="card bg-light">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <span class="latency-indicator latency-good"></span>
                                    Current Session
                                </h6>
                                <span class="badge bg-success" id="session-status-badge">Active</span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong><i class="bi bi-clock"></i> Duration:</strong>
                                            <span id="session-duration" class="text-primary">0s</span>
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="bi bi-app"></i> App/Game:</strong>
                                            <span id="session-app-name">-</span>
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="bi bi-pc-display"></i> Host:</strong>
                                            <span id="session-host-name">-</span>
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="bi bi-phone"></i> Client Device:</strong>
                                            <span id="session-client-device">-</span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong><i class="bi bi-aspect-ratio"></i> Resolution:</strong>
                                            <span id="session-current-resolution">-</span>
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="bi bi-speedometer"></i> FPS:</strong>
                                            <span id="session-current-fps">-</span>
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="bi bi-broadcast"></i> Bitrate:</strong>
                                            <span id="session-current-bitrate">-</span>
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="bi bi-lightning"></i> Latency:</strong>
                                            <span id="session-current-latency">-</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>Session ID:</strong> <code id="session-id-display">-</code>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quality Presets -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-sliders"></i> Streaming Quality Presets</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="quality-preset-card" onclick="GameStreaming.applyQualityPreset('ultra')">
                                <div class="preset-name">Ultra (4K60)</div>
                                <div class="preset-details">
                                    <small>3840x2160 @ 60fps</small><br>
                                    <small>80 Mbps, HEVC</small>
                                </div>
                                <div class="preset-badge"><span class="badge bg-danger">High Quality</span></div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="quality-preset-card" onclick="GameStreaming.applyQualityPreset('high')">
                                <div class="preset-name">High (1440p60)</div>
                                <div class="preset-details">
                                    <small>2560x1440 @ 60fps</small><br>
                                    <small>40 Mbps, HEVC</small>
                                </div>
                                <div class="preset-badge"><span class="badge bg-warning">Recommended</span></div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="quality-preset-card" onclick="GameStreaming.applyQualityPreset('balanced')">
                                <div class="preset-name">Balanced (1080p60)</div>
                                <div class="preset-details">
                                    <small>1920x1080 @ 60fps</small><br>
                                    <small>20 Mbps, H.264</small>
                                </div>
                                <div class="preset-badge"><span class="badge bg-success">Balanced</span></div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="quality-preset-card" onclick="GameStreaming.applyQualityPreset('performance')">
                                <div class="preset-name">Performance (1080p30)</div>
                                <div class="preset-details">
                                    <small>1920x1080 @ 30fps</small><br>
                                    <small>10 Mbps, H.264</small>
                                </div>
                                <div class="preset-badge"><span class="badge bg-info">Low Latency</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Quality Configuration Display -->
                    <div id="current-quality-config" class="mt-3">
                        <div class="alert alert-secondary mb-0">
                            <small><i class="bi bi-info-circle"></i> Loading current configuration...</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-success mt-3 mb-0">
                        <i class="bi bi-check-circle"></i> <strong>Click a preset above</strong> to automatically configure your Sunshine host. The settings will be applied directly to the server.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session History -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Sessions</h5>
                    <button class="btn btn-sm btn-primary" onclick="SessionManagement.loadRecentSessions()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Host</th>
                                <th>App/Game</th>
                                <th>Duration</th>
                                <th>Avg Quality</th>
                                <th>Data Streamed</th>
                                <th>Client</th>
                                <th>Outcome</th>
                                <th>Started</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-table-body">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-inbox"></i> No recent sessions
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Monitoring Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Performance Monitoring</h5>
                    <div>
                        <span class="badge bg-secondary" id="monitor-status">Not Monitoring</span>
                        <button class="btn btn-sm btn-success ms-2" onclick="toggleMonitoring()" id="monitor-toggle-btn">
                            <i class="bi bi-play-fill"></i> Start Monitoring
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Host Selector -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="monitor-host-selector" class="form-label">
                                <i class="bi bi-pc-display"></i> Select Host to Monitor
                            </label>
                            <select class="form-select" id="monitor-host-selector">
                                <option value="">-- Select a Sunshine host --</option>
                            </select>
                            <small class="text-muted">Choose which Sunshine host to monitor in real-time</small>
                        </div>
                        <div class="col-md-6">
                            <div id="monitor-error-alert" class="alert alert-danger mt-4" style="display:none;"></div>
                        </div>
                    </div>
                    
                    <!-- Real-time Stats -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">Active Sessions</div>
                                <div class="stat-value" id="stat-active-sessions">0</div>
                                <small class="text-muted">Currently streaming</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">GPU Utilization</div>
                                <div class="stat-value" id="stat-gpu-util">
                                    <span id="gpu-util-value">0</span>%
                                </div>
                                <small class="text-muted">NVENC encoder</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">Network Latency</div>
                                <div class="stat-value" id="stat-latency">
                                    <span id="latency-value">--</span><span style="font-size: 1.2rem;">ms</span>
                                </div>
                                <small class="text-muted">Average ping</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">Streaming Quality</div>
                                <div class="stat-value" id="stat-quality">
                                    <span id="quality-value">--</span><span style="font-size: 1.2rem;">p</span>
                                </div>
                                <small class="text-muted" id="quality-fps">@ -- FPS</small>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Charts -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>GPU Utilization Over Time</h6>
                            <canvas id="gpuUtilChart" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h6>Network Latency</h6>
                            <canvas id="latencyChart" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Detailed Metrics -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Encoder Stats</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>Session Count</td>
                                    <td class="text-end"><strong id="encoder-sessions">0</strong></td>
                                </tr>
                                <tr>
                                    <td>Average FPS</td>
                                    <td class="text-end"><strong id="encoder-fps">--</strong></td>
                                </tr>
                                <tr>
                                    <td>Bitrate</td>
                                    <td class="text-end"><strong id="encoder-bitrate">-- Mbps</strong></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>System Resources</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>VRAM Usage</td>
                                    <td class="text-end"><strong id="vram-usage">-- / -- MB</strong></td>
                                </tr>
                                <tr>
                                    <td>GPU Temperature</td>
                                    <td class="text-end"><strong id="gpu-temp">--Â°C</strong></td>
                                </tr>
                                <tr>
                                    <td>Encoder Utilization</td>
                                    <td class="text-end"><strong id="encoder-util">--%</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Performance Alerts -->
                    <div id="performance-alerts" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Windows 11 KVM Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card streaming-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h3><i class="bi bi-windows"></i> Windows 11 Gaming VM</h3>
                            <p class="text-muted">RTX 3060 GPU Passthrough</p>
                            
                            <div class="mb-3">
                                <h5>Status</h5>
                                <div id="sunshine-status" class="mb-2">
                                    <span class="badge bg-info">Ready for Setup</span>
                                </div>
                                <small class="text-muted">Sunshine Server @ <code>{{ windows_kvm_ip }}</code></small>
                            </div>

                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> 
                                <strong>First Time Setup:</strong> Install Sunshine on your Windows KVM, then connect with Moonlight client.
                                See the setup guide for step-by-step instructions.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5>Quick Connect</h5>
                            
                            <div class="mb-3">
                                <label class="form-label"><strong>Connection Address (Moonlight):</strong></label>
                                <div class="connection-code">
                                    <span id="connection-address">{{ windows_kvm_ip }}</span>
                                    <button class="btn btn-sm btn-outline-secondary float-end" onclick="copyAddress()">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                </div>
                                <small class="text-muted">Recommended: Connect via Twingate VPN for best latency</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><strong>Sunshine Web UI:</strong></label>
                                <div class="connection-code">
                                    <a href="http://{{ windows_kvm_ip }}:47990" target="_blank" id="sunshine-link">
                                        http://{{ windows_kvm_ip }}:47990
                                    </a>
                                    <small class="text-muted d-block mt-1">Configure games and streaming settings</small>
                                </div>
                            </div>

                            <div>
                                <a href="#" class="btn btn-success" onclick="launchMoonlight()">
                                    <i class="bi bi-play-circle"></i> Launch Streaming
                                </a>
                                <a href="https://moonlight-stream.org/" target="_blank" class="btn btn-outline-primary">
                                    <i class="bi bi-download"></i> Get Moonlight
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Moonlight Client Downloads -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-download"></i> Moonlight Clients</h4>
                </div>
                <div class="card-body">
                    <p>Download Moonlight for your device to start streaming:</p>
                    
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <i class="bi bi-windows" style="font-size: 3rem; color: #0078d4;"></i>
                                <h6 class="mt-2">Windows</h6>
                                <a href="https://github.com/moonlight-stream/moonlight-qt/releases" 
                                   target="_blank" class="btn btn-sm btn-primary">Download</a>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <i class="bi bi-apple" style="font-size: 3rem; color: #000;"></i>
                                <h6 class="mt-2">macOS</h6>
                                <a href="https://github.com/moonlight-stream/moonlight-qt/releases" 
                                   target="_blank" class="btn btn-sm btn-primary">Download</a>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <i class="bi bi-ubuntu" style="font-size: 3rem; color: #e95420;"></i>
                                <h6 class="mt-2">Linux</h6>
                                <a href="https://github.com/moonlight-stream/moonlight-qt/releases" 
                                   target="_blank" class="btn btn-sm btn-primary">Download</a>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded">
                                <i class="bi bi-phone" style="font-size: 3rem; color: #3ddc84;"></i>
                                <h6 class="mt-2">Android/iOS</h6>
                                <a href="https://moonlight-stream.org/" 
                                   target="_blank" class="btn btn-sm btn-primary">Get App</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Instructions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-1-circle"></i> First Time Setup</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li class="mb-2">
                            <strong>Install Sunshine</strong> on Windows 11 KVM
                            <br><small class="text-muted">Download from GitHub, install, configure GPU encoding</small>
                        </li>
                        <li class="mb-2">
                            <strong>Download Moonlight</strong> client for your device
                            <br><small class="text-muted">Available for Windows, Mac, Linux, Android, iOS</small>
                        </li>
                        <li class="mb-2">
                            <strong>Add PC</strong> in Moonlight using the connection address above
                            <br><small class="text-muted">Enter PIN shown in Moonlight into Sunshine web UI</small>
                        </li>
                        <li class="mb-2">
                            <strong>Start Streaming!</strong> Select game or desktop
                            <br><small class="text-muted">Enjoy 3D accelerated gaming from anywhere</small>
                        </li>
                    </ol>
                    
                    <a href="/static/MOONLIGHT_SETUP.md" target="_blank" class="btn btn-primary w-100">
                        <i class="bi bi-book"></i> View Full Setup Guide
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-gear"></i> Recommended Settings</h5>
                </div>
                <div class="card-body">
                    <h6>For Best Gaming Performance:</h6>
                    <table class="table table-sm">
                        <tr>
                            <th>Encoder</th>
                            <td><code>NVENC (RTX 3060)</code></td>
                        </tr>
                        <tr>
                            <th>Resolution</th>
                            <td><code>1920x1080</code></td>
                        </tr>
                        <tr>
                            <th>FPS</th>
                            <td><code>60</code> (or 120 for high refresh)</td>
                        </tr>
                        <tr>
                            <th>Bitrate</th>
                            <td><code>20 Mbps</code> (LAN) / <code>10 Mbps</code> (Internet)</td>
                        </tr>
                        <tr>
                            <th>Connection</th>
                            <td><code>Twingate VPN</code> or <code>LAN</code></td>
                        </tr>
                    </table>

                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> <strong>Tip:</strong> Use Twingate VPN for best latency and security. Direct internet streaming adds ~20-50ms latency.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alternative: RDP Access -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-display"></i> Alternative: RDP (Non-Gaming)</h5>
                </div>
                <div class="card-body">
                    <p>For simple remote desktop access (not gaming), use standard RDP:</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Windows RDP Client</h6>
                            <div class="connection-code mb-3">
                                <strong>Address:</strong> <span id="rdp-address">{{ windows_kvm_ip }}:3389</span>
                            </div>
                            <small class="text-muted">Built into Windows - search "Remote Desktop Connection"</small>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Web-Based (Guacamole)</h6>
                            <p class="text-muted">Optional: Add Apache Guacamole for browser-based RDP</p>
                            <a href="MOONLIGHT_SETUP.md#alternative-rdp-for-non-gaming-use" 
                               target="_blank" class="btn btn-sm btn-outline-secondary">
                                Setup Instructions
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add Host Modal -->
<div class="modal fade" id="addHostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Sunshine Host</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addHostForm">
                    <div class="mb-3">
                        <label class="form-label">Host IP Address *</label>
                        <input type="text" class="form-control" id="hostIp" required 
                               placeholder="192.168.1.100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Host Name (optional)</label>
                        <input type="text" class="form-control" id="hostName" 
                               placeholder="Windows Gaming PC">
                    </div>
                    
                    <hr class="my-3">
                    <h6 class="text-muted mb-3">SSH Credentials (Optional)</h6>
                    <p class="text-muted small">Configure SSH credentials for this host. If not specified, global defaults will be used.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">SSH Username</label>
                        <input type="text" class="form-control" id="sshUser" 
                               placeholder="Default from Config">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SSH Port</label>
                        <input type="number" class="form-control" id="sshPort" 
                               placeholder="22">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SSH Key Path</label>
                        <input type="text" class="form-control" id="sshKeyPath" 
                               placeholder="Default from Config">
                        <div class="form-text">Path to SSH private key file on the dashboard server</div>
                    </div>
                    
                    <hr class="my-3">
                    <h6 class="text-muted mb-3">Sunshine API (Optional)</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Sunshine API Key</label>
                        <input type="password" class="form-control" id="sunshineApiKey" 
                               placeholder="Default from Config">
                        <div class="form-text">API key for accessing Sunshine API on this host</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addHost()">Add Host</button>
            </div>
        </div>
    </div>
</div>

<!-- Pairing Modal -->
<div class="modal fade" id="pairHostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pair with Sunshine Host</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>1. Open Moonlight client</p>
                <p>2. Click "Add PC" and enter the host IP address</p>
                <p>3. Moonlight will show a 4-digit PIN</p>
                <p>4. Enter that PIN below:</p>
                <form id="pairHostForm">
                    <input type="hidden" id="pairHostId">
                    <div class="mb-3">
                        <label class="form-label">PIN from Moonlight *</label>
                        <input type="text" class="form-control form-control-lg text-center" 
                               id="pairingPin" required maxlength="4" placeholder="0000"
                               style="font-size: 2rem; letter-spacing: 1rem;">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="pairHost()">Pair</button>
            </div>
        </div>
    </div>
</div>

<!-- Setup Wizard Modal -->
<div class="modal fade" id="setupWizardModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-magic"></i> Sunshine Setup Wizard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Progress Steps -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="wizard-step" data-step="1">
                            <div class="step-number">1</div>
                            <small>Prerequisites</small>
                        </div>
                        <div class="wizard-line"></div>
                        <div class="wizard-step" data-step="2">
                            <div class="step-number">2</div>
                            <small>Download</small>
                        </div>
                        <div class="wizard-line"></div>
                        <div class="wizard-step" data-step="3">
                            <div class="step-number">3</div>
                            <small>Install</small>
                        </div>
                        <div class="wizard-line"></div>
                        <div class="wizard-step" data-step="4">
                            <div class="step-number">4</div>
                            <small>Configure</small>
                        </div>
                        <div class="wizard-line"></div>
                        <div class="wizard-step" data-step="5">
                            <div class="step-number">5</div>
                            <small>Connect</small>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Prerequisites Check -->
                <div class="wizard-content" id="wizard-step-1">
                    <h5><i class="bi bi-clipboard-check"></i> Prerequisites Check</h5>
                    <p class="text-muted">Verify your system meets the requirements for Sunshine</p>
                    
                    <div class="alert alert-info">
                        <strong>System Requirements:</strong>
                        <ul class="mb-0">
                            <li>Ubuntu 25.10 (or 22.04+)</li>
                            <li>NVIDIA GPU with NVENC support (RTX/GTX series)</li>
                            <li>NVIDIA drivers installed (nvidia-smi working)</li>
                            <li>4GB+ RAM</li>
                            <li>Wired network connection (recommended)</li>
                        </ul>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>Select Sunshine Host</h6>
                            <p class="text-muted small">Choose the Sunshine host to check, or add a new host first</p>
                            <select class="form-select mb-3" id="wizard-host-selector">
                                <option value="">-- Select a Sunshine host --</option>
                            </select>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                If no hosts are available, click "Add Host" or "Scan Network" in the main dashboard first.
                            </small>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>System Status</h6>
                            <div id="system-check-results">
                                <p class="text-muted">Select a host and click "Check System" to verify</p>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="checkSystemRequirements()">
                        <i class="bi bi-search"></i> Check System
                    </button>
                </div>

                <!-- Step 2: Download Setup Scripts -->
                <div class="wizard-content d-none" id="wizard-step-2">
                    <h5><i class="bi bi-download"></i> Download Setup Scripts</h5>
                    <p class="text-muted">Download the Sunshine installation scripts to your Ubuntu server</p>
                    
                    <div class="alert alert-success">
                        <strong>Available Scripts:</strong>
                        <ul class="mb-0">
                            <li><code>setup-sunshine.sh</code> - Complete automated installation</li>
                            <li><code>verify-nvenc.sh</code> - GPU encoding verification tool</li>
                            <li><code>README.md</code> - Detailed setup documentation</li>
                        </ul>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>SSH Download Command</strong>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">Run this command on your Ubuntu server:</p>
                            <div class="connection-code mb-2">
<pre style="margin: 0; background: none; border: none; padding: 0;">cd ~
wget https://raw.githubusercontent.com/YourRepo/sunshine-setup/setup-sunshine.sh
wget https://raw.githubusercontent.com/YourRepo/sunshine-setup/verify-nvenc.sh
wget https://raw.githubusercontent.com/YourRepo/sunshine-setup/README.md
chmod +x setup-sunshine.sh verify-nvenc.sh</pre>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="copySshCommand()">
                                <i class="bi bi-clipboard"></i> Copy Command
                            </button>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Expected File Permissions</strong>
                        </div>
                        <div class="card-body">
                            <code>-rwxr-xr-x setup-sunshine.sh</code><br>
                            <code>-rwxr-xr-x verify-nvenc.sh</code><br>
                            <code>-rw-r--r-- README.md</code>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Run Installation -->
                <div class="wizard-content d-none" id="wizard-step-3">
                    <h5><i class="bi bi-terminal"></i> Run Installation</h5>
                    <p class="text-muted">Execute the installation scripts on your Ubuntu server</p>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Step 1: Verify GPU Support</strong>
                        </div>
                        <div class="card-body">
                            <p>Run the verification script:</p>
                            <div class="connection-code mb-2">
                                <code>./verify-nvenc.sh</code>
                            </div>
                            <div class="alert alert-info mb-0">
                                <strong>Expected Output:</strong><br>
                                <small><code>â PASSED: GPU supports NVENC hardware encoding<br>
                                â PASSED: Driver version XXX.XX<br>
                                â PASSED: NVENC libraries found<br>
                                â All NVENC tests passed!</code></small>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Step 2: Run Installer</strong>
                        </div>
                        <div class="card-body">
                            <p>Run the setup script (do NOT use sudo):</p>
                            <div class="connection-code mb-2">
                                <code>./setup-sunshine.sh</code>
                            </div>
                            <div class="alert alert-success mb-0">
                                <strong>Expected Output:</strong><br>
                                <small><code>â Found NVIDIA GPU: RTX 3060<br>
                                â NVIDIA driver installed: 545.29.06<br>
                                â Dependencies installed<br>
                                â Sunshine installed<br>
                                â NVENC configuration created<br>
                                â Sunshine service installed and started<br>
                                Installation Complete!</code></small>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-warning">
                            <strong><i class="bi bi-exclamation-triangle"></i> Troubleshooting</strong>
                        </div>
                        <div class="card-body">
                            <p><strong>If installation fails:</strong></p>
                            <ul class="mb-0">
                                <li><strong>"No NVIDIA GPU detected"</strong> - Verify GPU is visible with <code>lspci | grep -i nvidia</code></li>
                                <li><strong>"nvidia-smi not found"</strong> - Install drivers: <code>sudo ubuntu-drivers autoinstall && sudo reboot</code></li>
                                <li><strong>"Permission denied"</strong> - Make sure you run WITHOUT sudo, and scripts are executable</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Configure Sunshine -->
                <div class="wizard-content d-none" id="wizard-step-4">
                    <h5><i class="bi bi-gear"></i> Configure Sunshine</h5>
                    <p class="text-muted">Access the Sunshine Web UI and configure your streaming settings</p>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Access Sunshine Web UI</strong>
                        </div>
                        <div class="card-body">
                            <p>Open in your browser:</p>
                            <div class="connection-code mb-3">
                                <a href="http://{{ windows_kvm_ip }}:47990" target="_blank" id="sunshine-webui-link">
                                    http://{{ windows_kvm_ip }}:47990
                                </a>
                            </div>
                            <div class="alert alert-warning">
                                <strong>First-Time Setup:</strong> Complete the initial wizard in the Web UI to create an admin account and configure basic settings.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Pairing with Moonlight</strong>
                        </div>
                        <div class="card-body">
                            <ol class="mb-0">
                                <li>Download Moonlight client for your device</li>
                                <li>In Moonlight, click "Add PC"</li>
                                <li>Enter server IP: <code>{{ windows_kvm_ip }}</code></li>
                                <li>Moonlight will show a 4-digit PIN</li>
                                <li>Go to Sunshine Web UI â PIN section</li>
                                <li>Enter the PIN and confirm pairing</li>
                            </ol>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <strong>Recommended Settings</strong>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm mb-0">
                                <tr><td>Encoder</td><td><strong>NVENC (automatic)</strong></td></tr>
                                <tr><td>Preset</td><td><strong>p6 or p7</strong> (RTX 3060)</td></tr>
                                <tr><td>Resolution</td><td><strong>1920x1080</strong></td></tr>
                                <tr><td>FPS</td><td><strong>60</strong></td></tr>
                                <tr><td>Bitrate</td><td><strong>20-30 Mbps</strong> (LAN)</td></tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Connect Dashboard -->
                <div class="wizard-content d-none" id="wizard-step-5">
                    <h5><i class="bi bi-broadcast"></i> Connect Dashboard</h5>
                    <p class="text-muted">Connect this dashboard to your Sunshine host for monitoring</p>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Auto-Discover Host</strong>
                        </div>
                        <div class="card-body">
                            <p>Automatically find your Sunshine host on the network:</p>
                            <button class="btn btn-primary mb-3" onclick="wizardDiscoverHost()">
                                <i class="bi bi-radar"></i> Auto-Discover
                            </button>
                            <div id="wizard-discover-result"></div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Test Connection</strong>
                        </div>
                        <div class="card-body">
                            <p>Verify connectivity to your Sunshine host:</p>
                            <button class="btn btn-success mb-3" onclick="wizardTestConnection()">
                                <i class="bi bi-check-circle"></i> Test Connection
                            </button>
                            <div id="wizard-test-result"></div>
                        </div>
                    </div>

                    <div class="alert alert-success" id="wizard-success" style="display: none;">
                        <h6><i class="bi bi-check-circle-fill"></i> Setup Complete!</h6>
                        <p class="mb-0">Your Sunshine host is configured and ready for game streaming. You can now close this wizard and start using Moonlight to stream games!</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="wizard-prev-btn" onclick="previousWizardStep()" style="display: none;">
                    <i class="bi bi-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-primary" id="wizard-next-btn" onclick="nextWizardStep()">
                    Next <i class="bi bi-arrow-right"></i>
                </button>
                <button type="button" class="btn btn-success" id="wizard-finish-btn" onclick="finishWizard()" style="display: none;">
                    <i class="bi bi-check-circle"></i> Finish
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.wizard-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 5px;
    transition: all 0.3s ease;
}

.wizard-step.active .step-number {
    background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 50%, #3B82F6 100%);
    border-color: #8B5CF6;
    color: white;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
}

.wizard-step.completed .step-number {
    background: var(--accent-green);
    border-color: var(--accent-green);
    color: white;
}

.wizard-step.completed .step-number::after {
    content: 'â';
}

.wizard-line {
    flex: 1;
    height: 2px;
    background: var(--border-color);
    margin: 0 10px;
}

.wizard-content {
    min-height: 400px;
}

.quality-preset-card {
    padding: 20px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--card-bg);
}

.quality-preset-card:hover {
    border-color: var(--accent-purple);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.preset-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 10px;
}

.preset-details {
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.preset-badge {
    margin-top: 10px;
}

.app-card {
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 10px;
    background: var(--card-bg);
    transition: all 0.2s ease;
}

.app-card:hover {
    border-color: var(--accent-purple);
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
}

.app-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.app-command {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    color: var(--text-secondary);
    background: rgba(0, 0, 0, 0.2);
    padding: 5px 8px;
    border-radius: 4px;
    margin-bottom: 10px;
}

.session-card {
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 10px;
    background: var(--card-bg);
}

.session-card.active {
    border-left: 4px solid var(--accent-green);
}

.session-telemetry-card {
    padding: 15px;
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 8px;
    background: rgba(139, 92, 246, 0.05);
}

.metric-box {
    padding: 10px;
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
}

.metric-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}

.metric-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.metric-box.bg-warning-subtle {
    background: rgba(255, 193, 7, 0.15);
    border-color: rgba(255, 193, 7, 0.3);
}

.metric-box.bg-danger-subtle {
    background: rgba(220, 53, 69, 0.15);
    border-color: rgba(220, 53, 69, 0.3);
}
</style>

<!-- Add/Edit App Modal -->
<div class="modal fade" id="addAppModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appModalTitle">Add New App</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Left Column: Template Browser -->
                    <div class="col-md-5 border-end">
                        <h6 class="mb-3">
                            <i class="bi bi-grid"></i> App Templates
                            <button class="btn btn-sm btn-primary float-end" onclick="GameStreaming.scanApps()">
                                <i class="bi bi-radar"></i> Scan for Apps
                            </button>
                        </h6>
                        
                        <!-- Template Search -->
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-sm" id="templateSearch" 
                                   placeholder="Search templates..." onkeyup="GameStreaming.filterTemplates()">
                        </div>
                        
                        <!-- Category Filter -->
                        <div class="mb-3">
                            <select class="form-select form-select-sm" id="templateCategoryFilter" 
                                    onchange="GameStreaming.filterTemplates()">
                                <option value="">All Categories</option>
                                <option value="gaming">Gaming</option>
                                <option value="productivity">Productivity (Office, Adobe)</option>
                                <option value="development">Development</option>
                                <option value="browsers">Web Browsers</option>
                                <option value="communication">Communication</option>
                                <option value="utilities">Utilities</option>
                                <option value="desktop">Desktop</option>
                            </select>
                        </div>
                        
                        <!-- Template List -->
                        <div id="templateList" style="max-height: 500px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="small text-muted mt-2">Loading templates...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: App Configuration -->
                    <div class="col-md-7">
                        <h6 class="mb-3"><i class="bi bi-gear"></i> App Configuration</h6>
                        
                        <form id="addAppForm">
                            <input type="hidden" id="appEditIndex">
                            
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">App Name *</label>
                                    <input type="text" class="form-control" id="appName" required 
                                           placeholder="Google Chrome">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="appCategory">
                                        <option value="gaming">Gaming</option>
                                        <option value="productivity">Productivity</option>
                                        <option value="development">Development</option>
                                        <option value="browsers">Browsers</option>
                                        <option value="communication">Communication</option>
                                        <option value="utilities">Utilities</option>
                                        <option value="desktop">Desktop</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Executable Command *</label>
                                <input type="text" class="form-control" id="appCmd" required 
                                       placeholder='C:\Program Files\Google\Chrome\Application\chrome.exe'>
                                <small class="text-muted">Full path to Windows executable</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Icon URL</label>
                                <input type="text" class="form-control" id="appIconUrl" 
                                       placeholder="https://example.com/icon.png">
                                <small class="text-muted">URL to app icon for display</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Working Directory</label>
                                <input type="text" class="form-control" id="appWorkingDir" 
                                       placeholder="C:\Program Files\MyApp">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Local Image Path</label>
                                <input type="text" class="form-control" id="appImagePath" 
                                       placeholder="C:\path\to\icon.png">
                                <small class="text-muted">Optional: Local path on Sunshine host</small>
                            </div>
                            
                            <div class="accordion accordion-flush" id="advancedSettings">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#advancedCollapse">
                                            <i class="bi bi-sliders"></i> Advanced Settings
                                        </button>
                                    </h2>
                                    <div id="advancedCollapse" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div class="mb-3">
                                                <label class="form-label">Prep Commands</label>
                                                <textarea class="form-control" id="appPrepCmd" rows="2" 
                                                          placeholder="Commands to run before launching app"></textarea>
                                                <small class="text-muted">Run before app launches (one per line)</small>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Detached Commands</label>
                                                <textarea class="form-control" id="appDetached" rows="2" 
                                                          placeholder="Background processes"></textarea>
                                                <small class="text-muted">Background processes (one per line)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="GameStreaming.saveApp()">
                    <i class="bi bi-check-circle"></i> Save App
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let hosts = [];
    let sessions = [];

    // Load hosts on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadHosts();
        loadSessions();
    });

    // Load configured hosts
    function loadHosts() {
        fetch('/api/gaming/hosts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hosts = data.hosts;
                    renderHostsTable();
                    
                    // Populate host selectors
                    populateHostSelector('wizard-host-selector');
                    populateHostSelector('monitor-host-selector');
                }
            })
            .catch(error => {
                console.error('Failed to load hosts:', error);
            });
    }

    // Render hosts table
    function renderHostsTable() {
        const tbody = document.getElementById('hosts-table-body');
        
        if (hosts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="bi bi-inbox"></i> No hosts configured. Click "Add Host" or "Scan Network" to get started.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = hosts.map(host => {
            const statusBadge = host.is_online !== false ? 
                '<span class="badge bg-success">Online</span>' : 
                '<span class="badge bg-secondary">Unknown</span>';
            
            const pairedBadge = host.is_paired ? 
                '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Paired</span>' : 
                '<span class="badge bg-warning"><i class="bi bi-exclamation-circle"></i> Not Paired</span>';
            
            const lastOnline = host.last_online ? 
                new Date(host.last_online).toLocaleString() : 'Never';
            
            return `
                <tr>
                    <td><strong>${host.host_name || 'Unknown'}</strong></td>
                    <td><code>${host.host_ip}</code></td>
                    <td>${host.gpu_model || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${pairedBadge}</td>
                    <td><small>${lastOnline}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            ${!host.is_paired ? `<button class="btn btn-success" onclick="showPairModal('${host.id}')" title="Pair">
                                <i class="bi bi-link-45deg"></i>
                            </button>` : ''}
                            <button class="btn btn-info" onclick="runDiagnostics('${host.id}')" title="Run Diagnostics">
                                <i class="bi bi-shield-check"></i>
                            </button>
                            <button class="btn btn-primary" onclick="viewApps('${host.id}')" title="View Apps">
                                <i class="bi bi-controller"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteHost('${host.id}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Discover hosts
    function discoverHosts() {
        const statusDiv = document.getElementById('discovery-status');
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-info';
        statusDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> Scanning network for Sunshine hosts...';

        fetch('/api/gaming/hosts/discover', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ async: true })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.className = 'alert alert-success';
                statusDiv.innerHTML = '<i class="bi bi-check-circle"></i> Discovery started! Refreshing in 10 seconds...';
                
                // Refresh after 10 seconds
                setTimeout(() => {
                    loadHosts();
                    statusDiv.style.display = 'none';
                }, 10000);
            } else {
                statusDiv.className = 'alert alert-danger';
                statusDiv.innerHTML = '<i class="bi bi-x-circle"></i> Discovery failed: ' + data.error;
            }
        })
        .catch(error => {
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = '<i class="bi bi-x-circle"></i> Discovery failed: ' + error;
        });
    }

    // Show add host modal
    function showAddHostModal() {
        document.getElementById('hostIp').value = '';
        document.getElementById('hostName').value = '';
        document.getElementById('sshUser').value = '';
        document.getElementById('sshPort').value = '';
        document.getElementById('sshKeyPath').value = '';
        document.getElementById('sunshineApiKey').value = '';
        new bootstrap.Modal(document.getElementById('addHostModal')).show();
    }

    // Add host
    function addHost() {
        const hostIp = document.getElementById('hostIp').value.trim();
        const hostName = document.getElementById('hostName').value.trim();
        const sshUser = document.getElementById('sshUser').value.trim();
        const sshPort = document.getElementById('sshPort').value.trim();
        const sshKeyPath = document.getElementById('sshKeyPath').value.trim();
        const sunshineApiKey = document.getElementById('sunshineApiKey').value.trim();

        if (!hostIp) {
            alert('Please enter a host IP address');
            return;
        }

        const requestBody = {
            host_ip: hostIp,
            host_name: hostName || undefined
        };
        
        // Add SSH credentials only if provided
        if (sshUser) requestBody.ssh_user = sshUser;
        if (sshPort) requestBody.ssh_port = parseInt(sshPort);
        if (sshKeyPath) requestBody.ssh_key_path = sshKeyPath;
        if (sunshineApiKey) requestBody.sunshine_api_key = sunshineApiKey;

        fetch('/api/gaming/hosts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('addHostModal')).hide();
                loadHosts();
                alert('Host added successfully!');
            } else {
                alert('Failed to add host: ' + data.error);
            }
        })
        .catch(error => {
            alert('Failed to add host: ' + error);
        });
    }

    // Show pair modal
    function showPairModal(hostId) {
        document.getElementById('pairHostId').value = hostId;
        document.getElementById('pairingPin').value = '';
        new bootstrap.Modal(document.getElementById('pairHostModal')).show();
    }

    // Pair host
    function pairHost() {
        const hostId = document.getElementById('pairHostId').value;
        const pin = document.getElementById('pairingPin').value.trim();

        if (!pin || pin.length !== 4) {
            alert('Please enter a 4-digit PIN');
            return;
        }

        fetch('/api/gaming/pair', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ host_id: hostId, pin: pin })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('pairHostModal')).hide();
                loadHosts();
                alert('Pairing successful!');
            } else {
                alert('Pairing failed: ' + data.message);
            }
        })
        .catch(error => {
            alert('Pairing failed: ' + error);
        });
    }

    // Delete host
    function deleteHost(hostId) {
        if (!confirm('Are you sure you want to delete this host?')) {
            return;
        }

        fetch(`/api/gaming/hosts/${hostId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadHosts();
                alert('Host deleted successfully');
            } else {
                alert('Failed to delete host: ' + data.error);
            }
        })
        .catch(error => {
            alert('Failed to delete host: ' + error);
        });
    }

    // Run diagnostics
    function runDiagnostics(hostId) {
        const panel = document.getElementById('diagnostics-panel');
        const content = document.getElementById('diagnostics-content');
        
        panel.style.display = 'block';
        content.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Running diagnostics...</div>';

        fetch('/api/gaming/diagnostics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ host_id: hostId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderDiagnostics(data.diagnostics);
            } else {
                content.innerHTML = '<div class="alert alert-danger">Diagnostics failed: ' + data.error + '</div>';
            }
        })
        .catch(error => {
            content.innerHTML = '<div class="alert alert-danger">Diagnostics failed: ' + error + '</div>';
        });
    }

    // Render diagnostics
    function renderDiagnostics(diag) {
        const content = document.getElementById('diagnostics-content');
        
        let html = `
            <h6>Host: ${diag.host_name} (${diag.host_ip})</h6>
            <p class="text-muted">Test completed at ${new Date(diag.timestamp).toLocaleString()}</p>
            
            <div class="alert alert-${diag.overall_status === 'healthy' ? 'success' : 'warning'}">
                <strong>Overall Status:</strong> ${diag.overall_status === 'healthy' ? 'Healthy' : 'Issues Detected'}
            </div>

            <div class="row">
        `;

        // Ping test
        if (diag.tests.ping) {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="bi bi-wifi"></i> Ping Test</h6>
                            <p class="mb-1">${diag.tests.ping.success ? 
                                '<span class="badge bg-success">Passed</span>' : 
                                '<span class="badge bg-danger">Failed</span>'}</p>
                            ${diag.tests.ping.latency_ms ? 
                                `<small>Latency: ${diag.tests.ping.latency_ms}ms</small>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Latency test
        if (diag.tests.latency) {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="bi bi-speedometer"></i> Latency Test</h6>
                            <p class="mb-1">${diag.tests.latency.success ? 
                                '<span class="badge bg-success">Passed</span>' : 
                                '<span class="badge bg-danger">Failed</span>'}</p>
                            ${diag.tests.latency.avg_ms ? 
                                `<small>Average: ${diag.tests.latency.avg_ms}ms (${diag.tests.latency.quality})</small>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // API test
        if (diag.tests.api) {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="bi bi-gear"></i> Sunshine API</h6>
                            <p class="mb-1">${diag.tests.api.success ? 
                                '<span class="badge bg-success">Accessible</span>' : 
                                '<span class="badge bg-danger">Failed</span>'}</p>
                            <small>${diag.tests.api.message}</small>
                        </div>
                    </div>
                </div>
            `;
        }

        // Ports test
        if (diag.tests.ports) {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="bi bi-ethernet"></i> Port Connectivity</h6>
                            <p class="mb-1">${diag.tests.ports.success ? 
                                '<span class="badge bg-success">All Open</span>' : 
                                '<span class="badge bg-warning">Some Blocked</span>'}</p>
                            <small>${diag.tests.ports.message}</small>
                        </div>
                    </div>
                </div>
            `;
        }

        html += '</div>';
        content.innerHTML = html;
    }

    // View applications
    function viewApps(hostId) {
        fetch(`/api/gaming/apps?host_id=${hostId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.applications.length > 0) {
                let appsList = data.applications.map(app => 
                    `- ${app.name || app.title || 'Unnamed'}`
                ).join('\n');
                alert(`Available Applications:\n\n${appsList}`);
            } else {
                alert('No applications found or failed to retrieve applications.');
            }
        })
        .catch(error => {
            alert('Failed to get applications: ' + error);
        });
    }

    // Load sessions
    function loadSessions() {
        fetch('/api/gaming/sessions?limit=10')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessions = data.sessions;
                    renderSessionsTable();
                }
            })
            .catch(error => {
                console.error('Failed to load sessions:', error);
            });
    }

    // Render sessions table
    function renderSessionsTable() {
        const tbody = document.getElementById('sessions-table-body');
        
        if (sessions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="bi bi-inbox"></i> No recent sessions
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = sessions.map(session => {
            const latencyBadge = session.latency_ms < 30 ? 'latency-good' : 
                                 session.latency_ms < 100 ? 'latency-fair' : 'latency-poor';
            
            const duration = session.duration_seconds ? 
                Math.round(session.duration_seconds / 60) + ' min' : 
                'In progress';
            
            const statusBadge = session.status === 'active' ? 
                '<span class="badge bg-success">Active</span>' : 
                '<span class="badge bg-secondary">Disconnected</span>';
            
            return `
                <tr>
                    <td>${session.host_name || session.host_ip}</td>
                    <td>${session.game_name || 'Desktop'}</td>
                    <td>${session.resolution || 'N/A'}</td>
                    <td>${session.fps || 'N/A'} FPS</td>
                    <td>
                        ${session.latency_ms ? `
                            <span class="latency-indicator ${latencyBadge}"></span>
                            ${session.latency_ms}ms
                        ` : 'N/A'}
                    </td>
                    <td>${duration}</td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        }).join('');
    }

    function copyAddress() {
        const address = document.getElementById('connection-address').textContent;
        navigator.clipboard.writeText(address);
        
        // Visual feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }
    
    function launchMoonlight() {
        const address = '{{ windows_kvm_ip }}';
        alert(`To connect:\n\n1. Download and install Moonlight for your device\n2. Launch Moonlight and click "Add PC"\n3. Enter: ${address}\n4. Enter the PIN shown in Moonlight into Sunshine Web UI\n5. Start streaming!\n\nSee the Setup Guide for detailed instructions.`);
    }

    // ========================================
    // Setup Wizard Functions
    // ========================================
    let currentWizardStep = 1;
    const totalWizardSteps = 5;

    function showSetupWizard() {
        currentWizardStep = 1;
        updateWizardStep();
        
        // Populate host selector in wizard
        populateHostSelector('wizard-host-selector');
        
        new bootstrap.Modal(document.getElementById('setupWizardModal')).show();
    }
    
    function populateHostSelector(selectorId) {
        const selector = document.getElementById(selectorId);
        
        if (!selector) return;
        
        // Clear existing options except the first one
        selector.innerHTML = '<option value="">-- Select a Sunshine host --</option>';
        
        // Add hosts from global hosts array
        if (hosts && hosts.length > 0) {
            hosts.forEach(host => {
                const option = document.createElement('option');
                option.value = host.id;
                option.textContent = `${host.host_name || host.host_ip} (${host.host_ip})`;
                selector.appendChild(option);
            });
        }
    }

    function nextWizardStep() {
        if (currentWizardStep < totalWizardSteps) {
            currentWizardStep++;
            updateWizardStep();
        }
    }

    function previousWizardStep() {
        if (currentWizardStep > 1) {
            currentWizardStep--;
            updateWizardStep();
        }
    }

    function updateWizardStep() {
        document.querySelectorAll('.wizard-content').forEach(content => {
            content.classList.add('d-none');
        });
        
        document.getElementById(`wizard-step-${currentWizardStep}`).classList.remove('d-none');
        
        document.querySelectorAll('.wizard-step').forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');
            
            if (stepNum === currentWizardStep) {
                step.classList.add('active');
            } else if (stepNum < currentWizardStep) {
                step.classList.add('completed');
            }
        });
        
        document.getElementById('wizard-prev-btn').style.display = currentWizardStep > 1 ? 'inline-block' : 'none';
        document.getElementById('wizard-next-btn').style.display = currentWizardStep < totalWizardSteps ? 'inline-block' : 'none';
        document.getElementById('wizard-finish-btn').style.display = currentWizardStep === totalWizardSteps ? 'inline-block' : 'none';
    }

    function checkSystemRequirements() {
        const resultsDiv = document.getElementById('system-check-results');
        const hostSelector = document.getElementById('wizard-host-selector');
        const hostId = hostSelector.value;
        
        if (!hostId) {
            resultsDiv.innerHTML = `<div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> Please select a Sunshine host first
            </div>`;
            return;
        }
        
        resultsDiv.innerHTML = '<p class="text-muted"><i class="bi bi-hourglass-split"></i> Checking remote system via SSH...</p>';
        
        fetch(`/api/gaming/system-check?host_id=${hostId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.checks) {
                    const checks = data.checks;
                    let html = '<div class="list-group">';
                    
                    html += `<div class="list-group-item list-group-item-info">
                        <strong><i class="bi bi-hdd-network"></i> Host:</strong> ${data.host_ip || 'Remote host'}
                    </div>`;
                    
                    html += `<div class="list-group-item ${checks.gpu ? 'list-group-item-success' : 'list-group-item-danger'}">
                        <strong>${checks.gpu ? 'â' : 'â'} NVIDIA GPU:</strong> ${checks.gpu_model || 'Not detected'}
                    </div>`;
                    
                    html += `<div class="list-group-item ${checks.driver ? 'list-group-item-success' : 'list-group-item-danger'}">
                        <strong>${checks.driver ? 'â' : 'â'} NVIDIA Driver:</strong> ${checks.driver_version || 'Not installed'}
                    </div>`;
                    
                    html += `<div class="list-group-item ${checks.nvenc ? 'list-group-item-success' : 'list-group-item-warning'}">
                        <strong>${checks.nvenc ? 'â' : 'â '} NVENC Support:</strong> ${checks.nvenc ? 'Available' : 'Check required'}
                    </div>`;
                    
                    if (checks.vram_total) {
                        html += `<div class="list-group-item list-group-item-info">
                            <strong><i class="bi bi-memory"></i> VRAM:</strong> ${checks.vram_used} / ${checks.vram_total} MB
                        </div>`;
                    }
                    
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                } else {
                    // Show specific error message
                    const errorMsg = data.error || 'Unknown error';
                    const errorDetails = data.error_details || '';
                    
                    let html = `<div class="alert alert-danger">
                        <strong><i class="bi bi-x-circle"></i> ${errorMsg}</strong>`;
                    
                    if (errorDetails) {
                        html += `<br><small class="text-muted">${errorDetails}</small>`;
                    }
                    
                    if (data.host_ip) {
                        html += `<br><small>Host: ${data.host_ip}</small>`;
                    }
                    
                    html += '</div>';
                    
                    // Show partial results if available
                    if (data.checks) {
                        html += '<p class="text-muted"><small>Partial Results:</small></p>';
                        html += '<div class="list-group">';
                        
                        if (data.checks.gpu_model) {
                            html += `<div class="list-group-item">
                                <strong>GPU:</strong> ${data.checks.gpu_model}
                            </div>`;
                        }
                        
                        if (data.checks.driver_version) {
                            html += `<div class="list-group-item">
                                <strong>Driver:</strong> ${data.checks.driver_version}
                            </div>`;
                        }
                        
                        html += '</div>';
                    }
                    
                    resultsDiv.innerHTML = html;
                }
            })
            .catch(error => {
                resultsDiv.innerHTML = `<div class="alert alert-danger">
                    <strong><i class="bi bi-x-circle"></i> Check failed</strong><br>
                    <small>${error.message || error}</small>
                </div>`;
            });
    }

    function copySshCommand() {
        const command = `cd ~
wget https://raw.githubusercontent.com/YourRepo/sunshine-setup/setup-sunshine.sh
wget https://raw.githubusercontent.com/YourRepo/sunshine-setup/verify-nvenc.sh
wget https://raw.githubusercontent.com/YourRepo/sunshine-setup/README.md
chmod +x setup-sunshine.sh verify-nvenc.sh`;
        
        navigator.clipboard.writeText(command).then(() => {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-primary');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
            }, 2000);
        });
    }

    function wizardDiscoverHost() {
        const resultDiv = document.getElementById('wizard-discover-result');
        resultDiv.innerHTML = '<p class="text-muted"><i class="bi bi-hourglass-split"></i> Scanning network...</p>';
        
        discoverHosts();
        
        setTimeout(() => {
            if (hosts.length > 0) {
                resultDiv.innerHTML = `<div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> Found ${hosts.length} host(s)! Host has been added to your dashboard.
                </div>`;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-warning">
                    No hosts found. Try manually adding the host IP in the main dashboard.
                </div>`;
            }
        }, 12000);
    }

    function wizardTestConnection() {
        const resultDiv = document.getElementById('wizard-test-result');
        resultDiv.innerHTML = '<p class="text-muted"><i class="bi bi-hourglass-split"></i> Testing connection...</p>';
        
        if (hosts.length === 0) {
            resultDiv.innerHTML = '<div class="alert alert-warning">No hosts configured. Please discover or add a host first.</div>';
            return;
        }
        
        const firstHost = hosts[0];
        runDiagnostics(firstHost.id);
        
        setTimeout(() => {
            resultDiv.innerHTML = `<div class="alert alert-success">
                <i class="bi bi-check-circle"></i> Connection test complete! Check the diagnostics panel above for details.
            </div>`;
            document.getElementById('wizard-success').style.display = 'block';
        }, 5000);
    }

    function finishWizard() {
        bootstrap.Modal.getInstance(document.getElementById('setupWizardModal')).hide();
        loadHosts();
        alert('Setup complete! Your Sunshine host is ready for game streaming.');
    }

    // ========================================
    // Performance Monitoring Functions
    // ========================================
    let monitoringActive = false;
    let monitoringInterval = null;
    let gpuUtilChart = null;
    let latencyChart = null;

    function toggleMonitoring() {
        monitoringActive = !monitoringActive;
        
        const statusBadge = document.getElementById('monitor-status');
        const toggleBtn = document.getElementById('monitor-toggle-btn');
        
        if (monitoringActive) {
            statusBadge.textContent = 'Monitoring Active';
            statusBadge.className = 'badge bg-success';
            toggleBtn.innerHTML = '<i class="bi bi-pause-fill"></i> Stop Monitoring';
            toggleBtn.className = 'btn btn-sm btn-danger ms-2';
            
            loadPerformanceMetrics();
            monitoringInterval = setInterval(loadPerformanceMetrics, 5000);
        } else {
            statusBadge.textContent = 'Not Monitoring';
            statusBadge.className = 'badge bg-secondary';
            toggleBtn.innerHTML = '<i class="bi bi-play-fill"></i> Start Monitoring';
            toggleBtn.className = 'btn btn-sm btn-success ms-2';
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }
    }

    function loadPerformanceMetrics() {
        const hostSelector = document.getElementById('monitor-host-selector');
        const hostId = hostSelector.value;
        const errorAlert = document.getElementById('monitor-error-alert');
        
        if (!hostId) {
            errorAlert.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Please select a host to monitor';
            errorAlert.style.display = 'block';
            return;
        }
        
        // Hide error alert while loading
        errorAlert.style.display = 'none';
        
        fetch(`/api/gaming/performance-metrics?host_id=${hostId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.metrics) {
                    updateMetricsDisplay(data.metrics);
                    updatePerformanceCharts(data.metrics);
                    checkPerformanceAlerts(data.metrics);
                    errorAlert.style.display = 'none';
                } else {
                    // Show specific error message
                    const errorMsg = data.error || 'Metrics unavailable';
                    const errorDetails = data.error_details || '';
                    
                    errorAlert.innerHTML = `<strong><i class="bi bi-x-circle"></i> ${errorMsg}</strong>`;
                    
                    if (errorDetails) {
                        errorAlert.innerHTML += `<br><small>${errorDetails}</small>`;
                    }
                    
                    if (data.host_ip) {
                        errorAlert.innerHTML += `<br><small>Host: ${data.host_ip}</small>`;
                    }
                    
                    errorAlert.style.display = 'block';
                    
                    // Reset metrics display to show "No data"
                    resetMetricsDisplay();
                }
            })
            .catch(error => {
                console.error('Failed to load performance metrics:', error);
                errorAlert.innerHTML = `<strong><i class="bi bi-x-circle"></i> Failed to load metrics</strong><br>
                    <small>${error.message || error}</small>`;
                errorAlert.style.display = 'block';
                resetMetricsDisplay();
            });
    }
    
    function resetMetricsDisplay() {
        // Reset all metrics to "No data" state
        document.getElementById('stat-active-sessions').textContent = '--';
        document.getElementById('gpu-util-value').textContent = '--';
        document.getElementById('latency-value').textContent = '--';
        document.getElementById('quality-value').textContent = '--';
        document.getElementById('quality-fps').textContent = '@ -- FPS';
        document.getElementById('encoder-sessions').textContent = '--';
        document.getElementById('encoder-fps').textContent = '--';
        document.getElementById('encoder-bitrate').textContent = '-- Mbps';
    }

    function updateMetricsDisplay(metrics) {
        document.getElementById('stat-active-sessions').textContent = metrics.active_sessions || 0;
        
        const gpuUtil = metrics.gpu_utilization || 0;
        document.getElementById('gpu-util-value').textContent = gpuUtil;
        document.getElementById('stat-gpu-util').style.color = getUtilizationColor(gpuUtil);
        
        const latency = metrics.network_latency || '--';
        document.getElementById('latency-value').textContent = latency !== '--' ? latency : '--';
        if (latency !== '--') {
            document.getElementById('stat-latency').style.color = getLatencyColor(latency);
        }
        
        if (metrics.streaming_quality) {
            document.getElementById('quality-value').textContent = metrics.streaming_quality.resolution || '--';
            document.getElementById('quality-fps').textContent = `@ ${metrics.streaming_quality.fps || '--'} FPS`;
        }
        
        document.getElementById('encoder-sessions').textContent = metrics.encoder_stats?.session_count || 0;
        document.getElementById('encoder-fps').textContent = metrics.encoder_stats?.avg_fps || '--';
        document.getElementById('encoder-bitrate').textContent = metrics.encoder_stats?.bitrate 
            ? `${metrics.encoder_stats.bitrate} Mbps` 
            : '-- Mbps';
        
        document.getElementById('vram-usage').textContent = metrics.vram 
            ? `${metrics.vram.used} / ${metrics.vram.total} MB`
            : '-- / -- MB';
        document.getElementById('gpu-temp').textContent = metrics.gpu_temperature 
            ? `${metrics.gpu_temperature}Â°C` 
            : '--Â°C';
        document.getElementById('encoder-util').textContent = metrics.encoder_utilization 
            ? `${metrics.encoder_utilization}%` 
            : '--%';
    }

    function getUtilizationColor(util) {
        if (util < 50) return 'var(--accent-green)';
        if (util < 80) return 'var(--accent-yellow)';
        return 'var(--accent-red)';
    }

    function getLatencyColor(latency) {
        if (latency < 30) return 'var(--accent-green)';
        if (latency < 100) return 'var(--accent-yellow)';
        return 'var(--accent-red)';
    }

    function initPerformanceCharts() {
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(139, 92, 246, 0.1)'
                        },
                        ticks: {
                            color: 'var(--text-secondary)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(139, 92, 246, 0.1)'
                        },
                        ticks: {
                            color: 'var(--text-secondary)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        };
        
        const gpuCtx = document.getElementById('gpuUtilChart').getContext('2d');
        gpuUtilChart = new Chart(gpuCtx, {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    label: 'GPU Utilization %',
                    data: [],
                    borderColor: '#8B5CF6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartConfig.options,
                scales: {
                    ...chartConfig.options.scales,
                    y: {
                        ...chartConfig.options.scales.y,
                        max: 100
                    }
                }
            }
        });
        
        const latencyCtx = document.getElementById('latencyChart').getContext('2d');
        latencyChart = new Chart(latencyCtx, {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    label: 'Latency (ms)',
                    data: [],
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            }
        });
    }

    function updatePerformanceCharts(metrics) {
        if (!gpuUtilChart || !latencyChart) {
            initPerformanceCharts();
        }
        
        const now = new Date().toLocaleTimeString();
        
        gpuUtilChart.data.labels.push(now);
        gpuUtilChart.data.datasets[0].data.push(metrics.gpu_utilization || 0);
        
        if (gpuUtilChart.data.labels.length > 20) {
            gpuUtilChart.data.labels.shift();
            gpuUtilChart.data.datasets[0].data.shift();
        }
        gpuUtilChart.update('none');
        
        latencyChart.data.labels.push(now);
        latencyChart.data.datasets[0].data.push(metrics.network_latency || 0);
        
        if (latencyChart.data.labels.length > 20) {
            latencyChart.data.labels.shift();
            latencyChart.data.datasets[0].data.shift();
        }
        latencyChart.update('none');
    }

    function checkPerformanceAlerts(metrics) {
        const alertsDiv = document.getElementById('performance-alerts');
        let alerts = [];
        
        if (metrics.network_latency && metrics.network_latency > 100) {
            alerts.push({
                type: 'warning',
                message: `High network latency detected: ${metrics.network_latency}ms. Consider using wired connection.`
            });
        }
        
        if (metrics.gpu_utilization && metrics.gpu_utilization > 90) {
            alerts.push({
                type: 'danger',
                message: `GPU utilization very high: ${metrics.gpu_utilization}%. Performance may be impacted.`
            });
        }
        
        if (metrics.streaming_quality && metrics.streaming_quality.fps < 30) {
            alerts.push({
                type: 'warning',
                message: `Low FPS detected: ${metrics.streaming_quality.fps}. Check encoder settings or network bandwidth.`
            });
        }
        
        if (alerts.length > 0) {
            alertsDiv.innerHTML = alerts.map(alert => 
                `<div class="alert alert-${alert.type}">
                    <i class="bi bi-exclamation-triangle"></i> ${alert.message}
                </div>`
            ).join('');
        } else {
            alertsDiv.innerHTML = '';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart !== 'undefined') {
            initPerformanceCharts();
        }
        
        populateHostSelector('app-host-selector');
        
        const appHostSelector = document.getElementById('app-host-selector');
        if (appHostSelector) {
            appHostSelector.addEventListener('change', function() {
                const hostId = this.value;
                const addAppBtn = document.getElementById('add-app-btn');
                const refreshAppsBtn = document.getElementById('refresh-apps-btn');
                
                if (hostId) {
                    addAppBtn.disabled = false;
                    refreshAppsBtn.disabled = false;
                    GameStreaming.loadApps();
                } else {
                    addAppBtn.disabled = true;
                    refreshAppsBtn.disabled = true;
                    document.getElementById('apps-container').innerHTML = `
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> Select a Sunshine host above to view and manage apps/games
                        </div>`;
                }
            });
        }
        
        if (typeof GameStreaming !== 'undefined') {
            GameStreaming.loadCurrentQualityConfig();
            GameStreaming.loadDetailedTelemetry();
        }
        
        populateHostSelector('session-host-selector');
        SessionManagement.loadRecentSessions();
    });

    const SessionManagement = {
        currentSession: null,
        sessionTimer: null,
        sessionStartTime: null,
        selectedHostId: null,
        
        onHostSelected: async function() {
            const hostSelector = document.getElementById('session-host-selector');
            this.selectedHostId = hostSelector.value;
            
            const appSelector = document.getElementById('session-app-selector');
            const startBtn = document.getElementById('start-session-btn');
            
            if (!this.selectedHostId) {
                appSelector.disabled = true;
                appSelector.innerHTML = '<option value="">-- Select host first --</option>';
                startBtn.disabled = true;
                return;
            }
            
            try {
                const appsResponse = await fetch(`/api/gaming/hosts/${this.selectedHostId}/apps`);
                const appsData = await appsResponse.json();
                
                if (appsData.success && appsData.apps) {
                    appSelector.disabled = false;
                    appSelector.innerHTML = '<option value="">-- Select app/game --</option>' +
                        appsData.apps.map(app => {
                            const name = app.name || app.output || 'Unnamed App';
                            return `<option value="${this.escapeHtml(name)}">${this.escapeHtml(name)}</option>`;
                        }).join('');
                    startBtn.disabled = false;
                } else {
                    appSelector.innerHTML = '<option value="">No apps available</option>';
                    startBtn.disabled = true;
                }
                
                await this.checkCurrentSession(this.selectedHostId);
            } catch (error) {
                console.error('Failed to load apps:', error);
                appSelector.innerHTML = '<option value="">Error loading apps</option>';
                startBtn.disabled = true;
            }
        },
        
        async startSession() {
            const hostId = this.selectedHostId;
            const appSelector = document.getElementById('session-app-selector');
            const appName = appSelector.value;
            const deviceName = document.getElementById('session-device-name').value;
            const resolution = document.getElementById('session-resolution').value;
            
            if (!hostId || !appName) {
                alert('Please select a host and app/game');
                return;
            }
            
            const startBtn = document.getElementById('start-session-btn');
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Starting...';
            
            try {
                const response = await fetch(`/api/gaming/hosts/${hostId}/sessions/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_name: appName,
                        client_info: {
                            device_name: deviceName || 'Unknown Device',
                            device_type: 'desktop',
                            resolution: resolution
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.currentSession = data.session;
                    this.sessionStartTime = new Date(data.session.started_at);
                    this.showCurrentSession(data.session);
                    this.startSessionTimer();
                    
                    document.getElementById('start-session-btn').style.display = 'none';
                    document.getElementById('stop-session-btn').style.display = 'inline-block';
                    
                    this.showNotification('Session started successfully', 'success');
                } else {
                    alert('Failed to start session: ' + data.error);
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Session';
                }
            } catch (error) {
                console.error('Failed to start session:', error);
                alert('Failed to start session: ' + error.message);
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Session';
            }
        },
        
        async stopSession() {
            if (!this.currentSession || !this.currentSession.id) {
                return;
            }
            
            const stopBtn = document.getElementById('stop-session-btn');
            stopBtn.disabled = true;
            stopBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Stopping...';
            
            try {
                const response = await fetch(`/api/gaming/sessions/${this.currentSession.id}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.stopSessionTimer();
                    this.hideCurrentSession();
                    
                    document.getElementById('start-session-btn').style.display = 'inline-block';
                    document.getElementById('start-session-btn').disabled = false;
                    document.getElementById('stop-session-btn').style.display = 'none';
                    
                    this.currentSession = null;
                    this.sessionStartTime = null;
                    
                    this.loadRecentSessions();
                    
                    const stats = data.stats;
                    const message = `Session ended!\nDuration: ${stats.duration_formatted}\nAvg Quality: ${stats.avg_fps ? stats.avg_fps.toFixed(0) + ' FPS' : 'N/A'}\nData: ${stats.total_data_gb ? stats.total_data_gb.toFixed(2) + ' GB' : 'N/A'}`;
                    this.showNotification(message, 'info');
                } else {
                    alert('Failed to stop session: ' + data.error);
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop Session';
                }
            } catch (error) {
                console.error('Failed to stop session:', error);
                alert('Failed to stop session: ' + error.message);
                stopBtn.disabled = false;
                stopBtn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop Session';
            }
        },
        
        async checkCurrentSession(hostId) {
            if (!hostId) return;
            
            try {
                const response = await fetch(`/api/gaming/hosts/${hostId}/sessions/current`);
                const data = await response.json();
                
                if (data.success && data.session) {
                    this.currentSession = data.session;
                    this.sessionStartTime = new Date(data.session.started_at);
                    this.showCurrentSession(data.session);
                    this.startSessionTimer();
                    
                    document.getElementById('start-session-btn').style.display = 'none';
                    document.getElementById('stop-session-btn').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Failed to check current session:', error);
            }
        },
        
        showCurrentSession(session) {
            const card = document.getElementById('current-session-card');
            card.style.display = 'block';
            
            document.getElementById('session-id-display').textContent = session.id;
            document.getElementById('session-app-name').textContent = session.app_name || session.game_name || '-';
            document.getElementById('session-host-name').textContent = session.host_name || session.host_ip;
            document.getElementById('session-client-device').textContent = session.client_device || '-';
            document.getElementById('session-current-resolution').textContent = session.resolution || '-';
            document.getElementById('session-current-fps').textContent = session.fps ? session.fps + ' FPS' : '-';
            document.getElementById('session-current-bitrate').textContent = session.bitrate_mbps ? session.bitrate_mbps.toFixed(1) + ' Mbps' : '-';
            document.getElementById('session-current-latency').textContent = session.latency_ms ? session.latency_ms.toFixed(0) + ' ms' : '-';
        },
        
        hideCurrentSession() {
            document.getElementById('current-session-card').style.display = 'none';
        },
        
        startSessionTimer() {
            this.stopSessionTimer();
            
            this.sessionTimer = setInterval(() => {
                if (this.sessionStartTime) {
                    const now = new Date();
                    const durationSeconds = Math.floor((now - this.sessionStartTime) / 1000);
                    const formatted = this.formatDuration(durationSeconds);
                    document.getElementById('session-duration').textContent = formatted;
                }
            }, 1000);
        },
        
        stopSessionTimer() {
            if (this.sessionTimer) {
                clearInterval(this.sessionTimer);
                this.sessionTimer = null;
            }
        },
        
        formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds}s`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${minutes}m ${secs}s`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${minutes}m`;
            }
        },
        
        async loadRecentSessions() {
            try {
                const response = await fetch('/api/gaming/sessions?limit=20');
                const data = await response.json();
                
                if (data.success && data.sessions) {
                    this.renderRecentSessions(data.sessions);
                }
            } catch (error) {
                console.error('Failed to load recent sessions:', error);
            }
        },
        
        renderRecentSessions(sessions) {
            const tbody = document.getElementById('sessions-table-body');
            
            if (!sessions || sessions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="bi bi-inbox"></i> No recent sessions
                        </td>
                    </tr>`;
                return;
            }
            
            tbody.innerHTML = sessions.map(session => {
                const duration = session.duration_seconds ? 
                    this.formatDuration(Math.floor(session.duration_seconds)) : '-';
                
                const avgQuality = session.avg_fps && session.avg_bitrate ?
                    `${Math.round(session.avg_fps)} FPS @ ${session.avg_bitrate.toFixed(1)} Mbps` :
                    (session.resolution || '-');
                
                const dataStreamed = session.total_data_gb ?
                    `${session.total_data_gb.toFixed(2)} GB` : '-';
                
                let outcomeBadge = '';
                if (session.session_outcome === 'completed') {
                    outcomeBadge = '<span class="badge bg-success">Completed</span>';
                } else if (session.session_outcome === 'interrupted') {
                    outcomeBadge = '<span class="badge bg-warning">Interrupted</span>';
                } else if (session.session_outcome === 'error') {
                    outcomeBadge = '<span class="badge bg-danger">Error</span>';
                } else {
                    outcomeBadge = `<span class="badge bg-secondary">${session.status || 'Unknown'}</span>`;
                }
                
                const startedAt = session.started_at ?
                    new Date(session.started_at).toLocaleString() : '-';
                
                return `
                    <tr>
                        <td>${this.escapeHtml(session.host_name || session.host_ip)}</td>
                        <td>${this.escapeHtml(session.app_name || session.game_name || '-')}</td>
                        <td>${duration}</td>
                        <td><small>${avgQuality}</small></td>
                        <td>${dataStreamed}</td>
                        <td><small>${this.escapeHtml(session.client_device || '-')}</small></td>
                        <td>${outcomeBadge}</td>
                        <td><small>${startedAt}</small></td>
                    </tr>`;
            }).join('');
        },
        
        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },
        
        showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    };

    const GameStreaming = {
        currentApps: [],
        appTemplates: {},
        allTemplates: [],
        
        loadApps: function() {
            const hostId = document.getElementById('app-host-selector').value;
            if (!hostId) {
                return;
            }
            
            const container = document.getElementById('apps-container');
            const loading = document.getElementById('apps-loading');
            
            loading.style.display = 'block';
            container.style.display = 'none';
            
            fetch(`/api/gaming/hosts/${hostId}/apps`)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    container.style.display = 'block';
                    
                    if (data.success) {
                        this.currentApps = data.apps || [];
                        this.renderApps();
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-danger mb-0">
                                <i class="bi bi-exclamation-triangle"></i> ${data.error || 'Failed to load apps'}
                            </div>`;
                    }
                })
                .catch(error => {
                    loading.style.display = 'none';
                    container.style.display = 'block';
                    container.innerHTML = `
                        <div class="alert alert-danger mb-0">
                            <i class="bi bi-exclamation-triangle"></i> Connection error: ${error.message}
                        </div>`;
                });
        },
        
        renderApps: function() {
            const container = document.getElementById('apps-container');
            
            if (this.currentApps.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> No apps configured. Click "Add App" to get started.
                    </div>`;
                return;
            }
            
            const html = this.currentApps.map((app, index) => `
                <div class="app-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="app-name">
                                <i class="bi bi-controller"></i> ${this.escapeHtml(app.name || app.output || 'Unnamed App')}
                            </div>
                            <div class="app-command">${this.escapeHtml(app.cmd ? app.cmd.join(' ') : 'No command')}</div>
                            ${app.image ? `<small class="text-muted"><i class="bi bi-image"></i> ${this.escapeHtml(app.image)}</small><br>` : ''}
                            ${app['working-dir'] ? `<small class="text-muted"><i class="bi bi-folder"></i> ${this.escapeHtml(app['working-dir'])}</small>` : ''}
                        </div>
                        <div class="btn-group-vertical" role="group">
                            <button class="btn btn-sm btn-success" onclick="GameStreaming.startApp(${index})" title="Start App">
                                <i class="bi bi-play-fill"></i> Start
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="GameStreaming.editApp(${index})" title="Edit">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="GameStreaming.deleteApp(${index})" title="Delete">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        },
        
        showAddAppModal: function() {
            document.getElementById('appModalTitle').textContent = 'Add New App';
            document.getElementById('addAppForm').reset();
            document.getElementById('appEditIndex').value = '';
            
            this.loadTemplates();
            
            const modal = new bootstrap.Modal(document.getElementById('addAppModal'));
            modal.show();
        },
        
        editApp: function(index) {
            const app = this.currentApps[index];
            
            document.getElementById('appModalTitle').textContent = 'Edit App';
            document.getElementById('appEditIndex').value = index;
            document.getElementById('appName').value = app.name || app.output || '';
            document.getElementById('appCmd').value = app.cmd ? app.cmd.join(' ') : '';
            document.getElementById('appCategory').value = app.category || 'utilities';
            document.getElementById('appIconUrl').value = app.icon_url || '';
            document.getElementById('appWorkingDir').value = app['working-dir'] || '';
            document.getElementById('appImagePath').value = app.image || '';
            document.getElementById('appPrepCmd').value = app['prep-cmd'] ? app['prep-cmd'].join('\n') : '';
            document.getElementById('appDetached').value = app.detached ? app.detached.join('\n') : '';
            
            this.loadTemplates();
            
            const modal = new bootstrap.Modal(document.getElementById('addAppModal'));
            modal.show();
        },
        
        saveApp: function() {
            const hostId = document.getElementById('app-host-selector').value;
            const editIndex = document.getElementById('appEditIndex').value;
            const isEdit = editIndex !== '';
            
            const appConfig = {
                name: document.getElementById('appName').value,
                output: document.getElementById('appName').value,
                cmd: document.getElementById('appCmd').value.trim().split(/\s+/),
                category: document.getElementById('appCategory').value,
                icon_url: document.getElementById('appIconUrl').value || undefined,
                'working-dir': document.getElementById('appWorkingDir').value || undefined,
                image: document.getElementById('appImagePath').value || undefined,
                'prep-cmd': document.getElementById('appPrepCmd').value 
                    ? document.getElementById('appPrepCmd').value.split('\n').filter(l => l.trim())
                    : undefined,
                detached: document.getElementById('appDetached').value
                    ? document.getElementById('appDetached').value.split('\n').filter(l => l.trim())
                    : undefined
            };
            
            Object.keys(appConfig).forEach(key => {
                if (appConfig[key] === undefined || appConfig[key] === '') {
                    delete appConfig[key];
                }
            });
            
            const url = isEdit 
                ? `/api/gaming/hosts/${hostId}/apps/${editIndex}`
                : `/api/gaming/hosts/${hostId}/apps`;
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(appConfig)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addAppModal')).hide();
                    this.showToast(isEdit ? 'App updated successfully' : 'App added successfully', 'success');
                    this.loadApps();
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                this.showToast('Connection error: ' + error.message, 'danger');
            });
        },
        
        deleteApp: function(index) {
            if (!confirm('Are you sure you want to delete this app?')) {
                return;
            }
            
            const hostId = document.getElementById('app-host-selector').value;
            
            fetch(`/api/gaming/hosts/${hostId}/apps/${index}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast('App deleted successfully', 'success');
                    this.loadApps();
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                this.showToast('Connection error: ' + error.message, 'danger');
            });
        },
        
        startApp: function(index) {
            const hostId = document.getElementById('app-host-selector').value;
            const app = this.currentApps[index];
            
            fetch(`/api/gaming/hosts/${hostId}/apps/${index}/start`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast(`Started streaming: ${app.name || app.output}`, 'success');
                    setTimeout(() => this.refreshActiveSessions(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Failed to start app'), 'danger');
                }
            })
            .catch(error => {
                this.showToast('Connection error: ' + error.message, 'danger');
            });
        },
        
        stopSession: function(hostId) {
            if (!confirm('Are you sure you want to stop the active streaming session?')) {
                return;
            }
            
            fetch(`/api/gaming/hosts/${hostId}/apps/stop`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast('Streaming session stopped', 'success');
                    setTimeout(() => this.refreshActiveSessions(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Failed to stop session'), 'danger');
                }
            })
            .catch(error => {
                this.showToast('Connection error: ' + error.message, 'danger');
            });
        },
        
        refreshActiveSessions: function() {
            const container = document.getElementById('active-sessions-container');
            
            if (!hosts || hosts.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-secondary mb-0">
                        <i class="bi bi-info-circle"></i> No hosts configured
                    </div>`;
                return;
            }
            
            container.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <small class="ms-2">Checking active sessions...</small>
                </div>`;
            
            Promise.all(hosts.map(host => 
                fetch(`/api/gaming/hosts/${host.id}/sessions/active`)
                    .then(r => r.json())
                    .then(data => ({host, data}))
                    .catch(error => ({host, error}))
            ))
            .then(results => {
                const activeSessions = results.filter(r => r.data && r.data.success && r.data.sessions && r.data.sessions.length > 0);
                
                if (activeSessions.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-secondary mb-0">
                            <i class="bi bi-info-circle"></i> No active streaming sessions
                        </div>`;
                    return;
                }
                
                const html = activeSessions.map(({host, data}) => {
                    return data.sessions.map(session => `
                        <div class="session-card active">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-2">
                                        <i class="bi bi-broadcast text-success"></i> 
                                        <strong>${this.escapeHtml(session.app_name || 'Unknown App')}</strong>
                                    </h6>
                                    <div class="row g-2 small">
                                        <div class="col-md-3">
                                            <i class="bi bi-pc-display"></i> Host: ${this.escapeHtml(host.name)}
                                        </div>
                                        <div class="col-md-3">
                                            <i class="bi bi-aspect-ratio"></i> ${session.resolution || 'N/A'} @ ${session.fps || 'N/A'} FPS
                                        </div>
                                        <div class="col-md-3">
                                            <i class="bi bi-speedometer"></i> ${session.bitrate || 'N/A'}
                                        </div>
                                        <div class="col-md-3">
                                            <i class="bi bi-clock"></i> ${session.duration || 'N/A'}
                                        </div>
                                    </div>
                                    ${session.client ? `<div class="mt-2 small text-muted"><i class="bi bi-laptop"></i> Client: ${this.escapeHtml(session.client)}</div>` : ''}
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="GameStreaming.stopSession('${host.id}')" title="Stop Session">
                                    <i class="bi bi-stop-fill"></i> Stop
                                </button>
                            </div>
                        </div>
                    `).join('');
                }).join('');
                
                container.innerHTML = html;
            });
        },
        
        loadTemplates: function() {
            const listContainer = document.getElementById('templateList');
            
            if (Object.keys(this.appTemplates).length > 0) {
                this.renderTemplates();
                return;
            }
            
            listContainer.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="small text-muted mt-2">Loading templates...</p>
                </div>`;
            
            fetch('/api/gaming/app-templates')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.appTemplates = data.templates;
                        this.allTemplates = [];
                        
                        Object.keys(data.templates).forEach(category => {
                            data.templates[category].forEach(template => {
                                this.allTemplates.push(template);
                            });
                        });
                        
                        this.renderTemplates();
                    } else {
                        listContainer.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> Failed to load templates
                            </div>`;
                    }
                })
                .catch(error => {
                    listContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> Error: ${error.message}
                        </div>`;
                });
        },
        
        filterTemplates: function() {
            const searchTerm = document.getElementById('templateSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('templateCategoryFilter').value;
            
            let filtered = this.allTemplates;
            
            if (categoryFilter) {
                filtered = filtered.filter(t => t.category === categoryFilter);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.name.toLowerCase().includes(searchTerm) || 
                    (t.description && t.description.toLowerCase().includes(searchTerm))
                );
            }
            
            this.renderTemplates(filtered);
        },
        
        renderTemplates: function(templates = null) {
            const listContainer = document.getElementById('templateList');
            const templatesToRender = templates || this.allTemplates;
            
            if (templatesToRender.length === 0) {
                listContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No templates found
                    </div>`;
                return;
            }
            
            const groupedByCategory = {};
            templatesToRender.forEach(template => {
                const category = template.category || 'other';
                if (!groupedByCategory[category]) {
                    groupedByCategory[category] = [];
                }
                groupedByCategory[category].push(template);
            });
            
            const categoryNames = {
                'gaming': 'ð® Gaming',
                'productivity': 'ð Productivity',
                'development': 'ð» Development',
                'browsers': 'ð Web Browsers',
                'communication': 'ð¬ Communication',
                'utilities': 'ð ï¸ Utilities',
                'desktop': 'ð¥ï¸ Desktop'
            };
            
            let html = '';
            Object.keys(groupedByCategory).forEach(category => {
                const displayName = categoryNames[category] || category;
                html += `<div class="mb-3">
                    <h6 class="text-muted small mb-2">${displayName}</h6>`;
                
                groupedByCategory[category].forEach(template => {
                    const iconHtml = template.icon_url 
                        ? `<img src="${this.escapeHtml(template.icon_url)}" style="width:16px; height:16px; margin-right:8px;" onerror="this.style.display='none'">` 
                        : `<i class="bi bi-app me-2"></i>`;
                    
                    html += `
                        <div class="card mb-2 template-item" style="cursor:pointer;" 
                             onclick="GameStreaming.applyTemplateFromList(${JSON.stringify(template).replace(/"/g, '&quot;')})">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex align-items-center">
                                    ${iconHtml}
                                    <div class="flex-grow-1">
                                        <div class="fw-bold small">${this.escapeHtml(template.name)}</div>
                                        ${template.description ? `<div class="text-muted" style="font-size:0.75rem;">${this.escapeHtml(template.description)}</div>` : ''}
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </div>
                        </div>`;
                });
                
                html += '</div>';
            });
            
            listContainer.innerHTML = html;
        },
        
        applyTemplateFromList: function(template) {
            document.getElementById('appName').value = template.name || '';
            document.getElementById('appCmd').value = template.cmd ? template.cmd.join(' ') : '';
            document.getElementById('appCategory').value = template.category || 'utilities';
            document.getElementById('appIconUrl').value = template.icon_url || '';
            document.getElementById('appWorkingDir').value = template['working-dir'] || '';
            document.getElementById('appImagePath').value = '';
            
            this.showToast(`Applied template: ${template.name}`, 'success');
        },
        
        scanApps: function() {
            const hostId = document.getElementById('app-host-selector').value;
            if (!hostId) {
                this.showToast('Please select a Sunshine host first', 'warning');
                return;
            }
            
            const listContainer = document.getElementById('templateList');
            listContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Scanning...</span>
                    </div>
                    <p class="mt-2 small">Scanning remote host for installed apps...</p>
                    <p class="text-muted small">This may take 30-60 seconds</p>
                </div>`;
            
            fetch(`/api/gaming/hosts/${hostId}/scan-apps`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast(`Found ${data.count} applications!`, 'success');
                    
                    const scannedApps = data.apps || [];
                    this.allTemplates = [...this.allTemplates, ...scannedApps];
                    
                    this.renderTemplates(scannedApps);
                } else {
                    listContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong><i class="bi bi-exclamation-triangle"></i> Scan Failed</strong><br>
                            ${data.error || 'Unknown error'}<br>
                            ${data.help ? `<small class="text-muted">${data.help}</small>` : ''}
                        </div>`;
                    this.showToast('App scan failed: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                listContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> Connection error: ${error.message}
                    </div>`;
                this.showToast('Connection error: ' + error.message, 'danger');
            });
        },
        
        applyTemplate: function(type) {
            const templates = {
                steam: {
                    name: 'Steam Big Picture',
                    cmd: 'steam -bigpicture',
                    workingDir: '',
                    imagePath: '/usr/share/pixmaps/steam.png'
                },
                epic: {
                    name: 'Epic Games Launcher',
                    cmd: 'com.epicgames.Launcher',
                    workingDir: '',
                    imagePath: ''
                },
                desktop: {
                    name: 'Desktop',
                    cmd: '/usr/bin/env DISPLAY=:0 startplasma-x11',
                    workingDir: '',
                    imagePath: ''
                }
            };
            
            const template = templates[type];
            if (template) {
                document.getElementById('appName').value = template.name;
                document.getElementById('appCmd').value = template.cmd;
                document.getElementById('appWorkingDir').value = template.workingDir;
                document.getElementById('appImagePath').value = template.imagePath;
            }
        },
        
        applyQualityPreset: function(preset) {
            if (!hosts || hosts.length === 0) {
                this.showToast('No Sunshine hosts configured. Please add a host first.', 'warning');
                return;
            }
            
            const hostId = hosts[0].id;
            
            const presetNames = {
                ultra: 'Ultra (4K60)',
                high: 'High (1440p60)',
                balanced: 'Balanced (1080p60)',
                performance: 'Performance (1080p30)'
            };
            
            const presetName = presetNames[preset] || preset;
            
            this.showToast(`Applying ${presetName} preset to Sunshine host...`, 'info');
            
            fetch(`/api/gaming/hosts/${hostId}/quality-config`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ preset: preset })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const config = data.applied_config;
                    this.showToast(
                        `â Quality preset applied to Sunshine host!\n\n` +
                        `Resolution: ${config.resolution}\n` +
                        `FPS: ${config.fps}\n` +
                        `Bitrate: ${config.bitrate / 1000} Mbps\n` +
                        `Codec: ${config.codec.toUpperCase()}\n` +
                        `Encoder Preset: ${config.encoder_preset}`,
                        'success'
                    );
                    
                    this.loadCurrentQualityConfig(hostId);
                } else {
                    let errorMsg = 'Failed to apply quality preset: ' + (data.error || 'Unknown error');
                    let errorType = 'danger';
                    
                    if (data.status_code === 401) {
                        errorMsg = 'ð Authentication Failed\n\nCannot authenticate with Sunshine API. Please check your API key in host configuration.';
                    } else if (data.status_code === 503 || data.error?.includes('Cannot connect')) {
                        errorMsg = 'ð¡ Host Unreachable\n\nCannot connect to Sunshine host. Please verify the host is online and Sunshine is running.';
                        errorType = 'warning';
                    } else if (data.status_code === 404) {
                        errorMsg = 'â API Endpoint Not Found\n\nYour Sunshine version may not support quality configuration via API. Please upgrade to the latest version.';
                    }
                    
                    this.showToast(errorMsg, errorType);
                }
            })
            .catch(error => {
                this.showToast(
                    'â ï¸ Connection Error\n\n' +
                    'Failed to communicate with the server: ' + error.message + '\n\n' +
                    'Please check your network connection and try again.',
                    'danger'
                );
            });
        },
        
        loadCurrentQualityConfig: function(hostId) {
            if (!hostId && hosts && hosts.length > 0) {
                hostId = hosts[0].id;
            }
            
            if (!hostId) {
                return;
            }
            
            fetch(`/api/gaming/hosts/${hostId}/quality-config`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('current-quality-config');
                    if (!container) return;
                    
                    if (data.success && data.config) {
                        const config = data.config;
                        container.innerHTML = `
                            <div class="alert alert-info mb-0">
                                <h6 class="mb-2"><i class="bi bi-check-circle"></i> Current Quality Configuration</h6>
                                <div class="row g-2 small">
                                    <div class="col-md-3">
                                        <strong>Resolution:</strong> ${config.resolution}
                                    </div>
                                    <div class="col-md-3">
                                        <strong>FPS:</strong> ${config.fps}
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Bitrate:</strong> ${config.bitrate / 1000} Mbps
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Codec:</strong> ${config.codec.toUpperCase()}
                                    </div>
                                </div>
                                ${data.updated_at ? `<small class="text-muted">Last updated: ${new Date(data.updated_at).toLocaleString()}</small>` : ''}
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-secondary mb-0">
                                <small><i class="bi bi-info-circle"></i> ${data.message || 'No quality configuration set (using Sunshine defaults)'}</small>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Failed to load quality config:', error);
                });
        },
        
        loadDetailedTelemetry: function(hostId) {
            if (!hostId && hosts && hosts.length > 0) {
                hostId = hosts[0].id;
            }
            
            if (!hostId) {
                return;
            }
            
            const container = document.getElementById('session-telemetry-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <small class="ms-2">Fetching telemetry...</small>
                </div>`;
            
            fetch(`/api/gaming/hosts/${hostId}/telemetry?persist=true`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        let errorMsg = 'Failed to load telemetry';
                        if (data.error?.includes('unreachable')) {
                            errorMsg = 'Host unreachable - check if Sunshine is running';
                        } else if (data.error?.includes('Authentication')) {
                            errorMsg = 'Authentication failed - check API key';
                        }
                        
                        container.innerHTML = `
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle"></i> ${errorMsg}
                                <button class="btn btn-sm btn-outline-warning ms-2" onclick="GameStreaming.loadDetailedTelemetry('${hostId}')">
                                    <i class="bi bi-arrow-clockwise"></i> Retry
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    const telemetry = data.telemetry;
                    const sessions = telemetry.active_sessions || [];
                    const gpu = telemetry.gpu_stats || {};
                    const aggregate = telemetry.aggregate_stats || {};
                    
                    if (sessions.length === 0) {
                        container.innerHTML = `
                            <div class="alert alert-secondary mb-0">
                                <i class="bi bi-info-circle"></i> No active streaming sessions
                            </div>
                        `;
                        return;
                    }
                    
                    const sessionsHtml = sessions.map((session, idx) => `
                        <div class="session-telemetry-card mb-3">
                            <h6 class="mb-2">
                                <i class="bi bi-broadcast text-success"></i> 
                                Session ${idx + 1} ${session.client_device ? '- ' + this.escapeHtml(session.client_device) : ''}
                            </h6>
                            
                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <div class="metric-box">
                                        <div class="metric-label">Stream Quality</div>
                                        <div class="metric-value">${session.resolution || 'N/A'} @ ${session.fps || 'N/A'} FPS</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-box">
                                        <div class="metric-label">Encoder</div>
                                        <div class="metric-value">
                                            <span class="badge bg-${session.encoder?.includes('NVENC') ? 'success' : 'secondary'}">
                                                ${session.encoder || 'Unknown'}
                                            </span>
                                            ${session.codec ? `<small>(${session.codec.toUpperCase()})</small>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-box">
                                        <div class="metric-label">Bitrate</div>
                                        <div class="metric-value">${session.bitrate_kbps ? (session.bitrate_kbps / 1000).toFixed(1) + ' Mbps' : 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-2 mb-2">
                                <div class="col-md-3">
                                    <div class="metric-box ${session.latency_ms > 50 ? 'bg-warning-subtle' : ''}">
                                        <div class="metric-label">Latency</div>
                                        <div class="metric-value">${session.latency_ms ? session.latency_ms.toFixed(1) + ' ms' : 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-box ${(session.dropped_frames_pct || 0) > 5 ? 'bg-danger-subtle' : ''}">
                                        <div class="metric-label">Dropped Frames</div>
                                        <div class="metric-value">
                                            ${session.dropped_frames !== null ? session.dropped_frames : 'N/A'}
                                            ${session.dropped_frames_pct !== null ? `(${session.dropped_frames_pct.toFixed(1)}%)` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-box">
                                        <div class="metric-label">Packet Loss</div>
                                        <div class="metric-value">${session.packet_loss_pct !== null ? session.packet_loss_pct.toFixed(2) + '%' : 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-box">
                                        <div class="metric-label">Client IP</div>
                                        <div class="metric-value"><small>${session.client_ip || 'N/A'}</small></div>
                                    </div>
                                </div>
                            </div>
                            
                            ${session.duration_seconds ? `<small class="text-muted">Duration: ${Math.floor(session.duration_seconds / 60)} min ${session.duration_seconds % 60} sec</small>` : ''}
                        </div>
                    `).join('');
                    
                    const gpuHtml = gpu.temperature !== null || gpu.utilization !== null ? `
                        <div class="alert alert-dark mb-3">
                            <h6 class="mb-2"><i class="bi bi-gpu-card"></i> GPU Hardware Stats (During Session)</h6>
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <div class="metric-box ${gpu.temperature > 80 ? 'bg-danger-subtle' : ''}">
                                        <div class="metric-label">GPU Temp</div>
                                        <div class="metric-value">${gpu.temperature !== null ? gpu.temperature + 'Â°C' : 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-box">
                                        <div class="metric-label">GPU Usage</div>
                                        <div class="metric-value">${gpu.utilization !== null ? gpu.utilization + '%' : 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-box">
                                        <div class="metric-label">Encoder Usage</div>
                                        <div class="metric-value">${gpu.encoder_utilization !== null ? gpu.encoder_utilization + '%' : 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-box">
                                        <div class="metric-label">VRAM</div>
                                        <div class="metric-value">
                                            ${gpu.vram_used !== null && gpu.vram_total !== null 
                                                ? `${gpu.vram_used} / ${gpu.vram_total} MB` 
                                                : 'N/A'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : '';
                    
                    container.innerHTML = sessionsHtml + gpuHtml;
                })
                .catch(error => {
                    container.innerHTML = `
                        <div class="alert alert-danger mb-0">
                            <i class="bi bi-exclamation-triangle"></i> Connection error: ${error.message}
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="GameStreaming.loadDetailedTelemetry('${hostId}')">
                                <i class="bi bi-arrow-clockwise"></i> Retry
                            </button>
                        </div>
                    `;
                });
        },
        
        showToast: function(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        },
        
        escapeHtml: function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}
