{% extends 'base.html' %}

{% block title %}DNS Management - Nebula Command{% endblock %}

{% block extra_css %}
<style>
.domain-tree {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.9rem;
}
.tree-domain {
    padding: 12px 16px;
    margin-bottom: 8px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.tree-domain:hover {
    border-color: rgba(99, 102, 241, 0.6);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%);
}
.tree-domain.expanded {
    border-color: rgba(99, 102, 241, 0.6);
}
.tree-domain-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.tree-domain-name {
    font-weight: 600;
    color: var(--text-primary);
}
.tree-domain-stats {
    display: flex;
    gap: 12px;
}
.tree-stat {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.8rem;
    color: var(--text-secondary);
}
.tree-stat-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}
.tree-records {
    display: none;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}
.tree-domain.expanded .tree-records {
    display: block;
}
.tree-subdomain {
    padding: 8px 12px;
    margin: 4px 0;
    margin-left: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-left: 3px solid rgba(99, 102, 241, 0.5);
    border-radius: 0 6px 6px 0;
}
.tree-subdomain-name {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
}
.tree-record-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}
.tree-record-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    background: rgba(99, 102, 241, 0.2);
    border-radius: 12px;
    font-size: 0.75rem;
}
.tree-record-chip.type-A { background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); }
.tree-record-chip.type-AAAA { background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); }
.tree-record-chip.type-CNAME { background: rgba(168, 85, 247, 0.2); border: 1px solid rgba(168, 85, 247, 0.4); }
.tree-record-chip.type-TXT { background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); }
.tree-record-chip.type-MX { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); }
.tree-record-chip.type-NS { background: rgba(99, 102, 241, 0.2); border: 1px solid rgba(99, 102, 241, 0.4); }
.tree-expand-icon {
    transition: transform 0.3s ease;
}
.tree-domain.expanded .tree-expand-icon {
    transform: rotate(90deg);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-globe me-2"></i>DNS Management
            <small class="text-muted">Cloudflare Integration</small>
        </h1>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="refreshData()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
            <button class="btn btn-primary" onclick="showAddRecordModal()">
                <i class="fas fa-plus me-2"></i>Add Record
            </button>
        </div>
    </div>

    <div id="configAlert" class="alert alert-warning d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Cloudflare API not configured.</strong> 
        Set the <code>CLOUDFLARE_API_TOKEN</code> environment variable to enable DNS management.
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card nebula-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat me-2"></i>Domain Health Status
                    </h5>
                    <span id="healthTimestamp" class="text-muted small"></span>
                </div>
                <div class="card-body">
                    <div id="healthStatus" class="row">
                        <div class="col-12 text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card nebula-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>DNS Zones
                    </h5>
                </div>
                <div class="card-body">
                    <div id="zonesList">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card nebula-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>DNS Records
                        <span id="selectedZoneName" class="badge bg-primary ms-2 d-none"></span>
                    </h5>
                    <div>
                        <select id="recordTypeFilter" class="form-select form-select-sm d-inline-block w-auto me-2" onchange="filterRecords()">
                            <option value="">All Types</option>
                            <option value="A">A</option>
                            <option value="AAAA">AAAA</option>
                            <option value="CNAME">CNAME</option>
                            <option value="TXT">TXT</option>
                            <option value="MX">MX</option>
                            <option value="NS">NS</option>
                            <option value="SRV">SRV</option>
                        </select>
                        <input type="text" id="recordSearch" class="form-control form-control-sm d-inline-block w-auto" placeholder="Search..." onkeyup="filterRecords()">
                    </div>
                </div>
                <div class="card-body">
                    <div id="recordsList">
                        <p class="text-muted text-center">Select a zone to view records</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card nebula-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-sitemap me-2"></i>Domain Tree View
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshDomainTree()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="domainTree" class="domain-tree">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span class="ms-2">Building domain tree...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card nebula-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-sync me-2"></i>Sync from Services Catalog
                    </h5>
                    <button class="btn btn-sm btn-warning" onclick="syncFromCatalog()" id="syncBtn">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Sync DNS Records
                    </button>
                </div>
                <div class="card-body">
                    <div id="syncResults" class="d-none">
                        <div class="alert" id="syncAlert"></div>
                        <div id="syncDetails"></div>
                    </div>
                    <p class="text-muted mb-0" id="syncHint">
                        <i class="fas fa-info-circle me-2"></i>
                        Click "Sync DNS Records" to automatically create/update DNS records from your services.yaml configuration.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recordModalTitle">Add DNS Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recordForm">
                    <input type="hidden" id="recordId">
                    <input type="hidden" id="recordZoneId">
                    
                    <div class="mb-3">
                        <label class="form-label">Zone</label>
                        <select id="recordZoneSelect" class="form-select" required>
                            <option value="">Select a zone...</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select id="recordType" class="form-select" required onchange="updateRecordForm()">
                            <option value="A">A (IPv4 Address)</option>
                            <option value="AAAA">AAAA (IPv6 Address)</option>
                            <option value="CNAME">CNAME (Alias)</option>
                            <option value="TXT">TXT (Text)</option>
                            <option value="MX">MX (Mail Exchange)</option>
                            <option value="NS">NS (Name Server)</option>
                            <option value="SRV">SRV (Service)</option>
                            <option value="CAA">CAA (Certificate Authority)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" id="recordName" class="form-control" placeholder="subdomain or @ for root" required>
                        <small class="text-muted">Use @ for root domain, or enter subdomain (e.g., www, api)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <input type="text" id="recordContent" class="form-control" placeholder="e.g., 192.168.1.1" required>
                    </div>
                    
                    <div class="mb-3" id="priorityGroup" style="display: none;">
                        <label class="form-label">Priority</label>
                        <input type="number" id="recordPriority" class="form-control" min="0" max="65535" value="10">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">TTL</label>
                        <select id="recordTTL" class="form-select">
                            <option value="1">Auto</option>
                            <option value="60">1 minute</option>
                            <option value="120">2 minutes</option>
                            <option value="300">5 minutes</option>
                            <option value="600">10 minutes</option>
                            <option value="1800">30 minutes</option>
                            <option value="3600">1 hour</option>
                            <option value="7200">2 hours</option>
                            <option value="18000">5 hours</option>
                            <option value="43200">12 hours</option>
                            <option value="86400">1 day</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="proxiedGroup">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="recordProxied" checked>
                            <label class="form-check-label" for="recordProxied">
                                <i class="fas fa-cloud text-warning me-1"></i>Proxied through Cloudflare
                            </label>
                        </div>
                        <small class="text-muted">Enable to use Cloudflare's CDN and DDoS protection</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRecord()">
                    <i class="fas fa-save me-2"></i>Save Record
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete DNS Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this DNS record?</p>
                <div class="alert alert-warning">
                    <strong id="deleteRecordName"></strong> (<span id="deleteRecordType"></span>)
                    <br>
                    <span id="deleteRecordContent" class="text-muted"></span>
                </div>
                <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let zones = [];
let currentRecords = [];
let selectedZone = null;
let deleteTarget = null;

async function loadHealthStatus() {
    try {
        const response = await fetch('/api/dns/status');
        const data = await response.json();
        
        if (!data.success) {
            if (response.status === 503) {
                document.getElementById('configAlert').classList.remove('d-none');
            }
            document.getElementById('healthStatus').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>${data.message || 'Failed to load health status'}
                    </div>
                </div>
            `;
            return;
        }
        
        const domains = data.data.domains || [];
        let html = '';
        
        domains.forEach(domain => {
            const statusClass = domain.healthy ? 'success' : (domain.status === 'warning' ? 'warning' : 'danger');
            const icon = domain.healthy ? 'check-circle' : 'exclamation-triangle';
            
            html += `
                <div class="col-md-4 mb-3 mb-md-0">
                    <div class="card h-100 border-${statusClass}">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="mb-1">${domain.domain}</h6>
                                    <span class="badge bg-${statusClass}">
                                        <i class="fas fa-${icon} me-1"></i>${domain.status}
                                    </span>
                                </div>
                                <div class="text-end">
                                    <div class="h4 mb-0">${domain.records_count || 0}</div>
                                    <small class="text-muted">records</small>
                                </div>
                            </div>
                            ${domain.issues && domain.issues.length > 0 ? `
                                <div class="mt-2">
                                    ${domain.issues.map(issue => `<small class="text-warning d-block"><i class="fas fa-exclamation me-1"></i>${issue}</small>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('healthStatus').innerHTML = html || '<div class="col-12 text-muted">No domains found</div>';
        document.getElementById('healthTimestamp').textContent = `Updated: ${new Date(data.data.checked_at).toLocaleString()}`;
        
    } catch (error) {
        console.error('Error loading health status:', error);
        document.getElementById('healthStatus').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i>Failed to connect to API
                </div>
            </div>
        `;
    }
}

async function loadZones() {
    try {
        const response = await fetch('/api/dns/zones');
        const data = await response.json();
        
        if (!data.success) {
            document.getElementById('zonesList').innerHTML = `
                <div class="alert alert-warning mb-0">${data.message}</div>
            `;
            return;
        }
        
        zones = data.data.zones || [];
        
        const zoneSelect = document.getElementById('recordZoneSelect');
        zoneSelect.innerHTML = '<option value="">Select a zone...</option>';
        
        let html = '<div class="list-group list-group-flush">';
        
        zones.forEach(zone => {
            html += `
                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center zone-item" 
                   data-zone-id="${zone.id}" onclick="selectZone('${zone.id}', '${zone.name}')">
                    <div>
                        <i class="fas fa-globe me-2 text-primary"></i>
                        <strong>${zone.name}</strong>
                        <br>
                        <small class="text-muted">
                            <span class="badge bg-${zone.status === 'active' ? 'success' : 'warning'}">${zone.status}</span>
                            ${zone.paused ? '<span class="badge bg-danger ms-1">Paused</span>' : ''}
                        </small>
                    </div>
                    <i class="fas fa-chevron-right text-muted"></i>
                </a>
            `;
            
            zoneSelect.innerHTML += `<option value="${zone.id}">${zone.name}</option>`;
        });
        
        html += '</div>';
        document.getElementById('zonesList').innerHTML = html;
        
    } catch (error) {
        console.error('Error loading zones:', error);
        document.getElementById('zonesList').innerHTML = `
            <div class="alert alert-danger mb-0">Failed to load zones: ${error.message}</div>
        `;
    }
}

async function selectZone(zoneId, zoneName) {
    document.querySelectorAll('.zone-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`[data-zone-id="${zoneId}"]`)?.classList.add('active');
    
    selectedZone = { id: zoneId, name: zoneName };
    
    document.getElementById('selectedZoneName').textContent = zoneName;
    document.getElementById('selectedZoneName').classList.remove('d-none');
    
    await loadRecords(zoneId);
}

async function loadRecords(zoneId) {
    document.getElementById('recordsList').innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span class="ms-2">Loading records...</span>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/dns/zones/${zoneId}/records?all=true`);
        const data = await response.json();
        
        if (!data.success) {
            document.getElementById('recordsList').innerHTML = `
                <div class="alert alert-warning mb-0">${data.message}</div>
            `;
            return;
        }
        
        currentRecords = data.data.records || [];
        renderRecords();
        
    } catch (error) {
        console.error('Error loading records:', error);
        document.getElementById('recordsList').innerHTML = `
            <div class="alert alert-danger mb-0">Failed to load records: ${error.message}</div>
        `;
    }
}

function renderRecords() {
    const searchTerm = document.getElementById('recordSearch').value.toLowerCase();
    const typeFilter = document.getElementById('recordTypeFilter').value;
    
    let filtered = currentRecords.filter(record => {
        const matchesSearch = !searchTerm || 
            record.name.toLowerCase().includes(searchTerm) || 
            record.content.toLowerCase().includes(searchTerm);
        const matchesType = !typeFilter || record.type === typeFilter;
        return matchesSearch && matchesType;
    });
    
    if (filtered.length === 0) {
        document.getElementById('recordsList').innerHTML = `
            <p class="text-muted text-center mb-0">No records found</p>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover mb-0">';
    html += `
        <thead>
            <tr>
                <th>Type</th>
                <th>Name</th>
                <th>Content</th>
                <th>TTL</th>
                <th>Proxy</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    filtered.forEach(record => {
        const ttlDisplay = record.ttl === 1 ? 'Auto' : formatTTL(record.ttl);
        const proxyIcon = record.proxied ? 
            '<i class="fas fa-cloud text-warning" title="Proxied"></i>' : 
            '<i class="fas fa-cloud text-muted" title="DNS Only"></i>';
        
        html += `
            <tr>
                <td><span class="badge bg-secondary">${record.type}</span></td>
                <td><code>${record.name}</code></td>
                <td class="text-truncate" style="max-width: 200px;" title="${record.content}">${record.content}</td>
                <td>${ttlDisplay}</td>
                <td>${proxyIcon}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick='editRecord(${JSON.stringify(record)})'>
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick='showDeleteModal(${JSON.stringify(record)})'>
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    document.getElementById('recordsList').innerHTML = html;
}

function filterRecords() {
    renderRecords();
}

function formatTTL(seconds) {
    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
    return `${Math.floor(seconds / 86400)}d`;
}

function showAddRecordModal() {
    document.getElementById('recordModalTitle').textContent = 'Add DNS Record';
    document.getElementById('recordForm').reset();
    document.getElementById('recordId').value = '';
    document.getElementById('recordZoneId').value = '';
    
    if (selectedZone) {
        document.getElementById('recordZoneSelect').value = selectedZone.id;
    }
    
    updateRecordForm();
    new bootstrap.Modal(document.getElementById('recordModal')).show();
}

function editRecord(record) {
    document.getElementById('recordModalTitle').textContent = 'Edit DNS Record';
    document.getElementById('recordId').value = record.id;
    document.getElementById('recordZoneId').value = record.zone_id;
    document.getElementById('recordZoneSelect').value = record.zone_id;
    document.getElementById('recordType').value = record.type;
    document.getElementById('recordName').value = record.name;
    document.getElementById('recordContent').value = record.content;
    document.getElementById('recordTTL').value = record.ttl;
    document.getElementById('recordProxied').checked = record.proxied;
    
    if (record.priority !== null && record.priority !== undefined) {
        document.getElementById('recordPriority').value = record.priority;
    }
    
    updateRecordForm();
    new bootstrap.Modal(document.getElementById('recordModal')).show();
}

function updateRecordForm() {
    const type = document.getElementById('recordType').value;
    const priorityGroup = document.getElementById('priorityGroup');
    const proxiedGroup = document.getElementById('proxiedGroup');
    
    priorityGroup.style.display = type === 'MX' ? 'block' : 'none';
    proxiedGroup.style.display = ['A', 'AAAA', 'CNAME'].includes(type) ? 'block' : 'none';
}

async function saveRecord() {
    const recordId = document.getElementById('recordId').value;
    const zoneId = document.getElementById('recordZoneSelect').value;
    
    if (!zoneId) {
        alert('Please select a zone');
        return;
    }
    
    const data = {
        zone_id: zoneId,
        type: document.getElementById('recordType').value,
        name: document.getElementById('recordName').value,
        content: document.getElementById('recordContent').value,
        ttl: parseInt(document.getElementById('recordTTL').value),
        proxied: document.getElementById('recordProxied').checked
    };
    
    if (data.type === 'MX') {
        data.priority = parseInt(document.getElementById('recordPriority').value) || 10;
    }
    
    try {
        const url = recordId ? `/api/dns/records/${recordId}` : '/api/dns/records';
        const method = recordId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('recordModal')).hide();
            if (selectedZone) {
                await loadRecords(selectedZone.id);
            }
            loadHealthStatus();
        } else {
            alert('Error: ' + result.message);
        }
        
    } catch (error) {
        alert('Failed to save record: ' + error.message);
    }
}

function showDeleteModal(record) {
    deleteTarget = record;
    document.getElementById('deleteRecordName').textContent = record.name;
    document.getElementById('deleteRecordType').textContent = record.type;
    document.getElementById('deleteRecordContent').textContent = record.content;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

async function confirmDelete() {
    if (!deleteTarget) return;
    
    try {
        const response = await fetch(`/api/dns/records/${deleteTarget.id}?zone_id=${deleteTarget.zone_id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            if (selectedZone) {
                await loadRecords(selectedZone.id);
            }
            loadHealthStatus();
        } else {
            alert('Error: ' + result.message);
        }
        
    } catch (error) {
        alert('Failed to delete record: ' + error.message);
    }
    
    deleteTarget = null;
}

async function syncFromCatalog() {
    const btn = document.getElementById('syncBtn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Syncing...';
    
    try {
        const response = await fetch('/api/dns/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        const alertEl = document.getElementById('syncAlert');
        const resultsDiv = document.getElementById('syncResults');
        const detailsDiv = document.getElementById('syncDetails');
        
        resultsDiv.classList.remove('d-none');
        document.getElementById('syncHint').classList.add('d-none');
        
        if (result.success) {
            alertEl.className = 'alert alert-success';
            alertEl.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>Sync Complete!</strong> 
                ${result.data.synced} synced, ${result.data.failed} failed, ${result.data.skipped} skipped
            `;
            
            if (result.data.results && result.data.results.length > 0) {
                let detailsHtml = '<table class="table table-sm mt-3">';
                detailsHtml += '<thead><tr><th>Record</th><th>Type</th><th>Status</th></tr></thead><tbody>';
                
                result.data.results.forEach(r => {
                    const statusClass = r.status === 'synced' ? 'success' : 'danger';
                    detailsHtml += `
                        <tr>
                            <td><code>${r.name}</code></td>
                            <td>${r.type || '-'}</td>
                            <td><span class="badge bg-${statusClass}">${r.status}</span> ${r.error || ''}</td>
                        </tr>
                    `;
                });
                
                detailsHtml += '</tbody></table>';
                detailsDiv.innerHTML = detailsHtml;
            }
            
            loadHealthStatus();
            if (selectedZone) {
                await loadRecords(selectedZone.id);
            }
            
        } else {
            alertEl.className = 'alert alert-danger';
            alertEl.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${result.message}`;
            detailsDiv.innerHTML = '';
        }
        
    } catch (error) {
        const alertEl = document.getElementById('syncAlert');
        document.getElementById('syncResults').classList.remove('d-none');
        alertEl.className = 'alert alert-danger';
        alertEl.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>Sync failed: ${error.message}`;
    }
    
    btn.disabled = false;
    btn.innerHTML = originalHtml;
}

function refreshData() {
    loadHealthStatus();
    loadZones();
    refreshDomainTree();
    if (selectedZone) {
        loadRecords(selectedZone.id);
    }
}

async function refreshDomainTree() {
    const treeContainer = document.getElementById('domainTree');
    treeContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span class="ms-2">Building domain tree...</span>
        </div>
    `;
    
    try {
        const zonesResponse = await fetch('/api/dns/zones');
        const zonesData = await zonesResponse.json();
        
        if (!zonesData.success) {
            treeContainer.innerHTML = `<div class="alert alert-warning">${zonesData.message}</div>`;
            return;
        }
        
        const domainZones = zonesData.data.zones || [];
        
        if (domainZones.length === 0) {
            treeContainer.innerHTML = '<p class="text-muted text-center">No DNS zones available</p>';
            return;
        }
        
        let treeHtml = '';
        
        for (const zone of domainZones) {
            const recordsResponse = await fetch(`/api/dns/zones/${zone.id}/records?all=true`);
            const recordsData = await recordsResponse.json();
            
            const records = recordsData.success ? (recordsData.data.records || []) : [];
            
            const recordsBySubdomain = {};
            records.forEach(record => {
                const name = record.name;
                const subdomain = name === zone.name ? '@' : name.replace(`.${zone.name}`, '');
                if (!recordsBySubdomain[subdomain]) {
                    recordsBySubdomain[subdomain] = [];
                }
                recordsBySubdomain[subdomain].push(record);
            });
            
            const typeCounts = {};
            records.forEach(r => {
                typeCounts[r.type] = (typeCounts[r.type] || 0) + 1;
            });
            
            const subdomainCount = Object.keys(recordsBySubdomain).length;
            
            treeHtml += `
                <div class="tree-domain" onclick="toggleTreeDomain(this)">
                    <div class="tree-domain-header">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-chevron-right tree-expand-icon"></i>
                            <i class="fas fa-globe text-primary"></i>
                            <span class="tree-domain-name">${zone.name}</span>
                            <span class="badge ${zone.status === 'active' ? 'bg-success' : 'bg-warning'}">${zone.status}</span>
                        </div>
                        <div class="tree-domain-stats">
                            <span class="tree-stat">
                                <i class="fas fa-sitemap"></i>
                                ${subdomainCount} subdomains
                            </span>
                            <span class="tree-stat">
                                <i class="fas fa-list"></i>
                                ${records.length} records
                            </span>
                        </div>
                    </div>
                    <div class="tree-records">
            `;
            
            const sortedSubdomains = Object.keys(recordsBySubdomain).sort((a, b) => {
                if (a === '@') return -1;
                if (b === '@') return 1;
                return a.localeCompare(b);
            });
            
            for (const subdomain of sortedSubdomains) {
                const subRecords = recordsBySubdomain[subdomain];
                const displayName = subdomain === '@' ? `${zone.name} (root)` : `${subdomain}.${zone.name}`;
                
                treeHtml += `
                    <div class="tree-subdomain">
                        <div class="tree-subdomain-name">
                            <i class="fas fa-${subdomain === '@' ? 'home' : 'folder'} me-2 text-muted"></i>
                            ${displayName}
                        </div>
                        <div class="tree-record-list">
                `;
                
                subRecords.forEach(record => {
                    const proxiedIcon = record.proxied ? '<i class="fas fa-cloud text-warning" title="Proxied"></i>' : '';
                    const shortContent = record.content.length > 30 ? record.content.substring(0, 30) + '...' : record.content;
                    
                    treeHtml += `
                        <span class="tree-record-chip type-${record.type}" title="${record.content}">
                            <strong>${record.type}</strong>
                            ${shortContent}
                            ${proxiedIcon}
                        </span>
                    `;
                });
                
                treeHtml += `
                        </div>
                    </div>
                `;
            }
            
            treeHtml += `
                    </div>
                </div>
            `;
        }
        
        treeContainer.innerHTML = treeHtml;
        
    } catch (error) {
        console.error('Error building domain tree:', error);
        treeContainer.innerHTML = `<div class="alert alert-danger">Failed to build domain tree: ${error.message}</div>`;
    }
}

function toggleTreeDomain(element) {
    element.classList.toggle('expanded');
}

document.addEventListener('DOMContentLoaded', function() {
    loadHealthStatus();
    loadZones();
    refreshDomainTree();
});
</script>
{% endblock %}
