name: infrastructure_recover_git_sync
tier: 2
tier_name: REMEDIATE
risk_level: medium
category: infrastructure
description: Recover git sync by restarting systemd timer, clearing locks, and verifying connection
requires_approval: false
auto_execute: true
execution_interval_minutes: 120
timeout_seconds: 90

preconditions:
  - type: git_sync_failure
    description: Execute only when git sync failures detected
  - type: git_repo_exists
    path: /home/evin/contain/HomeLabHub
    description: Verify git repository exists

command: |
  echo "=== Git Sync Recovery Started ===" && \
  cd /home/evin/contain/HomeLabHub && \
  echo "=== Checking git status ===" && \
  git status || true && \
  echo "=== Clearing git locks if they exist ===" && \
  rm -f .git/index.lock .git/HEAD.lock .git/refs/heads/*.lock 2>/dev/null || true && \
  echo "=== Verifying git remote connection ===" && \
  git remote -v && \
  git ls-remote --exit-code origin HEAD && \
  echo "=== Attempting git fetch ===" && \
  git fetch origin --prune && \
  echo "=== Restarting sync timer if exists ===" && \
  systemctl restart homelab-sync.timer 2>/dev/null || echo "Timer not found, skipping" && \
  systemctl status homelab-sync.timer --no-pager 2>/dev/null || echo "Timer status unavailable" && \
  echo "=== Git sync recovery complete ==="

rollback_plan: |
  If git sync recovery fails:
  1. Check git remote connectivity: git ls-remote origin
  2. Verify SSH keys: ssh -T git@github.com
  3. Check for uncommitted changes: git status
  4. Review git logs: git log -n 5
  5. Manual intervention may be required for merge conflicts
  6. Check systemd timer: systemctl status homelab-sync.timer

checkpoint_required: true
checkpoint_command: git ls-remote --exit-code origin HEAD

safety_checks:
  - type: git_repo_validation
    repo_path: /home/evin/contain/HomeLabHub
    description: Verify git repository is valid before operations
  
  - type: lock_file_safety
    description: Only remove standard git lock files, never .git/config or .git/HEAD
    allowed_lock_files:
      - .git/index.lock
      - .git/HEAD.lock
      - .git/refs/heads/*.lock
  
  - type: no_destructive_operations
    description: No git reset --hard or force operations
  
  - type: restart_limit
    max_per_hour: 4
    description: Prevent recovery loops - max 4 attempts per hour

expected_outputs:
  - type: success_message
    pattern: "sync.*complete|fetch.*success|Timer.*active"
  - type: git_connectivity
    description: Git remote should be accessible
  - type: no_lock_files
    description: Lock files should be cleared

alerting:
  on_success: true
  on_failure: true
  metric_name: git_sync_recovery_status
  alert_message: "Git sync recovery executed - verify sync status"
  slack_channel: "#infrastructure-alerts"

metadata:
  tags:
    - remediate
    - git
    - sync
    - tier2
    - infrastructure
  author: jarvis
  version: "1.0"
  last_updated: "2025-11-16"
  autonomous_execution: true
  notes: |
    This action is safe to run autonomously as it:
    - Only clears lock files (non-destructive)
    - Verifies connectivity before operations
    - Does not force push or reset
    - Restarts timer but doesn't modify sync configuration
  related_actions:
    - infrastructure_monitor_git_sync
    - diagnose_services
