name: domain_ssl_renew
description: Automatically renew expiring SSL certificates for domains
category: infrastructure
tier: tier2_remediate
enabled: true
auto_execute: true

conditions:
  - ssl_days_remaining: <7
  - ssl_enabled: true

steps:
  - name: backup_config
    command: backup_caddyfile
    description: Create backup of current Caddy configuration
    timeout: 30

  - name: remove_domain
    command: remove_from_caddyfile
    description: Temporarily remove domain from Caddyfile
    timeout: 60

  - name: reload_caddy_release
    command: reload_caddy
    description: Reload Caddy to release old certificate
    timeout: 60

  - name: wait_for_release
    command: sleep
    description: Wait for certificate release
    timeout: 10
    args:
      seconds: 5

  - name: re_add_domain
    command: add_to_caddyfile
    description: Re-add domain to Caddyfile for new certificate
    timeout: 60

  - name: reload_caddy_obtain
    command: reload_caddy
    description: Reload Caddy to obtain new certificate
    timeout: 60

  - name: wait_for_certificate
    command: sleep
    description: Wait for new certificate acquisition
    timeout: 45
    args:
      seconds: 30

  - name: verify_new_cert
    command: verify_ssl_certificate
    description: Verify new certificate is valid and not expiring soon
    timeout: 60

success_actions:
  - update_ssl_expiry_date
  - create_event: ssl_renewed
  - send_notification: SSL certificate renewed for {domain}

failure_actions:
  - rollback_caddyfile
  - create_alert: ssl_renewal_failed
  - send_alert: SSL renewal failed for {domain}

risk_level: medium
estimated_duration_seconds: 300
max_retries: 3
retry_delay_seconds: 60
