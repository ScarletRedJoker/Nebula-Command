name: infrastructure_remediate_ssl
tier: 2
tier_name: REMEDIATE
risk_level: medium
category: infrastructure
description: Restart Caddy when SSL certificate acquisition fails, check DNS health first
requires_approval: false
auto_execute: true
execution_interval_minutes: 30
timeout_seconds: 120

preconditions:
  - type: ssl_failure_detected
    description: Execute only when SSL certificate failures are detected in Caddy logs
  - type: dns_health_check
    description: Verify DNS records are properly configured before attempting SSL fix

command: |
  echo "=== Checking DNS health before SSL remediation ===" && \
  dig +short rig-city.com && \
  dig +short www.rig-city.com && \
  echo "=== DNS checks passed, proceeding with Caddy restart ===" && \
  docker restart caddy && \
  sleep 10 && \
  docker logs caddy 2>&1 | tail -n 50 | grep -i "certificate" && \
  echo "=== Caddy restarted successfully ==="

rollback_plan: |
  If Caddy fails to restart or SSL still fails:
  1. Check Caddy logs: docker logs caddy --tail 100
  2. Validate Caddyfile: docker exec caddy caddy validate --config /etc/caddy/Caddyfile
  3. Check DNS propagation: dig @8.8.8.8 rig-city.com
  4. Manual intervention required if DNS is not properly configured
  
checkpoint_required: true
checkpoint_command: docker exec caddy caddy validate --config /etc/caddy/Caddyfile

safety_checks:
  - type: dns_validation
    domains:
      - rig-city.com
      - www.rig-city.com
    description: Verify DNS records exist and point to correct IP before SSL fix
  
  - type: caddyfile_validation
    description: Validate Caddyfile syntax before restart
  
  - type: restart_limit
    max_per_hour: 3
    description: Prevent restart loops - max 3 restarts per hour

expected_outputs:
  - type: success_message
    pattern: "certificate.*obtained|certificate.*renewed"
  - type: container_running
    container: caddy
    description: Verify Caddy container is running after restart

alerting:
  on_success: true
  on_failure: true
  metric_name: ssl_remediation_status
  alert_message: "SSL remediation executed - check certificate status"
  slack_channel: "#infrastructure-alerts"

metadata:
  tags:
    - remediate
    - ssl
    - caddy
    - tier2
    - infrastructure
  author: jarvis
  version: "1.0"
  last_updated: "2025-11-16"
  autonomous_execution: true
  related_actions:
    - infrastructure_diagnose_ssl
    - infrastructure_diagnose_dns
